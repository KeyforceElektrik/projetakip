<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proje Takip Sistemi</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Proje Listesi</h1>
            <div>
                <span class="user-info">Hoş geldin, <span id="userEmail"></span>!</span>
                <button id="logoutButton" class="logout-button">Çıkış Yap</button>
            </div>
        </header>

        <div class="message" id="systemMessage"></div>

        <div class="controls-section">
            <button id="addProjectButton" class="button">Yeni Proje Ekle</button>
            <button id="viewReportButton" class="button secondary">Raporları Görüntüle</button>
        </div>

        <h2 class="section-title">Aktif Projeleriniz</h2>

        <div class="financial-table-container">
            <table class="financial-table index-table">
                <thead>
                    <tr>
                        <th>Proje Adı</th>
                        <th>Müşteri</th>
                        <th>Kategoriler</th>
                        <th>Durum</th>
                        <th>Sözleşme Bedeli (TL)</th>
                        <th>İşlemler</th>
                    </tr>
                </thead>
                <tbody id="projectsTableBody">
                    <!-- Projeler buraya yüklenecek -->
                    <tr><td colspan="6" style="text-align:center;">Projeler yükleniyor...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Firebase Konfigürasyonunuzu BURAYA YAPIŞTIRIN
        const firebaseConfig = {
            apiKey: "AIzaSyBNwSpbpNuQQ4nTjDAlB6izu5IgkEZxDL0", // Kendi API Key'iniz
            authDomain: "projetakip-e3a75.firebaseapp.com",
            projectId: "projetakip-e3a75",
            storageBucket: "projetakip-e3a75.firebasestorage.app",
            messagingSenderId: "924120275674",
            appId: "1:924120275674:web:c8ad3d4c998333d9fd23e3"
        };
        firebase.initializeApp(firebaseConfig);

        const auth = firebase.auth();
        const db = firebase.firestore();

        const userEmailSpan = document.getElementById('userEmail');
        const logoutButton = document.getElementById('logoutButton');
        const addProjectButton = document.getElementById('addProjectButton');
        const viewReportButton = document.getElementById('viewReportButton');
        const projectsTableBody = document.getElementById('projectsTableBody');
        const systemMessageDiv = document.getElementById('systemMessage');

        let currentUserId = null;

        // Kullanıcı giriş durumunu izle
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserId = user.uid;
                userEmailSpan.textContent = user.email;
                console.log("Auth State Changed: User Logged In. UID:", currentUserId); // LOG
                loadProjects();
            } else {
                console.log("Auth State Changed: User Logged Out. Redirecting to auth.html"); // LOG
                window.location.href = 'auth.html'; // Giriş yapılmadıysa login sayfasına yönlendir
            }
        });

        // Çıkış yap butonu
        logoutButton.addEventListener('click', async () => {
            try {
                await auth.signOut();
                console.log("User signed out."); // LOG
            } catch (error) {
                showSystemMessage('Çıkış yaparken hata oluştu: ' + error.message, true);
                console.error("Logout Error:", error); // LOG
            }
        });

        // Yeni Proje Ekle butonu (pd.html'e yönlendiriyor)
        addProjectButton.addEventListener('click', () => {
            console.log("Navigating to pd.html for new project."); // LOG
            window.location.href = 'pd.html';
        });

        // Raporları Görüntüle butonu
        viewReportButton.addEventListener('click', () => {
            console.log("Navigating to rapor.html."); // LOG
            window.location.href = 'rapor.html'; // Eğer rapor.html dosyanız varsa
        });

        // Projeleri Firebase'den yükle
        async function loadProjects() {
            projectsTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Projeler yükleniyor...</td></tr>';
            
            if (!currentUserId) {
                console.warn("loadProjects: currentUserId is null. User might not be authenticated yet."); // LOG
                showSystemMessage("Projeleri yüklemek için lütfen giriş yapın.", true);
                return;
            }

            const projectsRef = db.collection('users').doc(currentUserId).collection('projects');
            console.log("Attempting to load projects from path:", projectsRef.path); // LOG

            try {
                const snapshot = await projectsRef.orderBy('createdAt', 'desc').get();

                if (snapshot.empty) {
                    projectsTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Henüz hiç proje eklenmedi.</td></tr>';
                    console.log("No projects found for this user."); // LOG
                    return;
                }

                projectsTableBody.innerHTML = ''; // Eski verileri temizle
                snapshot.forEach(doc => {
                    const project = doc.data();
                    const row = projectsTableBody.insertRow();
                    row.dataset.id = doc.id; // Satıra proje ID'sini ekle

                    const projectNameCell = row.insertCell(0);
                    const customerNameCell = row.insertCell(1);
                    const categoriesCell = row.insertCell(2);
                    const statusCell = row.insertCell(3);
                    const contractAmountCell = row.insertCell(4);
                    const actionsCell = row.insertCell(5);

                    // Proje adına tıklandığında pd.html'e proje ID'si ile yönlendir
                    projectNameCell.innerHTML = `<a href="pd.html?id=${doc.id}">${project.projectName}</a>`;
                    customerNameCell.textContent = project.customerName || 'N/A';
                    categoriesCell.textContent = (project.categories || []).join(', ');
                    statusCell.textContent = project.status || 'Bilinmiyor';
                    
                    // Sözleşme bedeli gösterimi (mevcut haliyle sadece TL)
                    const formattedAmount = (project.contractAmountTL || 0).toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' });
                    contractAmountCell.textContent = formattedAmount;
                    contractAmountCell.style.textAlign = 'right'; // Sağ hizalama

                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Sil';
                    deleteButton.classList.add('delete-btn');
                    deleteButton.addEventListener('click', (e) => {
                        e.stopPropagation(); // Satır tıklamasını engelle
                        if (confirm('Bu projeyi silmek istediğinizden emin misiniz? Harcamalar ve tahsilatlar da silinecektir.')) {
                            deleteProject(doc.id);
                        }
                    });
                    actionsCell.appendChild(deleteButton);
                    actionsCell.style.textAlign = 'center'; // Ortala
                });
                console.log("Projects loaded successfully."); // LOG

            } catch (error) {
                console.error("Projeleri yüklerken hata oluştu: ", error); // LOG
                showSystemMessage('Projeleri yüklerken hata oluştu: ' + error.message, true);
            }
        }

        // Proje silme fonksiyonu
        async function deleteProject(projectId) {
            console.log("Attempting to delete project:", projectId); // LOG
            try {
                const projectRef = db.collection('users').doc(currentUserId).collection('projects').doc(projectId);
                
                // Harcamaları sil
                const expensesSnapshot = await projectRef.collection('expenses').get();
                const batch = db.batch(); // Toplu silme için batch kullan
                expensesSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });

                // Tahsilatları sil
                const collectionsSnapshot = await projectRef.collection('collections').get();
                collectionsSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });

                await batch.commit(); // Toplu silme işlemlerini onayla

                // Ana projeyi sil
                await projectRef.delete();
                showSystemMessage('Proje başarıyla silindi.');
                console.log("Project", projectId, "deleted successfully."); // LOG
                loadProjects(); // Listeyi yenile
            } catch (error) {
                console.error("Proje silinirken hata oluştu: ", error); // LOG
                showSystemMessage('Proje silinirken hata oluştu: ' + error.message, true);
            }
        }

        // Sistem mesajı gösterme fonksiyonu
        function showSystemMessage(message, isError = false) {
            systemMessageDiv.textContent = message;
            systemMessageDiv.className = 'message'; // Tüm sınıfları sıfırla
            if (isError) {
                systemMessageDiv.classList.add('error-message');
            } else {
                systemMessageDiv.classList.add('success');
            }
            systemMessageDiv.classList.add('show');
            // 5 saniye sonra mesajı gizle
            setTimeout(() => {
                systemMessageDiv.classList.remove('show');
            }, 5000);
        }
    </script>
</body>
</html>
