<!DOCTYPE html>
<html lang="tr">
<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Y√∂netim Paneli - KeyForce</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Yeni Y√∂netim Paneli Stilleri */
        body { display: flex; height: 100vh; overflow: hidden; background-color: #f4f6f9; }
        
        /* Sol Sidebar */
        .sidebar {
            width: 250px;
            background-color: #343a40;
            color: #fff;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: all 0.3s;
        }
        .sidebar-header { padding: 20px; font-size: 1.2em; font-weight: 700; border-bottom: 1px solid #4b545c; display: flex; align-items: center; gap: 10px; }
        .sidebar-menu { list-style: none; padding: 0; margin: 20px 0; flex-grow: 1; }
        .sidebar-menu li { margin-bottom: 5px; }
        .sidebar-menu a {
            display: block; padding: 12px 20px; color: #c2c7d0; text-decoration: none;
            transition: all 0.2s; border-left: 4px solid transparent; cursor: pointer;
        }
        .sidebar-menu a:hover, .sidebar-menu a.active { background-color: #495057; color: #fff; border-left-color: #007bff; }
        .user-panel { padding: 15px; border-top: 1px solid #4b545c; font-size: 0.9em; color: #adb5bd; }
        .logout-link { color: #dc3545; cursor: pointer; text-decoration: none; margin-left: 10px; font-weight: 600; }

        /* Ana ƒ∞√ßerik Alanƒ± */
        .main-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: 30px;
            display: flex;
            flex-direction: column;
        }

        /* Sekme ƒ∞√ßerikleri (Views) */
        .view-section { display: none; animation: fadeIn 0.3s ease; }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* C√ºzdan Kartlarƒ± */
        .wallet-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; margin-top: 20px; }
        .wallet-card {
            background: #fff; border-radius: 12px; padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05); border: 1px solid #e0e0e0;
            display: flex; justify-content: space-between; align-items: center;
        }
        .wallet-info h4 { margin: 0 0 5px 0; color: #333; font-size: 1.1em; }
        .wallet-info p { margin: 0; font-size: 0.9em; color: #666; }
        .wallet-balance { font-size: 1.4em; font-weight: 700; color: #28a745; }
        .wallet-type { font-size: 0.75em; padding: 3px 8px; border-radius: 10px; background: #eee; color: #555; }

        /* Mobil Uyum */
        @media (max-width: 768px) {
            .sidebar { width: 60px; }
            .sidebar-header span, .sidebar-menu a span, .user-panel span { display: none; }
            .sidebar-menu a { text-align: center; padding: 15px 0; }
            .sidebar-header { justify-content: center; padding: 15px; }
        }
    </style>
</head>
<body>

    <nav class="sidebar">
        <div class="sidebar-header">
            <div style="width:24px; height:24px; background:#007bff; border-radius:4px;"></div>
            <span>KeyForce Panel</span>
        </div>
        <ul class="sidebar-menu">
            <li><a onclick="switchView('projects-view')" class="active">üìÇ <span>Projeler</span></a></li>
            <li><a onclick="switchView('wallets-view')">üíº <span>C√ºzdanƒ±m (Kasa/Banka)</span></a></li>
            <li><a onclick="switchView('personal-view')">üè† <span>Ev & ≈ûahsi Giderler</span></a></li>
        </ul>
        <div class="user-panel">
            <span id="userEmail">Kullanƒ±cƒ±</span>
            <a id="logoutButton" class="logout-link">√áƒ±kƒ±≈ü</a>
        </div>
    </nav>

    <main class="main-content">
        <div id="systemMessage" class="message"></div>

        <section id="projects-view" class="view-section active">
            <header style="border:none; margin-bottom:10px;">
                <h1 style="font-size: 1.8em;">Projeler</h1>
            </header>

            <div class="controls-section">
                <div class="form-group">
                    <select id="filterStatus" onchange="loadProjects()">
                        <option value="">T√ºm Durumlar</option>
                        <option value="Ba≈ülamadƒ±">Ba≈ülamadƒ±</option>
                        <option value="Devam Ediyor">Devam Ediyor</option>
                        <option value="Tamamlandƒ±">Tamamlandƒ±</option>
                    </select>
                </div>
                <button class="button primary" onclick="document.getElementById('addProjectModal').style.display='block'">+ Yeni Proje</button>
                <button class="button secondary" onclick="window.location.href='rapor.html'">Raporlara Git</button>
            </div>

            <div id="addProjectModal" style="display:none; background:#f8f9fa; padding:20px; border-radius:8px; margin-bottom:20px; border:1px solid #ddd;">
                <h3 class="section-subtitle" style="margin-top:0;">Yeni Proje Olu≈ütur</h3>
                <form id="addProjectForm" class="form-grid">
                    <div class="form-group">
                        <label>Proje Adƒ±:</label>
                        <input type="text" id="projectName" placeholder="Proje Adƒ±" required>
                    </div>
                    <div class="form-group">
                        <label>M√º≈üteri:</label>
                        <input type="text" id="customerName" placeholder="M√º≈üteri" required>
                    </div>
                    <div class="form-group full-width">
                        <label>Kategoriler:</label>
                        <div class="checkbox-group">
                            <label><input type="checkbox" name="projectCategory" value="Aydƒ±nlatma"> Aydƒ±nlatma</label>
                            <label><input type="checkbox" name="projectCategory" value="Otomasyon"> Otomasyon</label>
                            <label><input type="checkbox" name="projectCategory" value="Taahh√ºt"> Taahh√ºt</label>
                            <label><input type="checkbox" name="projectCategory" value="Diƒüer"> Diƒüer</label>
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <button type="submit" class="button primary">Kaydet</button>
                        <button type="button" class="button secondary" onclick="document.getElementById('addProjectModal').style.display='none'">ƒ∞ptal</button>
                    </div>
                </form>
            </div>

            <div class="project-table-container financial-table-container">
                <table class="project-table financial-table index-table">
                    <thead>
                        <tr>
                            <th>Proje Adƒ±</th>
                            <th>M√º≈üteri</th>
                            <th>Kategoriler</th>
                            <th>Durum</th>
                            <th>S√∂zle≈üme</th>
                            <th>ƒ∞≈ülemler</th>
                        </tr>
                    </thead>
                    <tbody id="projectListBody">
                        <tr><td colspan="6" style="text-align:center;">Y√ºkleniyor...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

        <section id="wallets-view" class="view-section">
            <header style="border:none; margin-bottom:10px;">
                <h1 style="font-size: 1.8em;">Kasa ve Bankalar</h1>
            </header>
            
            <div style="background:#fff; padding:20px; border-radius:8px; margin-bottom:20px; border:1px solid #ddd;">
                <h3 class="section-subtitle" style="margin-top:0;">Yeni Hesap Tanƒ±mla</h3>
                <form id="addWalletForm" class="form-grid">
                    <div class="form-group">
                        <label>Hesap Adƒ± (√ñrn: ƒ∞≈ü Bankasƒ±, Ev Kasasƒ±):</label>
                        <input type="text" id="walletName" required>
                    </div>
                    <div class="form-group">
                        <label>Hesap T√ºr√º:</label>
                        <select id="walletType" required>
                            <option value="Banka">Banka Hesabƒ±</option>
                            <option value="Kasa">Nakit Kasa</option>
                            <option value="Kredi Kartƒ±">Kredi Kartƒ±</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Para Birimi:</label>
                        <select id="walletCurrency" required>
                            <option value="TRY">TL</option>
                            <option value="USD">USD</option>
                            <option value="EUR">EUR</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>A√ßƒ±lƒ±≈ü Bakiyesi:</label>
                        <input type="number" id="walletBalance" step="0.01" value="0" required>
                    </div>
                    <div class="form-group full-width">
                        <button type="submit" class="button primary">Hesabƒ± Ekle</button>
                    </div>
                </form>
            </div>

            <h3 class="section-subtitle">Hesaplarƒ±m</h3>
            <div id="walletList" class="wallet-grid">
                <div style="grid-column:1/-1; text-align:center; color:#666;">Hesaplar y√ºkleniyor...</div>
            </div>
        </section>

        <section id="personal-view" class="view-section">
            <header style="border:none; margin-bottom:10px;">
                <h1 style="font-size: 1.8em;">Ev & ≈ûahsi Giderler</h1>
            </header>

            <div style="background:#fff; padding:20px; border-radius:8px; margin-bottom:20px; border:1px solid #ddd;">
                <form id="addPersonalExpenseForm" class="form-grid">
                    <div class="form-group">
                        <label>A√ßƒ±klama:</label>
                        <input type="text" id="peDesc" placeholder="√ñrn: Market, Kira, Benzin" required>
                    </div>
                    <div class="form-group">
                        <label>Kategori:</label>
                        <select id="peCategory" required>
                            <option value="Ev">Ev (Mutfak, Kira, Fatura)</option>
                            <option value="≈ûahsi">≈ûahsi (Giyim, Hobi, Cep Har√ßlƒ±ƒüƒ±)</option>
                            <option value="Eƒüitim">Eƒüitim / Okul</option>
                            <option value="Saƒülƒ±k">Saƒülƒ±k</option>
                            <option value="Diƒüer">Diƒüer</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Tutar (TL):</label>
                        <input type="number" id="peAmount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Tarih:</label>
                        <input type="date" id="peDate" required>
                    </div>
                    <div class="form-group full-width">
                        <button type="submit" class="button primary">Harcamayƒ± Kaydet</button>
                    </div>
                </form>
            </div>

            <h3 class="section-subtitle">Son Harcamalar</h3>
            <div class="financial-table-container">
                <table class="financial-table">
                    <thead>
                        <tr>
                            <th>Tarih</th>
                            <th>Kategori</th>
                            <th>A√ßƒ±klama</th>
                            <th>Tutar</th>
                            <th>ƒ∞≈ülem</th>
                        </tr>
                    </thead>
                    <tbody id="personalExpenseBody">
                        <tr><td colspan="5" style="text-align:center;">Kayƒ±tlar y√ºkleniyor...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>

    </main>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBNwSpbpNuQQ4nTjDAlB6izu5IgkEZxDL0",
            authDomain: "projetakip-e3a75.firebaseapp.com",
            projectId: "projetakip-e3a75",
            storageBucket: "projetakip-e3a75.firebasestorage.app",
            messagingSenderId: "924120275674",
            appId: "1:924120275674:web:c8ad3d4c998333d9fd23e3"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUserId = null;

        // --- ELEMENTS ---
        const userEmailSpan = document.getElementById('userEmail');
        const logoutButton = document.getElementById('logoutButton');
        const systemMessageDiv = document.getElementById('systemMessage');
        const projectListBody = document.getElementById('projectListBody');
        const addProjectForm = document.getElementById('addProjectForm');
        
        // C√ºzdan Elements
        const addWalletForm = document.getElementById('addWalletForm');
        const walletList = document.getElementById('walletList');

        // Personal Expense Elements
        const addPersonalExpenseForm = document.getElementById('addPersonalExpenseForm');
        const personalExpenseBody = document.getElementById('personalExpenseBody');

        // --- AUTH ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserId = user.uid;
                userEmailSpan.textContent = user.email;
                showSystemMessage('Ho≈ü geldiniz!', false);
                loadProjects();
                loadWallets(); // C√ºzdanlarƒ± y√ºkle
                loadPersonalExpenses(); // ≈ûahsi giderleri y√ºkle
                
                // Tarihleri bug√ºne ayarla
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('peDate').value = today;
            } else {
                window.location.href = 'auth.html';
            }
        });

        logoutButton.addEventListener('click', async () => {
            try { await auth.signOut(); } catch (e) { console.error(e); }
        });

        // --- NAVIGATION ---
        window.switchView = function(viewId) {
            // Men√º aktiflik durumu
            document.querySelectorAll('.sidebar-menu a').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');

            // ƒ∞√ßerik deƒüi≈ütirme
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(viewId).classList.add('active');
        }

        function showSystemMessage(msg, isError = false) {
            systemMessageDiv.textContent = msg;
            systemMessageDiv.className = 'message ' + (isError ? 'error-message' : 'success');
            systemMessageDiv.classList.add('show');
            setTimeout(() => systemMessageDiv.classList.remove('show'), 4000);
        }

        // --- PROJE ƒ∞≈ûLEMLERƒ∞ (MEVCUT) ---
        addProjectForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('projectName').value;
            const customer = document.getElementById('customerName').value;
            const cats = Array.from(document.querySelectorAll('input[name="projectCategory"]:checked')).map(cb => cb.value);

            if (!name || !customer || cats.length === 0) return showSystemMessage('Eksik bilgi.', true);

            try {
                await db.collection('projects').add({
                    projectName: name,
                    customerName: customer,
                    categories: cats,
                    status: 'Ba≈ülamadƒ±',
                    contractAmount: 0,
                    contractCurrency: 'TRY',
                    contractExchangeRate: 1,
                    ownerId: currentUserId,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showSystemMessage('Proje eklendi!');
                addProjectForm.reset();
                document.getElementById('addProjectModal').style.display='none';
                loadProjects();
            } catch (err) { showSystemMessage('Hata: ' + err.message, true); }
        });

        async function loadProjects() {
            if(!currentUserId) return;
            const statusFilter = document.getElementById('filterStatus').value;
            let query = db.collection('projects').where('ownerId', '==', currentUserId).orderBy('createdAt', 'desc');
            
            try {
                const snap = await query.get();
                projectListBody.innerHTML = '';
                if(snap.empty) { projectListBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Kayƒ±t yok.</td></tr>'; return; }

                snap.forEach(doc => {
                    const d = doc.data();
                    if(statusFilter && d.status !== statusFilter) return;

                    const row = projectListBody.insertRow();
                    row.insertCell(0).textContent = d.projectName;
                    row.insertCell(1).textContent = d.customerName;
                    row.insertCell(2).textContent = (d.categories || []).join(', ');
                    
                    const sCell = row.insertCell(3);
                    const sSpan = document.createElement('span');
                    sSpan.className = 'status-badge status-' + (d.status || '').toLowerCase().replace(/ /g,'');
                    sSpan.textContent = d.status;
                    sCell.appendChild(sSpan);

                    // S√∂zle≈üme
                    let amount = d.contractAmount || 0;
                    let curr = d.contractCurrency || 'TRY';
                    let amountTL = amount;
                    if(curr !== 'TRY') amountTL = amount * (d.contractExchangeRate || 1);
                    
                    const display = curr === 'TRY' 
                        ? amount.toLocaleString('tr-TR', {style:'currency', currency:'TRY'})
                        : `${amount.toLocaleString('tr-TR', {style:'currency', currency:curr})} <br><small>(${amountTL.toLocaleString('tr-TR', {style:'currency', currency:'TRY'})})</small>`;
                    
                    const aCell = row.insertCell(4);
                    aCell.innerHTML = display;
                    aCell.style.textAlign = 'right';

                    const actCell = row.insertCell(5);
                    actCell.className = 'actions-cell';
                    actCell.innerHTML = `<a href="pd.html?id=${doc.id}" class="action-link">Detay</a>`;
                    
                    const delBtn = document.createElement('button');
                    delBtn.className = 'delete-btn';
                    delBtn.textContent = 'Sil';
                    delBtn.onclick = () => deleteProject(doc.id, d.projectName);
                    actCell.appendChild(delBtn);
                });
            } catch (err) { console.error(err); }
        }

        async function deleteProject(id, name) {
            if(confirm(name + ' silinecek. Emin misiniz?')) {
                await db.collection('projects').doc(id).delete();
                loadProjects();
                showSystemMessage('Silindi.');
            }
        }

        // --- 2. C√úZDAN/HESAP ƒ∞≈ûLEMLERƒ∞ (YENƒ∞) ---
        addWalletForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('walletName').value;
            const type = document.getElementById('walletType').value;
            const curr = document.getElementById('walletCurrency').value;
            const bal = parseFloat(document.getElementById('walletBalance').value);

            try {
                await db.collection('accounts').add({
                    ownerId: currentUserId,
                    name: name,
                    type: type,
                    currency: curr,
                    balance: bal,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showSystemMessage('Hesap tanƒ±mlandƒ±!');
                addWalletForm.reset();
                loadWallets();
            } catch (err) { showSystemMessage('Hata: ' + err.message, true); }
        });

        async function loadWallets() {
            if(!currentUserId) return;
            const snap = await db.collection('accounts').where('ownerId', '==', currentUserId).get();
            walletList.innerHTML = '';
            
            if(snap.empty) {
                walletList.innerHTML = '<div style="grid-column:1/-1; text-align:center;">Hen√ºz hesap tanƒ±mlanmamƒ±≈ü.</div>';
                return;
            }

            snap.forEach(doc => {
                const d = doc.data();
                const div = document.createElement('div');
                div.className = 'wallet-card';
                div.innerHTML = `
                    <div class="wallet-info">
                        <h4>${d.name}</h4>
                        <span class="wallet-type">${d.type}</span>
                    </div>
                    <div class="wallet-balance">
                        ${d.balance.toLocaleString('tr-TR', { minimumFractionDigits: 2 })} ${d.currency}
                    </div>
                    <button class="delete-btn" onclick="deleteWallet('${doc.id}')" style="margin-left:10px;">X</button>
                `;
                walletList.appendChild(div);
            });
        }

        window.deleteWallet = async function(id) {
            if(confirm('Bu hesabƒ± silmek istediƒüinize emin misiniz?')) {
                await db.collection('accounts').doc(id).delete();
                loadWallets();
            }
        }

        // --- 3. EV & ≈ûAHSƒ∞ Gƒ∞DER ƒ∞≈ûLEMLERƒ∞ (YENƒ∞) ---
        addPersonalExpenseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const desc = document.getElementById('peDesc').value;
            const cat = document.getElementById('peCategory').value;
            const amount = parseFloat(document.getElementById('peAmount').value);
            const date = document.getElementById('peDate').value;

            try {
                await db.collection('personal_expenses').add({
                    ownerId: currentUserId,
                    description: desc,
                    category: cat,
                    amount: amount,
                    date: firebase.firestore.Timestamp.fromDate(new Date(date)),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                showSystemMessage('Gider kaydedildi.');
                addPersonalExpenseForm.reset();
                document.getElementById('peDate').value = new Date().toISOString().split('T')[0];
                loadPersonalExpenses();
            } catch (err) { showSystemMessage('Hata: ' + err.message, true); }
        });

        async function loadPersonalExpenses() {
            if(!currentUserId) return;
            // Son 20 harcamayƒ± getir
            const snap = await db.collection('personal_expenses')
                .where('ownerId', '==', currentUserId)
                .orderBy('date', 'desc')
                .limit(20)
                .get();
            
            personalExpenseBody.innerHTML = '';
            if(snap.empty) {
                personalExpenseBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Kayƒ±t yok.</td></tr>';
                return;
            }

            snap.forEach(doc => {
                const d = doc.data();
                const row = personalExpenseBody.insertRow();
                const dateStr = d.date ? d.date.toDate().toLocaleDateString('tr-TR') : '-';
                
                row.insertCell(0).textContent = dateStr;
                row.insertCell(1).textContent = d.category;
                row.insertCell(2).textContent = d.description;
                row.insertCell(3).textContent = d.amount.toLocaleString('tr-TR', {style:'currency', currency:'TRY'});
                
                const actCell = row.insertCell(4);
                const btn = document.createElement('button');
                btn.className = 'delete-btn';
                btn.textContent = 'Sil';
                btn.onclick = async () => {
                    if(confirm('Silinsin mi?')) {
                        await db.collection('personal_expenses').doc(doc.id).delete();
                        loadPersonalExpenses();
                    }
                };
                actCell.appendChild(btn);
            });
        }

    </script>
</body>
</html>
