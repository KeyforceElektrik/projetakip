<!DOCTYPE html>
<html lang="tr">
<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DÃ¶nemsel Analiz Raporu</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Rapor SayfasÄ±na Ã–zel Ek Stiller */
        .cash-flow-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .cash-card {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 1px solid #e0e0e0;
        }
        .cash-card h3 {
            margin-top: 0;
            font-size: 1.1em;
            color: #555;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .cash-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 0.95em;
        }
        .cash-row.total {
            border-top: 1px dashed #ccc;
            padding-top: 10px;
            margin-top: 10px;
            font-weight: 700;
            font-size: 1.1em;
        }
        .badge-resmi {
            background-color: #e3f2fd;
            color: #0d47a1;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.85em;
        }
        .badge-gayri {
            background-color: #fff3e0;
            color: #e65100;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.85em;
        }
        .val-positive { color: #28a745; }
        .val-negative { color: #dc3545; }
        
        /* YÃ¼kleniyor animasyonu */
        .loading-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8);
            display: flex; justify-content: center; align-items: center;
            z-index: 1000;
            display: none;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px; height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <div class="container">
        <header>
            <h1>DÃ¶nemsel Analiz Raporu</h1>
            <div class="header-right">
                <span class="user-info">HoÅŸ geldin, <span id="userEmail"></span>!</span>
                <button id="logoutButton" class="button secondary">Ã‡Ä±kÄ±ÅŸ Yap</button>
            </div>
        </header>

        <div class="message" id="systemMessage"></div>

        <h2 class="section-title">Rapor Filtresi</h2>
        <div class="form-grid report-filter-section">
            <div class="form-group">
                <label for="startDate">BaÅŸlangÄ±Ã§ Tarihi (Proje OluÅŸturma):</label>
                <input type="date" id="startDate">
            </div>
            <div class="form-group">
                <label for="endDate">BitiÅŸ Tarihi (Proje OluÅŸturma):</label>
                <input type="date" id="endDate">
            </div>
            <div class="form-group full-width">
                <button id="generateReportButton" class="button primary">Raporu Getir</button>
            </div>
        </div>

        <h2 class="section-title">Nakit AkÄ±ÅŸ Ã–zeti (GerÃ§ekleÅŸen)</h2>
        <p style="color:#666; margin-bottom:20px;">AÅŸaÄŸÄ±daki veriler, seÃ§ilen tarih aralÄ±ÄŸÄ±nda oluÅŸturulan projelerin <strong>bugÃ¼ne kadar yapÄ±lmÄ±ÅŸ</strong> tÃ¼m harcama ve tahsilatlarÄ±nÄ± iÃ§erir.</p>
        
        <div class="cash-flow-grid">
            <div class="cash-card">
                <h3>ðŸ’¸ Toplam Giderler</h3>
                <div class="cash-row">
                    <span class="badge-resmi">Resmi (Fatura)</span>
                    <span id="sumExpResmi">0,00 â‚º</span>
                </div>
                <div class="cash-row">
                    <span class="badge-gayri">Gayri Resmi (Elden)</span>
                    <span id="sumExpGayri">0,00 â‚º</span>
                </div>
                <div class="cash-row total" style="color: #dc3545;">
                    <span>TOPLAM Ã‡IKIÅž</span>
                    <span id="sumExpTotal">0,00 â‚º</span>
                </div>
            </div>

            <div class="cash-card">
                <h3>ðŸ’° Toplam Gelirler</h3>
                <div class="cash-row">
                    <span class="badge-resmi">Resmi (Banka)</span>
                    <span id="sumColResmi">0,00 â‚º</span>
                </div>
                <div class="cash-row">
                    <span class="badge-gayri">Gayri Resmi (Elden)</span>
                    <span id="sumColGayri">0,00 â‚º</span>
                </div>
                <div class="cash-row total" style="color: #28a745;">
                    <span>TOPLAM GÄ°RÄ°Åž</span>
                    <span id="sumColTotal">0,00 â‚º</span>
                </div>
            </div>

            <div class="cash-card">
                <h3>ðŸ“Š Net Kasa Durumu</h3>
                <div class="cash-row">
                    <span>Resmi Kasa Dengesi:</span>
                    <span id="netResmi">0,00 â‚º</span>
                </div>
                <div class="cash-row">
                    <span>Åžahsi Kasa Dengesi:</span>
                    <span id="netGayri">0,00 â‚º</span>
                </div>
                <div class="cash-row total">
                    <span>GENEL NET</span>
                    <span id="netTotal">0,00 â‚º</span>
                </div>
            </div>
        </div>

        <h2 class="section-title">DetaylÄ± Proje Listesi</h2>
        <div class="financial-table-container">
            <table class="financial-table index-table">
                <thead>
                    <tr>
                        <th>Proje AdÄ±</th>
                        <th>MÃ¼ÅŸteri</th>
                        <th>Kategoriler</th>
                        <th>SÃ¶zleÅŸme (TL)</th>
                        <th>Top. Tahsilat</th>
                        <th>Top. Harcama</th>
                        <th>Net Durum</th>
                        <th>Ä°ÅŸlemler</th>
                    </tr>
                </thead>
                <tbody id="detailedProjectListBody">
                    <tr><td colspan="8" style="text-align:center;">Rapor oluÅŸturmak iÃ§in tarihleri seÃ§in.</td></tr>
                </tbody>
            </table>
        </div>

        <div class="back-button-container">
            <button class="button secondary" onclick="window.location.href='index.html'">Ana Sayfaya DÃ¶n</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBNwSpbpNuQQ4nTjDAlB6izu5IgkEZxDL0",
            authDomain: "projetakip-e3a75.firebaseapp.com",
            projectId: "projetakip-e3a75",
            storageBucket: "projetakip-e3a75.firebasestorage.app",
            messagingSenderId: "924120275674",
            appId: "1:924120275674:web:c8ad3d4c998333d9fd23e3"
        };
        firebase.initializeApp(firebaseConfig);

        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUserId = null;

        const userEmailSpan = document.getElementById('userEmail');
        const logoutButton = document.getElementById('logoutButton');
        const systemMessageDiv = document.getElementById('systemMessage');
        const loadingOverlay = document.getElementById('loadingOverlay');

        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const generateReportButton = document.getElementById('generateReportButton');

        // Ã–zet AlanlarÄ±
        const sumExpResmi = document.getElementById('sumExpResmi');
        const sumExpGayri = document.getElementById('sumExpGayri');
        const sumExpTotal = document.getElementById('sumExpTotal');
        
        const sumColResmi = document.getElementById('sumColResmi');
        const sumColGayri = document.getElementById('sumColGayri');
        const sumColTotal = document.getElementById('sumColTotal');

        const netResmi = document.getElementById('netResmi');
        const netGayri = document.getElementById('netGayri');
        const netTotal = document.getElementById('netTotal');

        const detailedProjectListBody = document.getElementById('detailedProjectListBody');

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserId = user.uid;
                userEmailSpan.textContent = user.email;
                
                // VarsayÄ±lan tarih ayarÄ± (Bu ayÄ±n baÅŸÄ± ve sonu)
                const today = new Date();
                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                const format = (d) => {
                    const y = d.getFullYear();
                    const m = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    return `${y}-${m}-${day}`;
                };
                startDateInput.value = format(firstDay);
                endDateInput.value = format(today);

                // Otomatik raporu getir
                generateReport();
            } else {
                window.location.href = 'auth.html';
            }
        });

        logoutButton.addEventListener('click', async () => {
            try {
                await auth.signOut();
            } catch (error) {
                console.error(error);
            }
        });

        function showSystemMessage(message, isError = false) {
            systemMessageDiv.textContent = message;
            systemMessageDiv.className = 'message ' + (isError ? 'error-message' : 'success');
            systemMessageDiv.classList.add('show');
            setTimeout(() => systemMessageDiv.classList.remove('show'), 5000);
        }

        function toggleLoading(show) {
            loadingOverlay.style.display = show ? 'flex' : 'none';
        }

        generateReportButton.addEventListener('click', generateReport);

        async function generateReport() {
            if (!currentUserId) return;

            const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
            const endDate = endDateInput.value ? new Date(endDateInput.value) : null;

            if (startDate && endDate && startDate > endDate) {
                showSystemMessage('BaÅŸlangÄ±Ã§ tarihi bitiÅŸ tarihinden bÃ¼yÃ¼k olamaz.', true);
                return;
            }

            toggleLoading(true);
            resetReportData();

            try {
                // 1. Filtreye uyan projeleri Ã§ek
                let query = db.collection('projects').where('ownerId', '==', currentUserId);
                
                // Client-side filtering for dates to keep indexes simple
                const snapshot = await query.get();
                const projects = [];

                // Tarih filtresini uygula
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const createdAt = data.createdAt ? data.createdAt.toDate() : null;
                    
                    let include = true;
                    if (createdAt) {
                        if (startDate && createdAt < startDate) include = false;
                        // BitiÅŸ tarihinin gÃ¼n sonuna kadar almasÄ± iÃ§in (endDate + 1 gÃ¼n gibi davranmalÄ± veya saat karÅŸÄ±laÅŸtÄ±rmalÄ±)
                        const endDay = new Date(endDate);
                        endDay.setHours(23,59,59);
                        if (endDate && createdAt > endDay) include = false;
                    }
                    
                    if (include) {
                        projects.push({ id: doc.id, ...data });
                    }
                });

                if (projects.length === 0) {
                    detailedProjectListBody.innerHTML = '<tr><td colspan="8" style="text-align:center;">SeÃ§ilen tarih aralÄ±ÄŸÄ±nda proje bulunamadÄ±.</td></tr>';
                    toggleLoading(false);
                    return;
                }

                // 2. Her projenin altÄ±ndaki harcama ve tahsilatlarÄ± Ã§ek (Parallel Requests)
                // Dikkat: Ã‡ok fazla proje varsa bu iÅŸlem okuma kotasÄ±nÄ± etkiler.
                let grandTotalStats = {
                    expResmi: 0, expGayri: 0,
                    colResmi: 0, colGayri: 0
                };

                // Tabloyu doldurmak iÃ§in HTML string
                let tableRowsHTML = '';

                // Projeler Ã¼zerinde dÃ¶n
                const promises = projects.map(async (project) => {
                    // HarcamalarÄ± Ã§ek
                    const expSnap = await db.collection('projects').doc(project.id).collection('expenses').get();
                    let pExp = 0; // Proje Toplam Gider
                    
                    expSnap.forEach(doc => {
                        const d = doc.data();
                        const val = d.amountTL || 0;
                        pExp += val;
                        
                        if (d.recordType === 'Gayri Resmi') grandTotalStats.expGayri += val;
                        else grandTotalStats.expResmi += val;
                    });

                    // TahsilatlarÄ± Ã§ek
                    const colSnap = await db.collection('projects').doc(project.id).collection('collections').get();
                    let pCol = 0; // Proje Toplam Gelir

                    colSnap.forEach(doc => {
                        const d = doc.data();
                        const val = d.amountTL || 0;
                        pCol += val;

                        if (d.recordType === 'Gayri Resmi') grandTotalStats.colGayri += val;
                        else grandTotalStats.colResmi += val;
                    });

                    // SÃ¶zleÅŸme Bedeli Hesapla
                    let contractTL = project.contractAmount || 0;
                    if (project.contractCurrency !== 'TRY' && project.contractExchangeRate) {
                        contractTL = project.contractAmount * project.contractExchangeRate;
                    }

                    // Projenin Net Durumu
                    const pNet = pCol - pExp;
                    const netColor = pNet >= 0 ? '#28a745' : '#dc3545';

                    // SatÄ±rÄ± oluÅŸtur (SÄ±ralama yapmadÄ±k, olduÄŸu gibi ekliyoruz)
                    return `
                        <tr>
                            <td><strong>${project.projectName}</strong></td>
                            <td>${project.customerName}</td>
                            <td>${(project.categories || []).join(', ')}</td>
                            <td style="text-align:right;">${contractTL.toLocaleString('tr-TR', {style:'currency', currency:'TRY'})}</td>
                            <td style="text-align:right; color:#28a745;">${pCol.toLocaleString('tr-TR', {style:'currency', currency:'TRY'})}</td>
                            <td style="text-align:right; color:#dc3545;">${pExp.toLocaleString('tr-TR', {style:'currency', currency:'TRY'})}</td>
                            <td style="text-align:right; font-weight:bold; color:${netColor};">${pNet.toLocaleString('tr-TR', {style:'currency', currency:'TRY'})}</td>
                            <td class="actions-cell">
                                <a href="pd.html?id=${project.id}" class="action-link">Detay</a>
                            </td>
                        </tr>
                    `;
                });

                // TÃ¼m verilerin Ã§ekilmesini bekle
                const rows = await Promise.all(promises);
                detailedProjectListBody.innerHTML = rows.join('');

                // 3. Ã–zet KartlarÄ±nÄ± GÃ¼ncelle
                const totalExp = grandTotalStats.expResmi + grandTotalStats.expGayri;
                const totalCol = grandTotalStats.colResmi + grandTotalStats.colGayri;
                const netResmiVal = grandTotalStats.colResmi - grandTotalStats.expResmi;
                const netGayriVal = grandTotalStats.colGayri - grandTotalStats.expGayri;
                const netTotalVal = totalCol - totalExp;

                // DOM gÃ¼ncelleme
                sumExpResmi.textContent = grandTotalStats.expResmi.toLocaleString('tr-TR', {style:'currency', currency:'TRY'});
                sumExpGayri.textContent = grandTotalStats.expGayri.toLocaleString('tr-TR', {style:'currency', currency:'TRY'});
                sumExpTotal.textContent = totalExp.toLocaleString('tr-TR', {style:'currency', currency:'TRY'});

                sumColResmi.textContent = grandTotalStats.colResmi.toLocaleString('tr-TR', {style:'currency', currency:'TRY'});
                sumColGayri.textContent = grandTotalStats.colGayri.toLocaleString('tr-TR', {style:'currency', currency:'TRY'});
                sumColTotal.textContent = totalCol.toLocaleString('tr-TR', {style:'currency', currency:'TRY'});

                netResmi.textContent = netResmiVal.toLocaleString('tr-TR', {style:'currency', currency:'TRY'});
                netResmi.className = netResmiVal >= 0 ? 'val-positive' : 'val-negative';

                netGayri.textContent = netGayriVal.toLocaleString('tr-TR', {style:'currency', currency:'TRY'});
                netGayri.className = netGayriVal >= 0 ? 'val-positive' : 'val-negative';

                netTotal.textContent = netTotalVal.toLocaleString('tr-TR', {style:'currency', currency:'TRY'});
                netTotal.className = netTotalVal >= 0 ? 'val-positive' : 'val-negative';

                showSystemMessage('Rapor gÃ¼ncellendi.', false);

            } catch (error) {
                console.error('Rapor hatasÄ±:', error);
                showSystemMessage('Rapor oluÅŸturulurken hata: ' + error.message, true);
            } finally {
                toggleLoading(false);
            }
        }

        function resetReportData() {
            sumExpResmi.textContent = '0,00 â‚º';
            sumExpGayri.textContent = '0,00 â‚º';
            sumExpTotal.textContent = '0,00 â‚º';
            
            sumColResmi.textContent = '0,00 â‚º';
            sumColGayri.textContent = '0,00 â‚º';
            sumColTotal.textContent = '0,00 â‚º';

            netResmi.textContent = '0,00 â‚º';
            netGayri.textContent = '0,00 â‚º';
            netTotal.textContent = '0,00 â‚º';
            
            detailedProjectListBody.innerHTML = '';
        }
    </script>
</body>
</html>
