<!DOCTYPE html>
<html lang="tr">
<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dönemsel Analiz Raporu</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Dönemsel Analiz Raporu</h1>
            <div class="header-right">
                <span class="user-info">Hoş geldin, <span id="userEmail"></span>!</span>
                <button id="logoutButton" class="button secondary">Çıkış Yap</button>
            </div>
        </header>

        <div class="message" id="systemMessage"></div>

        <h2 class="section-title">Rapor Filtresi</h2>
        <div class="form-grid report-filter-section">
            <div class="form-group">
                <label for="startDate">Başlangıç Tarihi:</label>
                <input type="date" id="startDate">
            </div>
            <div class="form-group">
                <label for="endDate">Bitiş Tarihi:</label>
                <input type="date" id="endDate">
            </div>
            <div class="form-group full-width">
                <button id="generateReportButton" class="button primary">Rapor Oluştur</button>
            </div>
        </div>

        <h2 class="section-title">Genel Özet</h2>
        <div class="summary-cards">
            <div class="summary-card">
                <h4>Proje Sayısı</h4>
                <p id="totalProjects" class="summary-value"></p>
            </div>
            <div class="summary-card">
                <h4>Toplam Sözleşme Bedeli (TL)</h4>
                <p id="totalContractAmountTL" class="summary-value"></p>
            </div>
        </div>

        <h2 class="section-title">Kategori Bazında Finansal Analiz</h2>
        <div class="financial-table-container">
            <table class="financial-table">
                <thead>
                    <tr>
                        <th>Kategori</th>
                        <th>Proje Sayısı</th>
                        <th>Proje Oranı (%)</th>
                        <th>Toplam Sözleşme Bedeli (TL)</th>
                        <th>Ciro Oranı (%)</th>
                    </tr>
                </thead>
                <tbody id="categoryAnalysisTableBody">
                    <tr><td colspan="5" style="text-align:center;">Rapor oluşturmak için tarihleri seçin.</td></tr>
                </tbody>
            </table>
        </div>

        <h2 class="section-title">Detaylı Proje Listesi</h2>
        <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
            <div class="form-group">
                <label for="detailedFilterStatus">Durum:</label>
                <select id="detailedFilterStatus">
                    <option value="">Tüm Durumlar</option>
                    <option value="Başlamadı">Başlamadı</option>
                    <option value="Devam Ediyor">Devam Ediyor</option>
                    <option value="Takip Ediliyor">Takip Ediliyor</option>
                    <option value="Tamamlandı">Tamamlandı</option>
                </select>
            </div>
            <div class="form-group">
                <label for="detailedFilterCategory">Kategori:</label>
                <select id="detailedFilterCategory">
                    <option value="">Tüm Kategoriler</option>
                    <option value="Aydınlatma">Aydınlatma</option>
                    <option value="Otomasyon">Otomasyon</option>
                    <option value="Taahhüt">Taahhüt</option>
                    <option value="Danışmanlık">Danışmanlık</option>
                    <option value="Diğer">Diğer</option>
                </select>
            </div>
            <div class="form-group">
                <label for="detailedSortBy">Sırala:</label>
                <select id="detailedSortBy">
                    <option value="projectName_asc">Proje Adı (A-Z)</option>
                    <option value="projectName_desc">Proje Adı (Z-A)</option>
                    <option value="contractAmountTL_asc">Sözleşme Bedeli (Artan)</option>
                    <option value="contractAmountTL_desc">Sözleşme Bedeli (Azalan)</option>
                </select>
            </div>
            <div class="form-group full-width">
                <button class="button secondary" id="resetDetailedFilters">Filtreleri Sıfırla</button>
            </div>
        </div>
        
        <div class="financial-table-container">
            <table class="financial-table index-table">
                <thead>
                    <tr>
                        <th>Proje Adı</th>
                        <th>Müşteri</th>
                        <th>Kategoriler</th>
                        <th>Durum</th>
                        <th>Sözleşme Bedeli (TL)</th>
                        <th>İşlemler</th>
                    </tr>
                </thead>
                <tbody id="detailedProjectListBody">
                    <tr><td colspan="6" style="text-align:center;">Detaylı proje listesi için raporu oluşturun.</td></tr>
                </tbody>
            </table>
        </div>

        <div class="back-button-container">
            <button class="button secondary" onclick="window.location.href='index.html'">Ana Sayfaya Dön</button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBNwSpbpNuQQ4nTjDAlB6izu5IgkEZxDL0",
            authDomain: "projetakip-e3a75.firebaseapp.com",
            projectId: "projetakip-e3a75",
            storageBucket: "projetakip-e3a75.firebasestorage.app",
            messagingSenderId: "924120275674",
            appId: "1:924120275674:web:c8ad3d4c998333d9fd23e3"
        };
        firebase.initializeApp(firebaseConfig);

        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUserId = null;
        let allProjects = [];
        let filteredProjects = [];

        const userEmailSpan = document.getElementById('userEmail');
        const logoutButton = document.getElementById('logoutButton');
        const systemMessageDiv = document.getElementById('systemMessage');

        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const generateReportButton = document.getElementById('generateReportButton');

        const totalProjectsSpan = document.getElementById('totalProjects');
        const totalContractAmountTLSpan = document.getElementById('totalContractAmountTL');

        const categoryAnalysisTableBody = document.getElementById('categoryAnalysisTableBody');
        const detailedFilterStatus = document.getElementById('detailedFilterStatus');
        const detailedFilterCategory = document.getElementById('detailedFilterCategory');
        const detailedSortBy = document.getElementById('detailedSortBy');
        const resetDetailedFiltersButton = document.getElementById('resetDetailedFilters');
        const detailedProjectListBody = document.getElementById('detailedProjectListBody');

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserId = user.uid;
                userEmailSpan.textContent = user.email;
                showSystemMessage('Rapor sayfası yüklendi. Tarihleri seçerek rapor oluşturabilirsiniz.', false);

                const today = new Date();
                const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                
                const format = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };

                startDateInput.value = format(firstDayOfMonth);
                endDateInput.value = format(today);

                generateReport();
            } else {
                window.location.href = 'auth.html';
            }
        });

        logoutButton.addEventListener('click', async () => {
            try {
                await auth.signOut();
                console.log('Kullanıcı çıkış yaptı.');
            } catch (error) {
                console.error('Çıkış yaparken hata oluştu:', error.message);
                showSystemMessage('Çıkış yaparken hata oluştu: ' + error.message, true);
            }
        });

        function showSystemMessage(message, isError = false) {
            systemMessageDiv.textContent = message;
            systemMessageDiv.className = 'message';
            if (isError) {
                systemMessageDiv.classList.add('error-message');
            } else {
                systemMessageDiv.classList.add('success');
            }
            systemMessageDiv.classList.add('show');
            setTimeout(() => {
                systemMessageDiv.classList.remove('show');
            }, 5000);
        }

        generateReportButton.addEventListener('click', generateReport);
        detailedFilterStatus.addEventListener('change', () => displayDetailedProjects(filteredProjects));
        detailedFilterCategory.addEventListener('change', () => displayDetailedProjects(filteredProjects));
        detailedSortBy.addEventListener('change', () => displayDetailedProjects(filteredProjects));
        resetDetailedFiltersButton.addEventListener('click', () => {
            detailedFilterStatus.value = '';
            detailedFilterCategory.value = '';
            detailedSortBy.value = 'projectName_asc';
            displayDetailedProjects(filteredProjects);
        });

        async function generateReport() {
            if (!currentUserId) {
                showSystemMessage('Kullanıcı bilgileri yükleniyor...', true);
                return;
            }

            const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
            const endDate = endDateInput.value ? new Date(endDateInput.value) : null;

            if (startDate && endDate && startDate > endDate) {
                showSystemMessage('Başlangıç tarihi bitiş tarihinden sonra olamaz!', true);
                return;
            }

            showSystemMessage('Rapor oluşturuluyor...', false);
            resetReportData();

            try {
                const projectsRef = db.collection('projects').where('ownerId', '==', currentUserId);
                const snapshot = await projectsRef.get();
                allProjects = [];
                let tempFilteredProjects = [];

                if (snapshot.empty) {
                    showSystemMessage('Henüz hiç proje yok.', true);
                    return;
                }

                let totalContractAmount = 0;
                let totalProjectCount = 0;
                const categoryData = {};

                for (const doc of snapshot.docs) {
                    const project = doc.data();
                    const projectId = doc.id;

                    const createdAt = project.createdAt ? project.createdAt.toDate() : null;
                    if (createdAt) {
                        if (startDate && createdAt < startDate) continue;
                        if (endDate && createdAt > endDate) continue;
                    }

                    tempFilteredProjects.push({ id: projectId, ...project });

                    let contractAmountTL = project.contractAmount || 0;
                    if (project.contractCurrency !== 'TRY' && project.contractExchangeRate) {
                        contractAmountTL = project.contractAmount * project.contractExchangeRate;
                    }
                    totalContractAmount += contractAmountTL;
                    totalProjectCount++;

                    project.categories.forEach(cat => {
                        if (!categoryData[cat]) {
                            categoryData[cat] = {
                                projectCount: 0,
                                totalContractAmount: 0
                            };
                        }
                        categoryData[cat].projectCount++;
                        categoryData[cat].totalContractAmount += contractAmountTL;
                    });
                }

                filteredProjects = tempFilteredProjects;

                totalProjectsSpan.textContent = totalProjectCount;
                totalContractAmountTLSpan.textContent = totalContractAmount.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' });

                displayCategoryAnalysis(categoryData, totalProjectCount, totalContractAmount);
                displayDetailedProjects(filteredProjects);
                showSystemMessage('Rapor başarıyla oluşturuldu.', false);

            } catch (error) {
                console.error('Rapor oluşturulurken hata oluştu:', error);
                showSystemMessage('Rapor oluşturulurken bir hata oluştu: ' + error.message, true);
                resetReportData();
            }
        }

        function resetReportData() {
            totalProjectsSpan.textContent = '0';
            totalContractAmountTLSpan.textContent = '0,00 ₺';
            categoryAnalysisTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">Rapor oluşturmak için tarihleri seçin.</td></tr>';
            detailedProjectListBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Detaylı proje listesi için raporu oluşturun.</td></tr>';
        }

        function displayCategoryAnalysis(categoryData, totalProjectCount, totalContractAmount) {
            categoryAnalysisTableBody.innerHTML = '';

            if (Object.keys(categoryData).length === 0) {
                categoryAnalysisTableBody.innerHTML = '<tr><td colspan="5" style="text-align:center; color: #666;">Veri bulunamadı.</td></tr>';
                return;
            }

            Object.keys(categoryData).forEach(cat => {
                const data = categoryData[cat];
                const projeOrani = totalProjectCount > 0 ? ((data.projectCount / totalProjectCount) * 100).toFixed(2) : 0;
                const ciroOrani = totalContractAmount > 0 ? ((data.totalContractAmount / totalContractAmount) * 100).toFixed(2) : 0;

                const row = categoryAnalysisTableBody.insertRow();
                row.insertCell(0).textContent = cat;
                row.insertCell(1).textContent = data.projectCount;
                const projeOranCell = row.insertCell(2);
                projeOranCell.textContent = `${projeOrani}%`;
                projeOranCell.style.fontWeight = '600';
                projeOranCell.style.color = '#007bff';

                row.insertCell(3).textContent = data.totalContractAmount.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' });
                const ciroOranCell = row.insertCell(4);
                ciroOranCell.textContent = `${ciroOrani}%`;
                ciroOranCell.style.fontWeight = '600';
                ciroOranCell.style.color = '#28a745';
            });
        }

        function displayDetailedProjects(projectsToDisplay) {
            detailedProjectListBody.innerHTML = '';
            let currentProjects = [...projectsToDisplay];

            const statusFilter = detailedFilterStatus.value;
            const categoryFilter = detailedFilterCategory.value;

            if (statusFilter) currentProjects = currentProjects.filter(p => p.status === statusFilter);
            if (categoryFilter) currentProjects = currentProjects.filter(p => p.categories?.includes(categoryFilter));

            const sortOption = detailedSortBy.value;
            currentProjects.sort((a, b) => {
                let valA, valB;
                switch (sortOption) {
                    case 'projectName_asc':
                        return (a.projectName || '').localeCompare(b.projectName || '');
                    case 'projectName_desc':
                        return (b.projectName || '').localeCompare(a.projectName || '');
                    case 'contractAmountTL_asc':
                        return (a.contractAmount || 0) - (b.contractAmount || 0);
                    case 'contractAmountTL_desc':
                        return (b.contractAmount || 0) - (a.contractAmount || 0);
                    default:
                        return 0;
                }
            });

            if (currentProjects.length === 0) {
                detailedProjectListBody.innerHTML = '<tr><td colspan="6" style="text-align:center; color: #666;">Filtreyle eşleşen proje yok.</td></tr>';
                return;
            }

            currentProjects.forEach(project => {
                const row = detailedProjectListBody.insertRow();
                row.insertCell(0).textContent = project.projectName;
                row.insertCell(1).textContent = project.customerName;
                row.insertCell(2).textContent = (project.categories && project.categories.length > 0) ? project.categories.join(', ') : 'Belirtilmemiş';

                const statusCell = row.insertCell(3);
                const statusSpan = document.createElement('span');
                statusSpan.textContent = project.status;
                statusSpan.classList.add('status-badge');
                statusSpan.classList.add('status-' + project.status.toLowerCase().replace(/ /g, ''));
                statusCell.appendChild(statusSpan);

                let contractAmountTL = project.contractAmount || 0;
                if (project.contractCurrency !== 'TRY' && project.contractExchangeRate) {
                    contractAmountTL = project.contractAmount * project.contractExchangeRate;
                }
                const amountCell = row.insertCell(4);
                amountCell.textContent = contractAmountTL.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' });

                const actionsCell = row.insertCell(5);
                actionsCell.classList.add('actions-cell');
                const detailLink = document.createElement('a');
                detailLink.href = `pd.html?id=${project.id}`;
                detailLink.textContent = 'Detaylar';
                detailLink.classList.add('action-link');
                actionsCell.appendChild(detailLink);
            });
        }
    </script>
</body>
</html>
