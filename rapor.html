<!DOCTYPE html>
<html lang="tr">
<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dönemsel Analiz Raporu</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Dönemsel Analiz Raporu</h1>
            <div class="header-right">
                <span class="user-info">Hoş geldin, <span id="userEmail"></span>!</span>
                <button id="logoutButton" class="button secondary">Çıkış Yap</button>
            </div>
        </header>

        <div class="message" id="systemMessage"></div>

        <h2 class="section-title">Rapor Filtresi</h2>
        <div class="form-grid report-filter-section">
            <div class="form-group">
                <label for="startDate">Başlangıç Tarihi:</label>
                <input type="date" id="startDate">
            </div>
            <div class="form-group">
                <label for="endDate">Bitiş Tarihi:</label>
                <input type="date" id="endDate">
            </div>
            <div class="form-group full-width">
                <button id="generateReportButton" class="button primary">Rapor Oluştur</button>
            </div>
        </div>

        <h2 class="section-title">Genel Özet</h2>
        <div class="summary-cards">
            <div class="summary-card">
                <h4>Proje Sayısı</h4>
                <p id="totalProjects" class="summary-value"></p>
            </div>
            <div class="summary-card">
                <h4>Toplam Sözleşme Bedeli (TL)</h4>
                <p id="totalContractAmountTL" class="summary-value"></p>
            </div>
            <div class="summary-card">
                <h4>Toplam Harcama (TL)</h4>
                <p id="totalExpensesTL" class="summary-value"></p>
            </div>
            <div class="summary-card">
                <h4>Toplam Tahsilat (TL)</h4>
                <p id="totalCollectionsTL" class="summary-value"></p>
            </div>
            <div class="summary-card">
                <h4>Genel Kalan Bakiye (TL)</h4>
                <p id="overallBalanceTL" class="summary-value"></p>
            </div>
        </div>

        <h2 class="section-title">Duruma Göre Proje Dağılımı</h2>
        <div class="chart-container">
            <canvas id="statusChart"></canvas>
        </div>

        <h2 class="section-title">Kategori Bazında Finansal Analiz</h2>
        <div class="financial-table-container">
            <table class="financial-table">
                <thead>
                    <tr id="categoryTableHeader">
                        <th data-sort="category" class="sortable">Kategori <span class="sort-icon"></span></th>
                        <th data-sort="projectCount" class="sortable">Proje Sayısı <span class="sort-icon"></span></th>
                        <th data-sort="totalContractAmount" class="sortable">Toplam Sözleşme Bedeli (TL) <span class="sort-icon"></span></th>
                        <th data-sort="totalExpenses" class="sortable">Toplam Harcama (TL) <span class="sort-icon"></span></th>
                        <th data-sort="totalCollections" class="sortable">Toplam Tahsilat (TL) <span class="sort-icon"></span></th>
                        <th data-sort="balance" class="sortable">Bakiye (TL) <span class="sort-icon"></span></th>
                    </tr>
                </thead>
                <tbody id="categoryAnalysisTableBody">
                    <tr><td colspan="6" style="text-align:center;">Rapor oluşturmak için tarihleri seçin.</td></tr>
                </tbody>
            </table>
        </div>

        <h2 class="section-title">Detaylı Proje Listesi</h2>
        <div class="form-grid" style="grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));">
            <div class="form-group">
                <label for="detailedFilterStatus">Durum:</label>
                <select id="detailedFilterStatus">
                    <option value="">Tüm Durumlar</option>
                    <option value="Başlamadı">Başlamadı</option>
                    <option value="Devam Ediyor">Devam Ediyor</option>
                    <option value="Takip Ediliyor">Takip Ediliyor</option>
                    <option value="Tamamlandı">Tamamlandı</option>
                </select>
            </div>
            <div class="form-group">
                <label for="detailedFilterCategory">Kategori:</label>
                <select id="detailedFilterCategory">
                    <option value="">Tüm Kategoriler</option>
                    <option value="Aydınlatma">Aydınlatma</option>
                    <option value="Otomasyon">Otomasyon</option>
                    <option value="Taahhüt">Taahhüt</option>
                    <option value="Danışmanlık">Danışmanlık</option>
                    <option value="Diğer">Diğer</option>
                </select>
            </div>
            <div class="form-group">
                <label for="detailedSortBy">Sırala:</label>
                <select id="detailedSortBy">
                    <option value="projectName_asc">Proje Adı (A-Z)</option>
                    <option value="projectName_desc">Proje Adı (Z-A)</option>
                    <option value="contractAmountTL_asc">Sözleşme Bedeli (Artan)</option>
                    <option value="contractAmountTL_desc">Sözleşme Bedeli (Azalan)</option>
                </select>
            </div>
            <div class="form-group full-width">
                <button class="button secondary" id="resetDetailedFilters">Filtreleri Sıfırla</button>
            </div>
        </div>
        
        <div class="financial-table-container">
            <table class="financial-table index-table">
                <thead>
                    <tr>
                        <th>Proje Adı</th>
                        <th>Müşteri</th>
                        <th>Kategoriler</th>
                        <th>Durum</th>
                        <th>Sözleşme Bedeli (TL)</th>
                        <th>İşlemler</th>
                    </tr>
                </thead>
                <tbody id="detailedProjectListBody">
                    <tr><td colspan="6" style="text-align:center;">Detaylı proje listesi için raporu oluşturun.</td></tr>
                </tbody>
            </table>
        </div>

        <div class="back-button-container">
            <button class="button secondary" onclick="window.location.href='index.html'">Ana Sayfaya Dön</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBNwSpbpNuQQ4nTjDAlB6izu5IgkEZxDL0",
            authDomain: "projetakip-e3a75.firebaseapp.com",
            projectId: "projetakip-e3a75",
            storageBucket: "projetakip-e3a75.firebasestorage.app",
            messagingSenderId: "924120275674",
            appId: "1:924120275674:web:c8ad3d4c998333d9fd23e3"
        };
        firebase.initializeApp(firebaseConfig);

        const auth = firebase.auth();
        const db = firebase.firestore();

        let currentUserId = null;
        let allProjects = []; // Tüm projeler
        let filteredProjects = []; // Filtrelenmiş projeler

        // Chart.js grafikleri için değişkenler
        let statusChart = null;

        // DOM Elementleri
        const userEmailSpan = document.getElementById('userEmail');
        const logoutButton = document.getElementById('logoutButton');
        const systemMessageDiv = document.getElementById('systemMessage');

        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const generateReportButton = document.getElementById('generateReportButton');

        const totalProjectsSpan = document.getElementById('totalProjects');
        const totalContractAmountTLSpan = document.getElementById('totalContractAmountTL');
        const totalExpensesTLSpan = document.getElementById('totalExpensesTL');
        const totalCollectionsTLSpan = document.getElementById('totalCollectionsTL');
        const overallBalanceTLSpan = document.getElementById('overallBalanceTL');

        const categoryAnalysisTableBody = document.getElementById('categoryAnalysisTableBody');
        const categoryTableHeader = document.getElementById('categoryTableHeader');

        const detailedFilterStatus = document.getElementById('detailedFilterStatus');
        const detailedFilterCategory = document.getElementById('detailedFilterCategory');
        const detailedSortBy = document.getElementById('detailedSortBy');
        const resetDetailedFiltersButton = document.getElementById('resetDetailedFilters');
        const detailedProjectListBody = document.getElementById('detailedProjectListBody');

        let currentCategorySortColumn = 'category';
        let currentCategorySortDirection = 'asc';

        // Kullanıcı giriş durumunu izle
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserId = user.uid;
                userEmailSpan.textContent = user.email;
                showSystemMessage('Rapor sayfası yüklendi. Tarihleri seçerek rapor oluşturabilirsiniz.', false);

                // Varsayılan tarihleri ayarla: Bu ayın 1'i - Bugün
                const today = new Date();
                const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                
                const format = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };

                startDateInput.value = format(firstDayOfMonth);
                endDateInput.value = format(today);

                // Sayfa yüklendiğinde otomatik rapor oluştur
                generateReport();

            } else {
                window.location.href = 'auth.html';
            }
        });

        // Çıkış yap butonu işlevi
        logoutButton.addEventListener('click', async () => {
            try {
                await auth.signOut();
                console.log('Kullanıcı çıkış yaptı.');
            } catch (error) {
                console.error('Çıkış yaparken hata oluştu:', error.message);
                showSystemMessage('Çıkış yaparken hata oluştu: ' + error.message, true);
            }
        });

        // Sistem mesajlarını gösteren yardımcı fonksiyon
        function showSystemMessage(message, isError = false) {
            systemMessageDiv.textContent = message;
            systemMessageDiv.className = 'message'; // Tüm sınıfları sıfırla
            if (isError) {
                systemMessageDiv.classList.add('error-message');
            } else {
                systemMessageDiv.classList.add('success');
            }
            systemMessageDiv.classList.add('show');
            setTimeout(() => {
                systemMessageDiv.classList.remove('show');
            }, 5000);
        }

        // Rapor Oluştur butonu
        generateReportButton.addEventListener('click', generateReport);
        detailedFilterStatus.addEventListener('change', () => displayDetailedProjects(filteredProjects));
        detailedFilterCategory.addEventListener('change', () => displayDetailedProjects(filteredProjects));
        detailedSortBy.addEventListener('change', () => displayDetailedProjects(filteredProjects));
        resetDetailedFiltersButton.addEventListener('click', () => {
            detailedFilterStatus.value = '';
            detailedFilterCategory.value = '';
            detailedSortBy.value = 'projectName_asc';
            displayDetailedProjects(filteredProjects);
        });

        // Rapor Oluştur Fonksiyonu
        async function generateReport() {
            if (!currentUserId) {
                showSystemMessage('Kullanıcı bilgileri yükleniyor, lütfen bekleyin.', true);
                return;
            }

            const startDate = startDateInput.value ? new Date(startDateInput.value) : null;
            const endDate = endDateInput.value ? new Date(endDateInput.value) : null;

            if (startDate && endDate && startDate > endDate) {
                showSystemMessage('Başlangıç tarihi bitiş tarihinden sonra olamaz!', true);
                return;
            }

            showSystemMessage('Rapor oluşturuluyor...', false);
            resetReportData(); // Önceki verileri temizle

            try {
                const projectsRef = db.collection('projects').where('ownerId', '==', currentUserId);
                const snapshot = await projectsRef.get();
                allProjects = [];
                let tempFilteredProjects = [];

                if (snapshot.empty) {
                    showSystemMessage('Henüz hiç proje yok. Lütfen önce proje ekleyin.', true);
                    return;
                }

                let totalContractAmount = 0;
                let totalExpenses = 0;
                let totalCollections = 0;
                const statusCounts = {};
                const categoryData = {}; // Kategori bazında analiz için

                for (const doc of snapshot.docs) {
                    const project = doc.data();
                    const projectId = doc.id;

                    // Proje oluşturma tarihi filtresi
                    const createdAt = project.createdAt ? project.createdAt.toDate() : null;
                    if (createdAt) {
                        if (startDate && createdAt < startDate) continue;
                        if (endDate && createdAt > endDate) continue;
                    }

                    tempFilteredProjects.push({ id: projectId, ...project });

                    // Sözleşme bedelini TL'ye çevir
                    let contractAmountTL = project.contractAmount || 0;
                    if (project.contractCurrency !== 'TRY' && project.contractExchangeRate) {
                        contractAmountTL = project.contractAmount * project.contractExchangeRate;
                    }
                    totalContractAmount += contractAmountTL;

                    // Durum sayımları
                    statusCounts[project.status] = (statusCounts[project.status] || 0) + 1;

                    // Harcamaları topla
                    const expensesSnapshot = await db.collection('projects').doc(projectId).collection('expenses')
                        .where('date', '>=', startDateInput.value || '1900-01-01')
                        .where('date', '<=', endDateInput.value || '2100-12-31')
                        .get();
                    expensesSnapshot.forEach(expDoc => {
                        const expense = expDoc.data();
                        const amountTL = expense.amountTL || 0;
                        totalExpenses += amountTL;

                        // Kategori bazında harcama ekle
                        project.categories.forEach(cat => {
                            if (!categoryData[cat]) categoryData[cat] = { projectCount: 0, totalContractAmount: 0, totalExpenses: 0, totalCollections: 0, balance: 0 };
                            categoryData[cat].totalExpenses += amountTL;
                        });
                    });

                    // Tahsilatları topla
                    const collectionsSnapshot = await db.collection('projects').doc(projectId).collection('collections')
                        .where('date', '>=', startDateInput.value || '1900-01-01')
                        .where('date', '<=', endDateInput.value || '2100-12-31')
                        .get();
                    collectionsSnapshot.forEach(collDoc => {
                        const collection = collDoc.data();
                        const amountTL = collection.amountTL || 0;
                        totalCollections += amountTL;

                        // Kategori bazında tahsilat ekle
                        project.categories.forEach(cat => {
                            if (!categoryData[cat]) categoryData[cat] = { projectCount: 0, totalContractAmount: 0, totalExpenses: 0, totalCollections: 0, balance: 0 };
                            categoryData[cat].totalCollections += amountTL;
                        });
                    });

                    // Kategori bazında proje sayısı ekle
                    project.categories.forEach(cat => {
                        if (!categoryData[cat]) categoryData[cat] = { projectCount: 0, totalContractAmount: 0, totalExpenses: 0, totalCollections: 0, balance: 0 };
                        const projectCreatedAt = project.createdAt ? project.createdAt.toDate() : new Date(0);
                        if ((!startDate || projectCreatedAt >= startDate) && (!endDate || projectCreatedAt <= endDate)) {
                            categoryData[cat].projectCount++;
                        }
                        categoryData[cat].totalContractAmount += contractAmountTL;
                    });
                }

                filteredProjects = tempFilteredProjects;

                // Genel Özet'i güncelle
                totalProjectsSpan.textContent = filteredProjects.length;
                totalContractAmountTLSpan.textContent = totalContractAmount.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' });
                totalExpensesTLSpan.textContent = totalExpenses.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' });
                totalCollectionsTLSpan.textContent = totalCollections.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' });
                const overallBalance = totalCollections - totalExpenses;
                overallBalanceTLSpan.textContent = overallBalance.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' });
                overallBalanceTLSpan.style.color = overallBalance >= 0 ? '#28a745' : '#dc3545';

                updateStatusChart(statusCounts);
                displayCategoryAnalysis(categoryData);
                displayDetailedProjects(filteredProjects); // Detaylı listeyi de güncelle
                
                showSystemMessage('Rapor başarıyla oluşturuldu.', false);

            } catch (error) {
                console.error('Rapor oluşturulurken hata oluştu:', error);
                showSystemMessage('Rapor oluşturulurken bir hata oluştu: ' + error.message, true);
                resetReportData();
            }
        }

        // Rapor verilerini sıfırla
        function resetReportData() {
            totalProjectsSpan.textContent = '0';
            totalContractAmountTLSpan.textContent = '0,00 ₺';
            totalExpensesTLSpan.textContent = '0,00 ₺';
            totalCollectionsTLSpan.textContent = '0,00 ₺';
            overallBalanceTLSpan.textContent = '0,00 ₺';
            overallBalanceTLSpan.style.color = '';

            if (statusChart) {
                statusChart.destroy();
            }
            categoryAnalysisTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Rapor oluşturmak için tarihleri seçin.</td></tr>';
            detailedProjectListBody.innerHTML = '<tr><td colspan="6" style="text-align:center;">Detaylı proje listesi için raporu oluşturun.</td></tr>';
        }

        // Durum Dağılımı Grafiği
       function updateStatusChart(statusCounts) {
    const labels = Object.keys(statusCounts);
    const data = Object.values(statusCounts);

    const backgroundColors = labels.map(status => {
        switch (status) {
            case 'Başlamadı': return '#6c757d'; // Gri
            case 'Devam Ediyor': return '#007bff'; // Mavi
            case 'Takip Ediliyor': return '#ffc107'; // Sarı
            case 'Tamamlandı': return '#28a745'; // Yeşil
            default: return '#cccccc';
        }
    });

    const ctx = document.getElementById('statusChart').getContext('2d');
    if (statusChart) {
        statusChart.destroy();
    }
    statusChart = new Chart(ctx, {
        type: 'doughnut',
         {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: backgroundColors,
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: true,
                    text: 'Proje Durum Dağılımı',
                    font: {
                        size: 16
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed !== null) {
                                label += context.parsed + ' Proje';
                            }
                            return label;
                        }
                    }
                }
            }
        }
    });
}
        // Kategori Analizi Tablosu
        function displayCategoryAnalysis(categoryData) {
            categoryAnalysisTableBody.innerHTML = '';

            if (Object.keys(categoryData).length === 0) {
                categoryAnalysisTableBody.innerHTML = '<tr><td colspan="6" style="text-align:center; color: #666;">Hiç kategori verisi bulunamadı.</td></tr>';
                return;
            }

            // Sırala
            let sortedCategories = Object.keys(categoryData).map(categoryName => {
                const data = categoryData[categoryName];
                const balance = data.totalCollections - data.totalExpenses;
                return {
                    category: categoryName,
                    projectCount: data.projectCount,
                    totalContractAmount: data.totalContractAmount,
                    totalExpenses: data.totalExpenses,
                    totalCollections: data.totalCollections,
                    balance: balance
                };
            });

            sortedCategories.sort((a, b) => {
                let valA, valB;
                if (currentCategorySortColumn === 'category') {
                    valA = a.category.toLowerCase();
                    valB = b.category.toLowerCase();
                } else {
                    valA = a[currentCategorySortColumn];
                    valB = b[currentCategorySortColumn];
                }

                if (valA < valB) return currentCategorySortDirection === 'asc' ? -1 : 1;
                if (valA > valB) return currentCategorySortDirection === 'asc' ? 1 : -1;
                return 0;
            });

            sortedCategories.forEach(data => {
                const row = categoryAnalysisTableBody.insertRow();
                const categoryCell = row.insertCell(0);
                categoryCell.textContent = data.category;
                categoryCell.classList.add('category-name');
                categoryCell.dataset.category = data.category;

                row.insertCell(1).textContent = data.projectCount;
                row.insertCell(2).textContent = data.totalContractAmount.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' });
                row.insertCell(3).textContent = data.totalExpenses.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' });
                row.insertCell(4).textContent = data.totalCollections.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' });
                const balanceCell = row.insertCell(5);
                balanceCell.textContent = data.balance.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' });
                balanceCell.style.color = data.balance >= 0 ? '#28a745' : '#dc3545';
                balanceCell.style.fontWeight = '600';
                balanceCell.style.textAlign = 'right';
            });

            // Kategori adına tıklama
            categoryAnalysisTableBody.querySelectorAll('.category-name').forEach(cell => {
                cell.addEventListener('click', (e) => {
                    const categoryToFilter = e.target.dataset.category;
                    detailedFilterCategory.value = categoryToFilter;
                    displayDetailedProjects(filteredProjects);
                });
            });
        }

        // Kategori tablosu sıralama
        categoryTableHeader.querySelectorAll('.sortable').forEach(header => {
            header.addEventListener('click', () => {
                const sortColumn = header.dataset.sort;
                categoryTableHeader.querySelectorAll('.sortable .sort-icon').forEach(icon => icon.classList.remove('asc', 'desc'));

                if (currentCategorySortColumn === sortColumn) {
                    currentCategorySortDirection = currentCategorySortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    currentCategorySortColumn = sortColumn;
                    currentCategorySortDirection = 'asc';
                }
                
                header.querySelector('.sort-icon').classList.add(currentCategorySortDirection);
                displayCategoryAnalysis(Object.keys(categoryData).reduce((acc, key) => {
                    const data = categoryData[key];
                    const balance = data.totalCollections - data.totalExpenses;
                    acc[key] = { ...data, balance: balance };
                    return acc;
                }, {}));
            });
        });

        // Detaylı Proje Listesi
        function displayDetailedProjects(projectsToDisplay) {
            detailedProjectListBody.innerHTML = '';
            let currentDetailedProjects = [...projectsToDisplay];

            const statusFilter = detailedFilterStatus.value;
            const categoryFilter = detailedFilterCategory.value;

            if (statusFilter) {
                currentDetailedProjects = currentDetailedProjects.filter(p => p.status === statusFilter);
            }
            if (categoryFilter) {
                currentDetailedProjects = currentDetailedProjects.filter(p => p.categories && p.categories.includes(categoryFilter));
            }

            const sortOption = detailedSortBy.value;
            currentDetailedProjects.sort((a, b) => {
                let valA, valB;
                switch (sortOption) {
                    case 'projectName_asc':
                        valA = a.projectName.toLowerCase();
                        valB = b.projectName.toLowerCase();
                        return valA.localeCompare(valB);
                    case 'projectName_desc':
                        valA = a.projectName.toLowerCase();
                        valB = b.projectName.toLowerCase();
                        return valB.localeCompare(valA);
                    case 'contractAmountTL_asc':
                        valA = a.contractAmount || 0;
                        if (a.contractCurrency !== 'TRY' && a.contractExchangeRate) {
                            valA = a.contractAmount * a.contractExchangeRate;
                        }
                        valB = b.contractAmount || 0;
                        if (b.contractCurrency !== 'TRY' && b.contractExchangeRate) {
                            valB = b.contractAmount * b.contractExchangeRate;
                        }
                        return valA - valB;
                    case 'contractAmountTL_desc':
                        valA = a.contractAmount || 0;
                        if (a.contractCurrency !== 'TRY' && a.contractExchangeRate) {
                            valA = a.contractAmount * a.contractExchangeRate;
                        }
                        valB = b.contractAmount || 0;
                        if (b.contractCurrency !== 'TRY' && b.contractExchangeRate) {
                            valB = b.contractAmount * b.contractExchangeRate;
                        }
                        return valB - valA;
                    default:
                        return 0;
                }
            });

            if (currentDetailedProjects.length === 0) {
                detailedProjectListBody.innerHTML = '<tr><td colspan="6" style="text-align:center; color: #666;">Filtrelere uyan proje bulunamadı.</td></tr>';
                return;
            }

            currentDetailedProjects.forEach(project => {
                const row = detailedProjectListBody.insertRow();
                row.insertCell(0).textContent = project.projectName;
                row.insertCell(1).textContent = project.customerName;
                row.insertCell(2).textContent = (project.categories && project.categories.length > 0) ? project.categories.join(', ') : 'Belirtilmemiş';
                
                const statusCell = row.insertCell(3);
                const statusSpan = document.createElement('span');
                statusSpan.textContent = project.status;
                statusSpan.classList.add('status-badge');
                statusSpan.classList.add('status-' + project.status.toLowerCase().replace(/ /g, ''));
                statusCell.appendChild(statusSpan);

                // Sözleşme bedelini TL'ye çevir
                let contractAmountTL = project.contractAmount || 0;
                if (project.contractCurrency !== 'TRY' && project.contractExchangeRate) {
                    contractAmountTL = project.contractAmount * project.contractExchangeRate;
                }
                row.insertCell(4).textContent = contractAmountTL.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' });

                const actionsCell = row.insertCell(5);
                actionsCell.classList.add('actions-cell');
                const detailLink = document.createElement('a');
                detailLink.href = `pd.html?id=${project.id}`;
                detailLink.textContent = 'Detaylar';
                detailLink.classList.add('action-link');
                actionsCell.appendChild(detailLink);
            });
        }
    </script>
</body>
</html>
