<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banka & Finans Ä°ÅŸlemleri</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Banka & Finans OperasyonlarÄ±</h1>
            <div class="header-right">
                <span class="user-info">HoÅŸ geldin, <span id="userEmail"></span>!</span>
                <button onclick="window.location.href='index.html'" class="button secondary">Ana MenÃ¼</button>
            </div>
        </header>

        <div id="systemMessage" class="message"></div>

        <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 30px;">
            
            <div style="background:#fff; padding:20px; border-radius:8px; border:1px solid #ddd;">
                <h3 class="section-subtitle" style="margin-top:0;">ðŸ”„ Virman (Transfer)</h3>
                <p style="font-size:0.85em; color:#666; margin-bottom:15px;">AynÄ± para birimindeki hesaplar arasÄ± transfer.</p>
                <form id="virmanForm">
                    <div class="form-group">
                        <label>Ã‡Ä±kÄ±ÅŸ YapÄ±lacak Hesap:</label>
                        <select id="vSource" required><option>YÃ¼kleniyor...</option></select>
                    </div>
                    <div class="form-group">
                        <label>GiriÅŸ YapÄ±lacak Hesap:</label>
                        <select id="vTarget" required><option>YÃ¼kleniyor...</option></select>
                    </div>
                    <div class="form-group">
                        <label>Tutar:</label>
                        <input type="number" id="vAmount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Tarih:</label>
                        <input type="date" id="vDate" required>
                    </div>
                    <div class="form-group">
                        <label>AÃ§Ä±klama:</label>
                        <input type="text" id="vDesc" placeholder="Ã–rn: Kasa devir">
                    </div>
                    <button type="submit" class="button primary" style="width:100%">Transfer Yap</button>
                </form>
            </div>

            <div style="background:#fff; padding:20px; border-radius:8px; border:1px solid #ddd;">
                <h3 class="section-subtitle" style="margin-top:0;">ðŸ’± DÃ¶viz AlÄ±ÅŸ/SatÄ±ÅŸ</h3>
                <p style="font-size:0.85em; color:#666; margin-bottom:15px;">FarklÄ± para birimleri arasÄ± dÃ¶nÃ¼ÅŸÃ¼m.</p>
                <form id="fxForm">
                    <div class="form-group">
                        <label>SatÄ±lan (Ã‡Ä±kan) Hesap:</label>
                        <select id="fxSource" required onchange="updateFxLabels()"><option>YÃ¼kleniyor...</option></select>
                    </div>
                    <div class="form-group">
                        <label>AlÄ±nan (Giren) Hesap:</label>
                        <select id="fxTarget" required onchange="updateFxLabels()"><option>YÃ¼kleniyor...</option></select>
                    </div>
                    <div class="form-group">
                        <label id="lblFxAmount">SatÄ±lan Tutar (Ã‡Ä±kan Para):</label>
                        <input type="number" id="fxAmount" step="0.01" required oninput="calcFx()">
                    </div>
                    <div class="form-group">
                        <label>Ä°ÅŸlem Kuru:</label>
                        <input type="number" id="fxRate" step="0.0001" required oninput="calcFx()">
                    </div>
                    <div class="form-group">
                        <label id="lblFxResult">AlÄ±nan Tutar (Hesaplanan):</label>
                        <input type="number" id="fxResult" step="0.01" disabled style="background:#eee;">
                    </div>
                    <button type="submit" class="button primary" style="width:100%; background-color:#6f42c1;">DÃ¶viz Ä°ÅŸlemini Kaydet</button>
                </form>
            </div>
        </div>

        <h3 class="section-subtitle" style="margin-top:40px;">Son Finansal Hareketler</h3>
        <div class="financial-table-container">
            <table class="financial-table">
                <thead><tr><th>Tarih</th><th>Ä°ÅŸlem</th><th>Ã‡Ä±kan Hesap</th><th>Giren Hesap</th><th>Tutar</th><th>Kur</th></tr></thead>
                <tbody id="moveList"><tr><td colspan="6" style="text-align:center;">YÃ¼kleniyor...</td></tr></tbody>
            </table>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBNwSpbpNuQQ4nTjDAlB6izu5IgkEZxDL0",
            authDomain: "projetakip-e3a75.firebaseapp.com",
            projectId: "projetakip-e3a75",
            storageBucket: "projetakip-e3a75.firebasestorage.app",
            messagingSenderId: "924120275674",
            appId: "1:924120275674:web:c8ad3d4c998333d9fd23e3"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUserId = null;
        let accountsData = [];

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserId = user.uid;
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('vDate').value = new Date().toISOString().split('T')[0];
                loadAccounts();
                loadMoves();
            } else { window.location.href = 'auth.html'; }
        });

        function showMessage(msg) { alert(msg); } // Basit uyarÄ±

        async function loadAccounts() {
            const snap = await db.collection('accounts').where('ownerId', '==', currentUserId).get();
            let opts = '<option value="">SeÃ§iniz...</option>';
            accountsData = [];
            snap.forEach(doc => {
                const d = doc.data();
                accountsData.push({ id: doc.id, ...d });
                opts += `<option value="${doc.id}" data-curr="${d.currency}">${d.name} (${d.currency}) - ${d.balance}</option>`;
            });
            
            // TÃ¼m selectleri doldur
            ['vSource', 'vTarget', 'fxSource', 'fxTarget'].forEach(id => {
                document.getElementById(id).innerHTML = opts;
            });
        }

        // --- VÄ°RMAN Ä°ÅžLEMÄ° ---
        document.getElementById('virmanForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const sId = document.getElementById('vSource').value;
            const tId = document.getElementById('vTarget').value;
            const amount = parseFloat(document.getElementById('vAmount').value);
            const date = document.getElementById('vDate').value;
            const desc = document.getElementById('vDesc').value;

            if(sId === tId) return showMessage('AynÄ± hesaba virman yapÄ±lamaz.');
            
            // Para birimi kontrolÃ¼
            const sAcc = accountsData.find(a => a.id === sId);
            const tAcc = accountsData.find(a => a.id === tId);
            if(sAcc.currency !== tAcc.currency) return showMessage(`Para birimleri farklÄ±! (${sAcc.currency} -> ${tAcc.currency}). LÃ¼tfen DÃ¶viz Ä°ÅŸlemi kullanÄ±n.`);

            try {
                const batch = db.batch();
                // Ã‡Ä±kan
                batch.update(db.collection('accounts').doc(sId), { balance: firebase.firestore.FieldValue.increment(-amount) });
                // Giren
                batch.update(db.collection('accounts').doc(tId), { balance: firebase.firestore.FieldValue.increment(amount) });
                
                // KayÄ±t
                const logRef = db.collection('bank_transactions').doc();
                batch.set(logRef, {
                    ownerId: currentUserId, type: 'Virman',
                    sourceId: sId, sourceName: sAcc.name,
                    targetId: tId, targetName: tAcc.name,
                    amount: amount, currency: sAcc.currency,
                    description: desc,
                    date: firebase.firestore.Timestamp.fromDate(new Date(date)),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                await batch.commit();
                showMessage('Virman yapÄ±ldÄ±.');
                document.getElementById('virmanForm').reset();
                loadAccounts(); loadMoves();
            } catch (err) { showMessage(err.message); }
        });

        // --- DÃ–VÄ°Z (FX) HESAPLAMA ---
        function updateFxLabels() {
            const sId = document.getElementById('fxSource').value;
            const tId = document.getElementById('fxTarget').value;
            if(!sId || !tId) return;
            const sAcc = accountsData.find(a => a.id === sId);
            const tAcc = accountsData.find(a => a.id === tId);
            document.getElementById('lblFxAmount').textContent = `SatÄ±lan Tutar (${sAcc.currency}):`;
            document.getElementById('lblFxResult').textContent = `AlÄ±nan Tutar (${tAcc.currency}):`;
        }

        function calcFx() {
            const amt = parseFloat(document.getElementById('fxAmount').value) || 0;
            const rate = parseFloat(document.getElementById('fxRate').value) || 0;
            document.getElementById('fxResult').value = (amt * rate).toFixed(2);
        }

        // --- DÃ–VÄ°Z Ä°ÅžLEMÄ° ---
        document.getElementById('fxForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const sId = document.getElementById('fxSource').value;
            const tId = document.getElementById('fxTarget').value;
            const amountOut = parseFloat(document.getElementById('fxAmount').value); // Ã‡Ä±kan
            const rate = parseFloat(document.getElementById('fxRate').value);
            const amountIn = parseFloat(document.getElementById('fxResult').value); // Giren

            if(sId === tId) return showMessage('Hesaplar farklÄ± olmalÄ±.');

            try {
                const batch = db.batch();
                batch.update(db.collection('accounts').doc(sId), { balance: firebase.firestore.FieldValue.increment(-amountOut) });
                batch.update(db.collection('accounts').doc(tId), { balance: firebase.firestore.FieldValue.increment(amountIn) });

                const logRef = db.collection('bank_transactions').doc();
                const sAcc = accountsData.find(a => a.id === sId);
                const tAcc = accountsData.find(a => a.id === tId);

                batch.set(logRef, {
                    ownerId: currentUserId, type: 'DÃ¶viz Ä°ÅŸlemi',
                    sourceId: sId, sourceName: sAcc.name,
                    targetId: tId, targetName: tAcc.name,
                    amountOut: amountOut, currencyOut: sAcc.currency,
                    amountIn: amountIn, currencyIn: tAcc.currency,
                    rate: rate,
                    date: firebase.firestore.Timestamp.now(),
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                await batch.commit();
                showMessage('DÃ¶viz iÅŸlemi tamamlandÄ±.');
                document.getElementById('fxForm').reset();
                loadAccounts(); loadMoves();
            } catch (err) { showMessage(err.message); }
        });

        async function loadMoves() {
            const snap = await db.collection('bank_transactions').where('ownerId', '==', currentUserId).orderBy('date', 'desc').limit(20).get();
            const tbody = document.getElementById('moveList');
            tbody.innerHTML = '';
            snap.forEach(doc => {
                const d = doc.data();
                const row = tbody.insertRow();
                row.insertCell(0).textContent = d.date.toDate().toLocaleDateString('tr-TR');
                row.insertCell(1).innerHTML = `<b>${d.type}</b>`;
                row.insertCell(2).textContent = d.sourceName;
                row.insertCell(3).textContent = d.targetName;
                
                if (d.type === 'Virman') {
                    row.insertCell(4).textContent = d.amount + ' ' + d.currency;
                    row.insertCell(5).textContent = '-';
                } else {
                    row.insertCell(4).innerHTML = `<span style="color:red">-${d.amountOut} ${d.currencyOut}</span> <br> <span style="color:green">+${d.amountIn} ${d.currencyIn}</span>`;
                    row.insertCell(5).textContent = d.rate;
                }
            });
        }
    </script>
</body>
</html>
