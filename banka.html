<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Banka & Finans - KeyForce</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="style.css">
    <style>
        .bank-grid { display: grid; grid-template-columns: 350px 1fr; gap: 25px; }
        
        .transaction-card {
            background: #fff; padding: 25px; border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #e0e0e0;
        }

        /* Ä°ÅŸlem TÃ¼rÃ¼ ButonlarÄ± */
        .type-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .type-btn {
            padding: 12px; border: 1px solid #ddd; border-radius: 8px; background: #f8f9fa;
            cursor: pointer; text-align: center; font-weight: 600; color: #555; transition: all 0.2s;
            font-size: 0.9em;
        }
        .type-btn.active {
            background-color: #e3f2fd; color: #0d47a1; border-color: #0d47a1;
            box-shadow: 0 2px 5px rgba(13, 71, 161, 0.2);
        }
        .type-btn:hover { background-color: #eee; }

        /* Dinamik Alanlar */
        .dynamic-field { display: none; animation: fadeIn 0.3s ease; }
        .dynamic-field.show { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* Tablo Rozetleri */
        .badge-op { padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: 600; }
        .op-Giden { background: #fee2e2; color: #dc2626; }
        .op-Gelen { background: #d1fae5; color: #059669; }
        .op-Virman { background: #e0f2fe; color: #0284c7; }
        .op-DÃ¶viz { background: #f3e8ff; color: #7c3aed; }

        @media (max-width: 900px) { .bank-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Banka & Finans Merkezi</h1>
            <div class="header-right">
                <span class="user-info">HoÅŸ geldin, <span id="userEmail"></span>!</span>
                <button onclick="window.location.href='index.html'" class="button secondary">Ana MenÃ¼</button>
            </div>
        </header>

        <div id="systemMessage" class="message"></div>

        <div class="bank-grid">
            
            <div class="transaction-card">
                <h3 class="section-subtitle" style="margin-top:0;">Yeni Finansal Ä°ÅŸlem</h3>
                
                <label style="font-weight:600; display:block; margin-bottom:10px;">Ä°ÅŸlem TÃ¼rÃ¼:</label>
                <div class="type-selector">
                    <div class="type-btn active" onclick="setOpType('Giden')">ðŸ“¤ Giden EFT/Havale<br><small>(Ã–deme)</small></div>
                    <div class="type-btn" onclick="setOpType('Gelen')">ðŸ“¥ Gelen EFT/Havale<br><small>(Tahsilat)</small></div>
                    <div class="type-btn" onclick="setOpType('Virman')">ðŸ”„ Virman<br><small>(Transfer)</small></div>
                    <div class="type-btn" onclick="setOpType('DÃ¶viz')">ðŸ’± DÃ¶viz Ä°ÅŸlemi<br><small>(Al/Sat)</small></div>
                </div>

                <form id="bankForm" class="form-grid" style="grid-template-columns: 1fr;">
                    <input type="hidden" id="opType" value="Giden">

                    <div class="form-group">
                        <label id="lblSource">Hangi Hesaptan Ã‡Ä±kacak:</label>
                        <select id="accSource" required onchange="checkCurrencyMatch()"><option value="">SeÃ§iniz...</option></select>
                    </div>

                    <div class="form-group dynamic-field" id="divTargetAcc">
                        <label>Hangi Hesaba Girecek:</label>
                        <select id="accTarget" onchange="checkCurrencyMatch()"><option value="">SeÃ§iniz...</option></select>
                    </div>

                    <div class="form-group dynamic-field show" id="divCari">
                        <label id="lblCari">Kime Ã–deniyor (Cari):</label>
                        <select id="cariSelect"><option value="">SeÃ§iniz...</option></select>
                    </div>

                    <div class="form-group">
                        <label>Ä°ÅŸlem TutarÄ±:</label>
                        <input type="number" id="amount" step="0.01" required placeholder="0.00">
                    </div>

                    <div class="form-group dynamic-field" id="divRate">
                        <label>Ä°ÅŸlem Kuru:</label>
                        <input type="number" id="rate" step="0.0001" placeholder="1.0000">
                        <small id="rateCalcInfo" style="color:#666;"></small>
                    </div>

                    <div class="form-group">
                        <label>Tarih:</label>
                        <input type="date" id="date" required>
                    </div>

                    <div class="form-group">
                        <label>AÃ§Ä±klama:</label>
                        <input type="text" id="desc" placeholder="Ã–rn: Fatura Ã¶demesi, MaaÅŸ...">
                    </div>

                    <button type="submit" class="button primary" style="width:100%; margin-top:10px;">Ä°ÅŸlemi Onayla</button>
                </form>
            </div>

            <div>
                <h3 class="section-subtitle" style="margin-top:0;">Son Banka Hareketleri</h3>
                <div class="financial-table-container">
                    <table class="financial-table">
                        <thead>
                            <tr>
                                <th>Tarih</th>
                                <th>TÃ¼r</th>
                                <th>AÃ§Ä±klama</th>
                                <th>Tutar</th>
                                <th>Durum</th>
                            </tr>
                        </thead>
                        <tbody id="moveList">
                            <tr><td colspan="5" style="text-align:center;">YÃ¼kleniyor...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBNwSpbpNuQQ4nTjDAlB6izu5IgkEZxDL0",
            authDomain: "projetakip-e3a75.firebaseapp.com",
            projectId: "projetakip-e3a75",
            storageBucket: "projetakip-e3a75.firebasestorage.app",
            messagingSenderId: "924120275674",
            appId: "1:924120275674:web:c8ad3d4c998333d9fd23e3"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUserId = null;
        let accountsMap = {}; // Hesap ID -> Data

        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserId = user.uid;
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('date').value = new Date().toISOString().split('T')[0];
                loadData();
            } else { window.location.href = 'auth.html'; }
        });

        function showMessage(msg, isError=false) {
            const el = document.getElementById('systemMessage');
            el.textContent = msg;
            el.className = 'message ' + (isError ? 'error-message' : 'success');
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), 3000);
        }

        // --- ARAYÃœZ YÃ–NETÄ°MÄ° ---
        function setOpType(type) {
            document.getElementById('opType').value = type;
            
            // ButonlarÄ±n aktifliÄŸini deÄŸiÅŸtir
            document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');

            // AlanlarÄ± GÃ¶ster/Gizle
            const divCari = document.getElementById('divCari');
            const divTarget = document.getElementById('divTargetAcc');
            const divRate = document.getElementById('divRate');
            const lblSource = document.getElementById('lblSource');
            const lblCari = document.getElementById('lblCari');

            divCari.className = 'form-group dynamic-field'; // Gizle
            divTarget.className = 'form-group dynamic-field';
            divRate.className = 'form-group dynamic-field';

            if (type === 'Giden') {
                lblSource.textContent = "Hangi Hesaptan Ã–dendi:";
                lblCari.textContent = "Kime Ã–dendi (Cari):";
                divCari.classList.add('show');
            } 
            else if (type === 'Gelen') {
                lblSource.textContent = "Hangi Hesaba Geldi:"; // AslÄ±nda bu Target mantÄ±ÄŸÄ± ama tek dropdown kullanÄ±yoruz
                lblCari.textContent = "Kimden Geldi (Cari):";
                divCari.classList.add('show');
            }
            else if (type === 'Virman') {
                lblSource.textContent = "Ã‡Ä±kÄ±ÅŸ YapÄ±lacak Hesap:";
                divTarget.classList.add('show');
            }
            else if (type === 'DÃ¶viz') {
                lblSource.textContent = "SatÄ±lan (Ã‡Ä±kan) Hesap:";
                divTarget.classList.add('show');
                divRate.classList.add('show');
            }
        }

        async function loadData() {
            // 1. HesaplarÄ± YÃ¼kle
            const accSnap = await db.collection('accounts').where('ownerId','==',currentUserId).get();
            let opts = '<option value="">SeÃ§iniz...</option>';
            accountsMap = {};
            accSnap.forEach(doc => {
                const d = doc.data();
                accountsMap[doc.id] = d;
                opts += `<option value="${doc.id}">${d.name} (${d.currency}) - ${d.balance}</option>`;
            });
            document.getElementById('accSource').innerHTML = opts;
            document.getElementById('accTarget').innerHTML = opts;

            // 2. Carileri YÃ¼kle
            const entSnap = await db.collection('entities').where('ownerId','==',currentUserId).orderBy('name').get();
            let cariOpts = '<option value="">SeÃ§iniz...</option>';
            entSnap.forEach(doc => {
                cariOpts += `<option value="${doc.id}">${doc.data().name}</option>`;
            });
            document.getElementById('cariSelect').innerHTML = cariOpts;

            // 3. Hareketleri YÃ¼kle
            loadMoves();
        }

        // --- Ä°ÅžLEM KAYDI (BEYÄ°N) ---
        document.getElementById('bankForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const type = document.getElementById('opType').value;
            const amount = parseFloat(document.getElementById('amount').value);
            const date = document.getElementById('date').value;
            const desc = document.getElementById('desc').value;
            const sId = document.getElementById('accSource').value; // Source ID (veya Gelen iÃ§in Target ID)
            
            if(!sId || amount <= 0) return showMessage('Eksik bilgi.', true);

            const batch = db.batch();
            const dateObj = firebase.firestore.Timestamp.fromDate(new Date(date));
            const logRef = db.collection('bank_transactions').doc();

            try {
                // Senaryolar
                if (type === 'Giden') {
                    // Hesaptan Ã‡Ä±kÄ±ÅŸ (-), Cariye Alacak (+/Ã–deme)
                    const cId = document.getElementById('cariSelect').value;
                    if(!cId) return showMessage('Cari seÃ§melisiniz.', true);
                    
                    const cariName = document.getElementById('cariSelect').options[document.getElementById('cariSelect').selectedIndex].text;
                    const accName = accountsMap[sId].name;

                    // Banka Hareketi
                    batch.set(logRef, {
                        ownerId: currentUserId, type: 'Giden', amount: amount, currency: accountsMap[sId].currency,
                        sourceId: sId, sourceName: accName, targetId: cId, targetName: cariName, // Target burada Cari oluyor
                        description: desc || 'Giden Transfer', date: dateObj, createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // Bakiye GÃ¼ncellemeleri
                    batch.update(db.collection('accounts').doc(sId), { balance: firebase.firestore.FieldValue.increment(-amount) });
                    batch.update(db.collection('entities').doc(cId), { balance: firebase.firestore.FieldValue.increment(-amount) }); // Carinin alacaÄŸÄ± dÃ¼ÅŸer/borcu artar? (Biz Ã¶dedik, borÃ§ dÃ¼ÅŸer)
                    
                    // Cari Ekstresi iÃ§in Transaction
                    const entTransRef = db.collection('entity_transactions').doc();
                    batch.set(entTransRef, {
                        ownerId: currentUserId, entityId: cId, type: 'AlacaklandÄ±k', // Biz Ã¶dedik
                        amount: amount, description: `Banka Ã–demesi (${accName})`, date: dateObj, createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                } 
                else if (type === 'Gelen') {
                    // Hesaba GiriÅŸ (+), Cariden DÃ¼ÅŸÃ¼ÅŸ (Alacak DÃ¼ÅŸer)
                    // Burada accSource aslÄ±nda paranÄ±n GÄ°RDÄ°ÄžÄ° hesap oluyor (UI kolaylÄ±ÄŸÄ± iÃ§in)
                    const cId = document.getElementById('cariSelect').value;
                    if(!cId) return showMessage('Cari seÃ§melisiniz.', true);

                    const cariName = document.getElementById('cariSelect').options[document.getElementById('cariSelect').selectedIndex].text;
                    const accName = accountsMap[sId].name;

                    batch.set(logRef, {
                        ownerId: currentUserId, type: 'Gelen', amount: amount, currency: accountsMap[sId].currency,
                        sourceId: cId, sourceName: cariName, targetId: sId, targetName: accName,
                        description: desc || 'Gelen Transfer', date: dateObj, createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    batch.update(db.collection('accounts').doc(sId), { balance: firebase.firestore.FieldValue.increment(amount) });
                    batch.update(db.collection('entities').doc(cId), { balance: firebase.firestore.FieldValue.increment(-amount) }); // Carinin borcu dÃ¼ÅŸer (AlacaÄŸÄ± artar mÄ±? HayÄ±r, bize Ã¶dedi, borcu azaldÄ±)
                    
                    const entTransRef = db.collection('entity_transactions').doc();
                    batch.set(entTransRef, {
                        ownerId: currentUserId, entityId: cId, type: 'Tahsilat', 
                        amount: amount, description: `Banka TahsilatÄ± (${accName})`, date: dateObj, createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }
                else if (type === 'Virman') {
                    const tId = document.getElementById('accTarget').value;
                    if(sId === tId) return showMessage('AynÄ± hesaba virman olmaz.', true);
                    if(accountsMap[sId].currency !== accountsMap[tId].currency) return showMessage('Para birimleri farklÄ±! DÃ¶viz iÅŸlemini kullanÄ±n.', true);

                    batch.set(logRef, {
                        ownerId: currentUserId, type: 'Virman', amount: amount, currency: accountsMap[sId].currency,
                        sourceId: sId, sourceName: accountsMap[sId].name, targetId: tId, targetName: accountsMap[tId].name,
                        description: desc || 'Virman', date: dateObj, createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    batch.update(db.collection('accounts').doc(sId), { balance: firebase.firestore.FieldValue.increment(-amount) });
                    batch.update(db.collection('accounts').doc(tId), { balance: firebase.firestore.FieldValue.increment(amount) });
                }
                else if (type === 'DÃ¶viz') {
                    const tId = document.getElementById('accTarget').value;
                    const rate = parseFloat(document.getElementById('rate').value);
                    if(!rate) return showMessage('Kur giriniz.', true);
                    
                    const amountIn = amount * rate; // Basit hesap: Ã‡Ä±kan * Kur = Giren

                    batch.set(logRef, {
                        ownerId: currentUserId, type: 'DÃ¶viz', amount: amount, currency: accountsMap[sId].currency,
                        sourceId: sId, sourceName: accountsMap[sId].name, targetId: tId, targetName: accountsMap[tId].name,
                        rate: rate, amountIn: amountIn, currencyIn: accountsMap[tId].currency,
                        description: desc || 'DÃ¶viz Bozdurma/Alma', date: dateObj, createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    batch.update(db.collection('accounts').doc(sId), { balance: firebase.firestore.FieldValue.increment(-amount) });
                    batch.update(db.collection('accounts').doc(tId), { balance: firebase.firestore.FieldValue.increment(amountIn) });
                }

                await batch.commit();
                showMessage('Ä°ÅŸlem baÅŸarÄ±yla kaydedildi!');
                document.getElementById('bankForm').reset();
                document.getElementById('date').value = new Date().toISOString().split('T')[0];
                loadData(); // Tabloyu ve bakiyeleri yenile

            } catch (err) { showMessage('Hata: ' + err.message, true); }
        });

        // YardÄ±mcÄ±: Kur kontrolÃ¼ (Opsiyonel gÃ¶rsel uyarÄ±)
        function checkCurrencyMatch() {
            // ... (KullanÄ±cÄ± dostu uyarÄ±lar eklenebilir)
        }

        async function loadMoves() {
            const snap = await db.collection('bank_transactions').where('ownerId','==',currentUserId).orderBy('date','desc').limit(20).get();
            const list = document.getElementById('moveList');
            list.innerHTML = '';
            if(snap.empty) { list.innerHTML = '<tr><td colspan="5" style="text-align:center;">Ä°ÅŸlem yok.</td></tr>'; return; }

            snap.forEach(doc => {
                const d = doc.data();
                const row = list.insertRow();
                row.insertCell(0).textContent = d.date.toDate().toLocaleDateString('tr-TR');
                row.insertCell(1).innerHTML = `<span class="badge-op op-${d.type}">${d.type}</span>`;
                row.insertCell(2).innerHTML = `${d.description} <br> <small style="color:#666;">${d.sourceName} -> ${d.targetName}</small>`;
                
                let amountStr = '';
                if(d.type === 'DÃ¶viz') amountStr = `-${d.amount} ${d.currency} <br> +${d.amountIn.toFixed(2)} ${d.currencyIn}`;
                else amountStr = `${d.amount.toLocaleString('tr-TR')} ${d.currency}`;
                
                row.insertCell(3).innerHTML = amountStr;
                row.insertCell(4).textContent = "TamamlandÄ±";
            });
        }
    </script>
</body>
</html>
