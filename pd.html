<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="dynamicPageTitle">Proje Detayı</title>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <!-- Google Fonts - Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1 id="pageMainTitle">Proje Yöneticisi</h1>
            <div>
                <span class="user-info">Hoş geldin, <span id="userEmail"></span>!</span>
                <button id="logoutButton" class="logout-button">Çıkış Yap</button>
            </div>
        </header>

        <div class="message" id="systemMessage"></div>

        <div class="tab-buttons">
            <button class="tab-button active" data-tab="project-info">Proje Bilgileri</button>
            <button class="tab-button" data-tab="expenses">Harcamalar</button>
            <button class="tab-button" data-tab="collections">Tahsilatlar</button>
        </div>

        <!-- Proje Bilgileri Sekmesi -->
        <div id="project-info" class="tab-content active">
            <h2 class="section-title">Proje Detayları</h2>
            <form id="projectForm">
                <div class="form-group">
                    <label for="projectName">Proje Adı:</label>
                    <input type="text" id="projectName" required>
                </div>

                <div class="form-group">
                    <label for="customerName">Müşteri Adı:</label>
                    <input type="text" id="customerName" required>
                </div>

                <div class="form-group">
                    <label for="categories">Kategoriler (virgülle ayırın):</label>
                    <input type="text" id="categories" placeholder="örn: Yazılım, Danışmanlık">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="contractStartDate">Sözleşme Başlangıç Tarihi:</label>
                        <input type="date" id="contractStartDate">
                    </div>
                    <div class="form-group">
                        <label for="contractEndDate">Sözleşme Bitiş Tarihi:</label>
                        <input type="date" id="contractEndDate">
                    </div>
                </div>

                <div class="form-group">
                    <label for="contractAmountTL">Sözleşme Bedeli (TL):</label>
                    <input type="number" id="contractAmountTL" step="0.01" value="0" required>
                </div>
                
                <div class="form-group">
                    <label for="status">Durum:</label>
                    <select id="status">
                        <option value="Başlamadı">Başlamadı</option>
                        <option value="Devam Ediyor">Devam Ediyor</option>
                        <option value="Takip Ediliyor">Takip Ediliyor</option>
                        <option value="Tamamlandı">Tamamlandı</option>
                    </select>
                </div>

                <button type="submit" class="button">Kaydet</button>
                <button type="button" id="deleteProjectButton" class="button secondary" style="background-color: #dc3545; display: none;">Projeyi Sil</button>
            </form>
        </div>

        <!-- Harcamalar Sekmesi -->
        <div id="expenses" class="tab-content">
            <h2 class="section-title">Harcamalar</h2>
            <form id="expenseForm">
                <div class="form-group">
                    <label for="expenseDescription">Açıklama:</label>
                    <input type="text" id="expenseDescription" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="expenseAmount">Miktar:</label>
                        <input type="number" id="expenseAmount" step="0.01" value="0" required>
                    </div>
                    <div class="form-group">
                        <label for="expenseCurrency">Para Birimi:</label>
                        <select id="expenseCurrency">
                            <option value="TRY">TRY</option>
                            <option value="USD">USD</option>
                            <option value="EUR">EUR</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="expenseExchangeRate">Kur (1 ${expenseCurrency.value} = X TL):</label>
                        <input type="number" id="expenseExchangeRate" step="0.0001" value="1" required>
                    </div>
                    <div class="form-group">
                        <label for="expenseDate">Tarih:</label>
                        <input type="date" id="expenseDate" required>
                    </div>
                </div>
                <button type="submit" class="button">Harcama Ekle</button>
            </form>

            <div class="financial-table-container">
                <table class="financial-table">
                    <thead>
                        <tr>
                            <th>Açıklama</th>
                            <th>Miktar</th>
                            <th>P.B.</th>
                            <th>Kur</th>
                            <th>Tutar (TL)</th>
                            <th>Tarih</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody id="expensesTableBody">
                        <tr><td colspan="7" style="text-align:center;">Henüz harcama eklenmedi.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Tahsilatlar Sekmesi -->
        <div id="collections" class="tab-content">
            <h2 class="section-title">Tahsilatlar</h2>
            <form id="collectionForm">
                <div class="form-group">
                    <label for="collectionType">Tahsilat Tipi:</label>
                    <select id="collectionType" required>
                        <option value="Nakit">Nakit</option>
                        <option value="Banka Havalesi">Banka Havalesi</option>
                        <option value="Çek">Çek</option>
                        <option value="Senet">Senet</option>
                        <option value="Barter">Barter</option>
                    </select>
                </div>
                <div class="form-group" id="checkNumberGroup" style="display:none;">
                    <label for="checkNumber">Çek Numarası:</label>
                    <input type="text" id="checkNumber">
                </div>
                <div class="form-group" id="checkDueDateGroup" style="display:none;">
                    <label for="checkDueDate">Vade Tarihi:</label>
                    <input type="date" id="checkDueDate">
                </div>
                <div class="form-group" id="barterAssetGroup" style="display:none;">
                    <label for="barterAsset">Barter Varlığı:</label>
                    <input type="text" id="barterAsset" placeholder="örn: Ürün, Hizmet">
                </div>
                 <div class="form-group" id="barterValueTLGroup" style="display:none;">
                    <label for="barterValueTL">Barter Değeri (TL):</label>
                    <input type="number" id="barterValueTL" step="0.01" value="0">
                </div>

                <div class="form-group">
                    <label for="collectionDescription">Açıklama/Detay:</label>
                    <textarea id="collectionDescription" rows="2"></textarea>
                </div>
                <div class="form-row" id="collectionAmountCurrencyRow">
                    <div class="form-group">
                        <label for="collectionAmount">Miktar:</label>
                        <input type="number" id="collectionAmount" step="0.01" value="0" required>
                    </div>
                    <div class="form-group">
                        <label for="collectionCurrency">Para Birimi:</label>
                        <select id="collectionCurrency">
                            <option value="TRY">TRY</option>
                            <option value="USD">USD</option>
                            <option value="EUR">EUR</option>
                        </select>
                    </div>
                </div>
                <div class="form-row" id="collectionExchangeRateRow">
                    <div class="form-group">
                        <label for="collectionExchangeRate">Kur (1 ${collectionCurrency.value} = X TL):</label>
                        <input type="number" id="collectionExchangeRate" step="0.0001" value="1" required>
                    </div>
                    <div class="form-group">
                        <label for="collectionDate">Tarih:</label>
                        <input type="date" id="collectionDate" required>
                    </div>
                </div>
                
                <button type="submit" class="button">Tahsilat Ekle</button>
            </form>

            <div class="financial-table-container">
                <table class="financial-table">
                    <thead>
                        <tr>
                            <th>Tarih</th>
                            <th>Tip</th>
                            <th>Açıklama/Detay</th>
                            <th>Vade Tarihi</th>
                            <th>Miktar</th>
                            <th>P.B.</th>
                            <th>Kur</th>
                            <th>Tutar (TL)</th>
                            <th>İşlemler</th>
                        </tr>
                    </thead>
                    <tbody id="collectionsTableBody">
                        <tr><td colspan="9" style="text-align:center;">Henüz tahsilat eklenmedi.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="back-button-container">
            <button class="button secondary" onclick="window.location.href='index.html'">Projelere Geri Dön</button>
        </div>
    </div>

    <script>
        // Firebase Konfigürasyonunuzu BURAYA YAPIŞTIRIN
        const firebaseConfig = {
            apiKey: "AIzaSyBNwSpbpNuQQ4nTjDAlB6izu5IgkEZxDL0", // Kendi API Key'iniz
            authDomain: "projetakip-e3a75.firebaseapp.com",
            projectId: "projetakip-e3a75",
            storageBucket: "projetakip-e3a75.firebasestorage.app",
            messagingSenderId: "924120275674",
            appId: "1:924120275674:web:c8ad3d4c998333d9fd23e3"
        };
        firebase.initializeApp(firebaseConfig);

        const auth = firebase.auth();
        const db = firebase.firestore();

        const userEmailSpan = document.getElementById('userEmail');
        const logoutButton = document.getElementById('logoutButton');
        const systemMessageDiv = document.getElementById('systemMessage');
        const dynamicPageTitle = document.getElementById('dynamicPageTitle');
        const pageMainTitle = document.getElementById('pageMainTitle');


        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        const projectForm = document.getElementById('projectForm');
        const projectNameInput = document.getElementById('projectName');
        const customerNameInput = document.getElementById('customerName');
        const categoriesInput = document.getElementById('categories');
        const contractStartDateInput = document.getElementById('contractStartDate');
        const contractEndDateInput = document.getElementById('contractEndDate');
        const contractAmountTLInput = document.getElementById('contractAmountTL'); 
        const statusSelect = document.getElementById('status');
        const deleteProjectButton = document.getElementById('deleteProjectButton');

        const expenseForm = document.getElementById('expenseForm');
        const expenseDescriptionInput = document.getElementById('expenseDescription');
        const expenseAmountInput = document.getElementById('expenseAmount');
        const expenseCurrencySelect = document.getElementById('expenseCurrency');
        const expenseExchangeRateInput = document.getElementById('expenseExchangeRate');
        const expenseDateInput = document.getElementById('expenseDate');
        const expensesTableBody = document.getElementById('expensesTableBody');

        const collectionForm = document.getElementById('collectionForm');
        const collectionTypeSelect = document.getElementById('collectionType');
        const checkNumberGroup = document.getElementById('checkNumberGroup');
        const checkNumberInput = document.getElementById('checkNumber');
        const checkDueDateGroup = document.getElementById('checkDueDateGroup');
        const checkDueDateInput = document.getElementById('checkDueDate');
        const barterAssetGroup = document.getElementById('barterAssetGroup');
        const barterAssetInput = document.getElementById('barterAsset');
        const barterValueTLGroup = document.getElementById('barterValueTLGroup');
        const barterValueTLInput = document.getElementById('barterValueTL');
        const collectionDescriptionInput = document.getElementById('collectionDescription');
        const collectionAmountInput = document.getElementById('collectionAmount');
        const collectionCurrencySelect = document.getElementById('collectionCurrency');
        const collectionExchangeRateInput = document.getElementById('collectionExchangeRate');
        const collectionDateInput = document.getElementById('collectionDate');
        const collectionsTableBody = document.getElementById('collectionsTableBody');
        const collectionAmountCurrencyRow = document.getElementById('collectionAmountCurrencyRow');
        const collectionExchangeRateRow = document.getElementById('collectionExchangeRateRow');


        let currentProjectId = null;
        let currentUserId = null;

        // Sekme değiştirme fonksiyonu
        function showTab(tabId) {
            tabContents.forEach(content => {
                content.classList.remove('active');
            });
            tabButtons.forEach(button => {
                button.classList.remove('active');
            });

            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab-button[data-tab="${tabId}"]`).classList.add('active');
        }

        // Sekme butonlarına event listener ekle
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                showTab(button.dataset.tab);
            });
        });

        // Kullanıcı giriş durumunu izle
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserId = user.uid;
                userEmailSpan.textContent = user.email;
                console.log("Auth State Changed: User Logged In. UID:", currentUserId); // LOG

                const urlParams = new URLSearchParams(window.location.search);
                currentProjectId = urlParams.get('id');

                if (currentProjectId) {
                    dynamicPageTitle.textContent = 'Proje Detayı ve Yönetimi';
                    pageMainTitle.textContent = 'Proje Detayı ve Yönetimi';
                    deleteProjectButton.style.display = 'inline-block';
                    loadProjectData(currentProjectId);
                    loadExpenses(currentProjectId);
                    loadCollections(currentProjectId);
                } else {
                    dynamicPageTitle.textContent = 'Yeni Proje Ekle';
                    pageMainTitle.textContent = 'Yeni Proje Ekle';
                    deleteProjectButton.style.display = 'none';
                    // Yeni proje eklenirken sadece proje bilgileri sekmesini göster
                    showTab('project-info'); 
                    // Harcama ve Tahsilat formlarını ve tablolarını gizle (yeni projede bunlar olmaz)
                    document.getElementById('expenses').style.display = 'none';
                    document.getElementById('collections').style.display = 'none';
                    document.querySelector('.tab-button[data-tab="expenses"]').style.display = 'none';
                    document.querySelector('.tab-button[data-tab="collections"]').style.display = 'none';
                }
            } else {
                console.log("Auth State Changed: User Logged Out. Redirecting to auth.html"); // LOG
                window.location.href = 'auth.html';
            }
        });

        // Çıkış yap butonu
        logoutButton.addEventListener('click', async () => {
            try {
                await auth.signOut();
                console.log("User signed out."); // LOG
            } catch (error) {
                showSystemMessage('Çıkış yaparken hata oluştu: ' + error.message, true);
                console.error("Logout Error:", error); // LOG
            }
        });

        // Proje Kaydet/Güncelle
        projectForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const projectName = projectNameInput.value;
            const customerName = customerNameInput.value;
            const categories = categoriesInput.value.split(',').map(cat => cat.trim()).filter(cat => cat !== '');
            const contractStartDate = contractStartDateInput.value;
            const contractEndDate = contractEndDateInput.value;
            const contractAmountTL = parseFloat(contractAmountTLInput.value);
            const status = statusSelect.value;
            const createdAt = currentProjectId ? undefined : firebase.firestore.FieldValue.serverTimestamp();
            
            const safeContractAmountTL = isNaN(contractAmountTL) ? 0 : contractAmountTL;

            const projectData = {
                projectName,
                customerName,
                categories,
                contractStartDate,
                contractEndDate,
                contractAmountTL: safeContractAmountTL,
                status,
                userId: currentUserId
            };

            if (createdAt) {
                projectData.createdAt = createdAt;
            }

            try {
                if (!currentUserId) { // Ek kontrol
                    showSystemMessage('Lütfen önce giriş yapın.', true);
                    console.error("Project save failed: currentUserId is null."); // LOG
                    return;
                }

                if (currentProjectId) {
                    // Mevcut projeyi güncelle
                    console.log("Attempting to update project:", currentProjectId, "at path:", db.collection('users').doc(currentUserId).collection('projects').doc(currentProjectId).path); // LOG
                    await db.collection('users').doc(currentUserId).collection('projects').doc(currentProjectId).update(projectData);
                    showSystemMessage('Proje başarıyla güncellendi!');
                    console.log("Project updated successfully."); // LOG
                } else {
                    // Yeni proje ekle
                    console.log("Attempting to add new project for user:", currentUserId, "at path:", db.collection('users').doc(currentUserId).collection('projects').path); // LOG
                    const docRef = await db.collection('users').doc(currentUserId).collection('projects').add(projectData);
                    currentProjectId = docRef.id;
                    showSystemMessage('Proje başarıyla eklendi!');
                    console.log("New project added with ID:", currentProjectId); // LOG
                    window.history.pushState({}, '', `pd.html?id=${currentProjectId}`);
                    // Yeni proje eklendikten sonra Harcama ve Tahsilat sekmelerini görünür yap
                    document.getElementById('expenses').style.display = 'block';
                    document.getElementById('collections').style.display = 'block';
                    document.querySelector('.tab-button[data-tab="expenses"]').style.display = 'inline-block';
                    document.querySelector('.tab-button[data-tab="collections"]').style.display = 'inline-block';
                    // Sayfa başlıklarını güncelle
                    dynamicPageTitle.textContent = 'Proje Detayı ve Yönetimi';
                    pageMainTitle.textContent = 'Proje Detayı ve Yönetimi';
                    deleteProjectButton.style.display = 'inline-block';
                }
            } catch (error) {
                console.error("Proje kaydedilirken hata oluştu: ", error); // LOG
                showSystemMessage('Proje kaydedilirken hata oluştu: ' + error.message, true);
            }
        });

        // Proje verilerini yükle
        async function loadProjectData(projectId) {
            if (!currentUserId) { // Ek kontrol
                console.warn("loadProjectData: currentUserId is null. User might not be authenticated yet."); // LOG
                return;
            }
            const projectDocRef = db.collection('users').doc(currentUserId).collection('projects').doc(projectId);
            console.log("Attempting to load project data from path:", projectDocRef.path); // LOG

            try {
                const doc = await projectDocRef.get();
                if (doc.exists) {
                    const project = doc.data();
                    projectNameInput.value = project.projectName || '';
                    customerNameInput.value = project.customerName || '';
                    categoriesInput.value = (project.categories || []).join(', ');
                    contractStartDateInput.value = project.contractStartDate || '';
                    contractEndDateInput.value = project.contractEndDate || '';
                    contractAmountTLInput.value = project.contractAmountTL || 0;
                    statusSelect.value = project.status || 'Başlamadı';
                    console.log("Project data loaded successfully for ID:", projectId); // LOG
                } else {
                    showSystemMessage('Proje bulunamadı.', true);
                    console.warn("Project with ID", projectId, "not found."); // LOG
                    window.location.href = 'index.html';
                }
            } catch (error) {
                console.error("Proje yüklenirken hata oluştu: ", error); // LOG
                showSystemMessage('Proje yüklenirken hata oluştu: ' + error.message, true);
            }
        }

        // Projeyi sil butonu
        deleteProjectButton.addEventListener('click', async () => {
            if (currentProjectId && confirm('Bu projeyi silmek istediğinizden emin misiniz? Harcamalar ve tahsilatlar da silinecektir.')) {
                if (!currentUserId) { // Ek kontrol
                    showSystemMessage('Lütfen önce giriş yapın.', true);
                    console.error("Project deletion failed: currentUserId is null."); // LOG
                    return;
                }
                console.log("Attempting to delete project and subcollections for ID:", currentProjectId); // LOG
                try {
                    const projectRef = db.collection('users').doc(currentUserId).collection('projects').doc(currentProjectId);

                    const expensesSnapshot = await projectRef.collection('expenses').get();
                    const batch = db.batch();
                    expensesSnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                        console.log("Adding expense to batch for deletion:", doc.id); // LOG
                    });

                    const collectionsSnapshot = await projectRef.collection('collections').get();
                    collectionsSnapshot.forEach(doc => {
                        batch.delete(doc.ref);
                        console.log("Adding collection to batch for deletion:", doc.id); // LOG
                    });

                    await batch.commit();
                    console.log("Batch operations (expenses, collections deletion) committed."); // LOG

                    await projectRef.delete();
                    showSystemMessage('Proje başarıyla silindi!');
                    console.log("Project", currentProjectId, "deleted successfully."); // LOG
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1500);
                } catch (error) {
                    console.error("Proje silinirken hata oluştu: ", error); // LOG
                    showSystemMessage('Proje silinirken hata oluştu: ' + error.message, true);
                }
            }
        });

        // Harcama Ekle
        expenseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentProjectId) {
                showSystemMessage('Lütfen önce projeyi kaydedin.', true);
                return;
            }
            if (!currentUserId) { // Ek kontrol
                showSystemMessage('Lütfen önce giriş yapın.', true);
                console.error("Expense save failed: currentUserId is null."); // LOG
                return;
            }

            const expenseDescription = expenseDescriptionInput.value;
            const expenseAmount = parseFloat(expenseAmountInput.value);
            const expenseCurrency = expenseCurrencySelect.value;
            const expenseExchangeRate = parseFloat(expenseExchangeRateInput.value);
            const expenseDate = expenseDateInput.value;

            const safeExpenseAmount = isNaN(expenseAmount) ? 0 : expenseAmount;
            const safeExpenseExchangeRate = isNaN(expenseExchangeRate) ? 1 : expenseExchangeRate;
            const expenseAmountTL = safeExpenseAmount * safeExpenseExchangeRate;

            const expenseData = {
                description: expenseDescription,
                amount: safeExpenseAmount,
                currency: expenseCurrency,
                exchangeRate: safeExpenseExchangeRate,
                amountTL: expenseAmountTL,
                date: expenseDate,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            const expenseCollectionRef = db.collection('users').doc(currentUserId).collection('projects').doc(currentProjectId).collection('expenses');
            console.log("Attempting to add expense to path:", expenseCollectionRef.path); // LOG

            try {
                await expenseCollectionRef.add(expenseData);
                showSystemMessage('Harcama başarıyla eklendi!');
                console.log("Expense added successfully."); // LOG
                expenseForm.reset();
                expenseExchangeRateInput.value = 1;
                loadExpenses(currentProjectId);
            } catch (error) {
                console.error("Harcama eklenirken hata oluştu: ", error); // LOG
                showSystemMessage('Harcama eklenirken hata oluştu: ' + error.message, true);
            }
        });

        // Harcamaları Yükle
        async function loadExpenses(projectId) {
            expensesTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Harcamalar yükleniyor...</td></tr>';
            if (!currentUserId || !projectId) { // Ek kontrol
                console.warn("loadExpenses: currentUserId or projectId is null. Skipping load."); // LOG
                expensesTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Harcamalar yüklenemedi (Kullanıcı/Proje bilgisi eksik).</td></tr>';
                return;
            }
            const expenseCollectionRef = db.collection('users').doc(currentUserId).collection('projects').doc(projectId).collection('expenses');
            console.log("Attempting to load expenses from path:", expenseCollectionRef.path); // LOG

            try {
                const snapshot = await expenseCollectionRef.orderBy('date', 'desc').get();
                if (snapshot.empty) {
                    expensesTableBody.innerHTML = '<tr><td colspan="7" style="text-align:center;">Henüz harcama eklenmedi.</td></tr>';
                    console.log("No expenses found for project:", projectId); // LOG
                    return;
                }

                expensesTableBody.innerHTML = '';
                snapshot.forEach(doc => {
                    const expense = doc.data();
                    const row = expensesTableBody.insertRow();
                    row.insertCell(0).textContent = expense.description || '';
                    row.insertCell(1).textContent = expense.amount.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    row.insertCell(2).textContent = expense.currency || 'TL';
                    row.insertCell(3).textContent = expense.exchangeRate.toLocaleString('tr-TR', { minimumFractionDigits: 4, maximumFractionDigits: 4 });
                    row.insertCell(4).textContent = expense.amountTL.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' });
                    row.insertCell(5).textContent = expense.date || 'N/A';

                    const actionsCell = row.insertCell(6);
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Sil';
                    deleteButton.classList.add('delete-btn');
                    deleteButton.addEventListener('click', async () => {
                        if (confirm('Bu harcamayı silmek istediğinizden emin misiniz?')) {
                            if (!currentUserId) {
                                showSystemMessage('Lütfen önce giriş yapın.', true);
                                return;
                            }
                            console.log("Attempting to delete expense:", doc.id, "from path:", expenseCollectionRef.doc(doc.id).path); // LOG
                            try {
                                await expenseCollectionRef.doc(doc.id).delete();
                                showSystemMessage('Harcama başarıyla silindi.');
                                console.log("Expense", doc.id, "deleted successfully."); // LOG
                                loadExpenses(projectId);
                            } catch (error) {
                                console.error("Harcama silinirken hata oluştu: ", error); // LOG
                                showSystemMessage('Harcama silinirken hata oluştu: ' + error.message, true);
                            }
                        }
                    });
                    actionsCell.appendChild(deleteButton);
                    actionsCell.style.textAlign = 'center';
                });
                console.log("Expenses loaded successfully for project:", projectId); // LOG
            } catch (error) {
                console.error("Harcamalar yüklenirken hata oluştu: ", error); // LOG
                showSystemMessage('Harcamalar yüklenirken hata oluştu: ' + error.message, true);
            }
        }

        // Tahsilat Tipi Değişikliğinde Ek Alanları Göster/Gizle
        collectionTypeSelect.addEventListener('change', () => {
            const selectedType = collectionTypeSelect.value;
            checkNumberGroup.style.display = 'none';
            checkDueDateGroup.style.display = 'none';
            barterAssetGroup.style.display = 'none';
            barterValueTLGroup.style.display = 'none';
            collectionAmountCurrencyRow.style.display = 'flex';
            collectionExchangeRateRow.style.display = 'flex';


            if (selectedType === 'Çek' || selectedType === 'Senet') {
                checkNumberGroup.style.display = 'block';
                checkDueDateGroup.style.display = 'block';
            } else if (selectedType === 'Barter') {
                barterAssetGroup.style.display = 'block';
                barterValueTLGroup.style.display = 'block';
                collectionAmountCurrencyRow.style.display = 'none';
                collectionExchangeRateRow.style.display = 'none';

            }
        });

        // Tahsilat Ekle
        collectionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentProjectId) {
                showSystemMessage('Lütfen önce projeyi kaydedin.', true);
                return;
            }
            if (!currentUserId) { // Ek kontrol
                showSystemMessage('Lütfen önce giriş yapın.', true);
                console.error("Collection save failed: currentUserId is null."); // LOG
                return;
            }

            const collectionType = collectionTypeSelect.value;
            const collectionDescription = collectionDescriptionInput.value;
            const collectionDate = collectionDateInput.value;

            let collectionAmount, collectionCurrency, collectionExchangeRate, collectionAmountTL;
            let checkNumber, checkDueDate, barterAsset, barterValueTL;

            if (collectionType === 'Barter') {
                barterAsset = barterAssetInput.value;
                barterValueTL = parseFloat(barterValueTLInput.value);
                collectionAmount = barterValueTL;
                collectionCurrency = 'TL';
                collectionExchangeRate = 1;
                collectionAmountTL = barterValueTL;

            } else {
                collectionAmount = parseFloat(collectionAmountInput.value);
                collectionCurrency = collectionCurrencySelect.value;
                collectionExchangeRate = parseFloat(collectionExchangeRateInput.value);
                collectionAmountTL = (isNaN(collectionAmount) ? 0 : collectionAmount) * (isNaN(collectionExchangeRate) ? 1 : collectionExchangeRate);

                if (collectionType === 'Çek' || collectionType === 'Senet') {
                    checkNumber = checkNumberInput.value;
                    checkDueDate = checkDueDateInput.value;
                }
            }
            
            const collectionData = {
                type: collectionType,
                description: collectionDescription,
                date: collectionDate,
                amount: collectionAmount,
                currency: collectionCurrency,
                exchangeRate: collectionExchangeRate,
                amountTL: collectionAmountTL,
                checkNumber: checkNumber || null,
                checkDueDate: checkDueDate || null,
                barterAsset: barterAsset || null,
                barterValueTL: barterValueTL || null,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            const collectionCollectionRef = db.collection('users').doc(currentUserId).collection('projects').doc(currentProjectId).collection('collections');
            console.log("Attempting to add collection to path:", collectionCollectionRef.path); // LOG

            try {
                await collectionCollectionRef.add(collectionData);
                showSystemMessage('Tahsilat başarıyla eklendi!');
                console.log("Collection added successfully."); // LOG
                collectionForm.reset();
                collectionExchangeRateInput.value = 1;
                collectionTypeSelect.dispatchEvent(new Event('change'));
                loadCollections(currentProjectId);
            } catch (error) {
                console.error("Tahsilat eklenirken hata oluştu: ", error); // LOG
                showSystemMessage('Tahsilat eklenirken hata oluştu: ' + error.message, true);
            }
        });

        // Tahsilatları Yükle
        async function loadCollections(projectId) {
            collectionsTableBody.innerHTML = '<tr><td colspan="9" style="text-align:center;">Tahsilatlar yükleniyor...</td></tr>';
            if (!currentUserId || !projectId) { // Ek kontrol
                console.warn("loadCollections: currentUserId or projectId is null. Skipping load."); // LOG
                collectionsTableBody.innerHTML = '<tr><td colspan="9" style="text-align:center;">Tahsilatlar yüklenemedi (Kullanıcı/Proje bilgisi eksik).</td></tr>';
                return;
            }
            const collectionCollectionRef = db.collection('users').doc(currentUserId).collection('projects').doc(projectId).collection('collections');
            console.log("Attempting to load collections from path:", collectionCollectionRef.path); // LOG

            try {
                const snapshot = await collectionCollectionRef.orderBy('date', 'desc').get();
                if (snapshot.empty) {
                    collectionsTableBody.innerHTML = '<tr><td colspan="9" style="text-align:center;">Henüz tahsilat eklenmedi.</td></tr>';
                    console.log("No collections found for project:", projectId); // LOG
                    return;
                }

                collectionsTableBody.innerHTML = '';
                snapshot.forEach(doc => {
                    const collection = doc.data();
                    const row = collectionsTableBody.insertRow();
                    row.insertCell(0).textContent = collection.date || 'N/A';
                    row.insertCell(1).textContent = collection.type || '';
                    row.insertCell(2).textContent = collection.description || '';
                    row.insertCell(3).textContent = collection.checkDueDate || collection.barterAsset || 'N/A';
                    
                    if (collection.type === 'Barter') {
                        row.insertCell(4).textContent = 'N/A';
                        row.insertCell(5).textContent = 'N/A';
                        row.insertCell(6).textContent = 'N/A';
                    } else {
                        row.insertCell(4).textContent = collection.amount.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                        row.insertCell(5).textContent = collection.currency || 'TL';
                        row.insertCell(6).textContent = collection.exchangeRate.toLocaleString('tr-TR', { minimumFractionDigits: 4, maximumFractionDigits: 4 });
                    }
                    
                    row.insertCell(7).textContent = collection.amountTL.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' });

                    const actionsCell = row.insertCell(8);
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Sil';
                    deleteButton.classList.add('delete-btn');
                    deleteButton.addEventListener('click', async () => {
                        if (confirm('Bu tahsilatı silmek istediğinizden emin misiniz?')) {
                            if (!currentUserId) {
                                showSystemMessage('Lütfen önce giriş yapın.', true);
                                return;
                            }
                            console.log("Attempting to delete collection:", doc.id, "from path:", collectionCollectionRef.doc(doc.id).path); // LOG
                            try {
                                await collectionCollectionRef.doc(doc.id).delete();
                                showSystemMessage('Tahsilat başarıyla silindi.');
                                console.log("Collection", doc.id, "deleted successfully."); // LOG
                                loadCollections(projectId);
                            } catch (error) {
                                console.error("Tahsilat silinirken hata oluştu: ", error); // LOG
                                showSystemMessage('Tahsilat silinirken hata oluştu: ' + error.message, true);
                            }
                        }
                    });
                    actionsCell.appendChild(deleteButton);
                    actionsCell.style.textAlign = 'center';
                });
                console.log("Collections loaded successfully for project:", projectId); // LOG
            } catch (error) {
                console.error("Tahsilatlar yüklenirken hata oluştu: ", error); // LOG
                showSystemMessage('Tahsilatlar yüklenirken hata oluştu: ' + error.message, true);
            }
        }

        // Sistem mesajı gösterme fonksiyonu
        function showSystemMessage(message, isError = false) {
            systemMessageDiv.textContent = message;
            systemMessageDiv.className = 'message';
            if (isError) {
                systemMessageDiv.classList.add('error-message');
            } else {
                systemMessageDiv.classList.add('success');
            }
            systemMessageDiv.classList.add('show');
            setTimeout(() => {
                systemMessageDiv.classList.remove('show');
            }, 5000);
        }

        // Sayfa yüklendiğinde bir kez çalıştır
        collectionTypeSelect.dispatchEvent(new Event('change'));
    </script>
</body>
</html>
