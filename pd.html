<!DOCTYPE html>
<html lang="tr">
<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Proje Detayları</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5; /* Açık gri arka plan */
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #ffffff; /* Beyaz kart arka planı */
            padding: 30px;
            border-radius: 10px; /* Köşeleri yuvarlak */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* Hafif gölge */
            box-sizing: border-box; /* Padding dahil genişlik hesaplama */
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        h1 {
            color: #2c3e50;
            font-size: 2.2em;
            margin: 0;
            font-weight: 700;
        }
        .user-info {
            font-size: 0.9em;
            color: #555;
            margin-right: 15px;
        }
        .logout-button, .back-button {
            background-color: #e74c3c; /* Kırmızı tonu */
            color: white;
            padding: 10px 18px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
            text-decoration: none;
            display: inline-block; /* Yan yana durmaları için */
            margin-left: 10px; /* Butonlar arası boşluk */
        }
        .logout-button:hover, .back-button:hover {
            background-color: #c0392b;
        }
        .section-title {
            color: #34495e;
            font-size: 1.6em;
            margin-top: 30px;
            margin-bottom: 20px;
            border-bottom: 2px solid #3498db; /* Mavi alt çizgi */
            padding-bottom: 10px;
            font-weight: 600;
        }
        .form-section, .data-section {
            background-color: #f9f9f9;
            padding: 25px;
            border-radius: 8px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .form-group {
            margin-bottom: 18px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }
        .form-group input[type="text"],
        .form-group input[type="date"],
        .form-group input[type="number"],
        .form-group textarea,
        .form-group select {
            width: calc(100% - 22px); /* Padding için ayarlama */
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
            color: #333;
            box-sizing: border-box; /* Padding dahil genişlik hesaplama */
        }
        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }
        .button-group {
            display: flex;
            gap: 15px; /* Butonlar arasında boşluk */
            margin-top: 25px;
        }
        .button-group button {
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: background-color 0.3s ease;
        }
        .button-group button.save-button {
            background-color: #28a745; /* Yeşil tonu */
            color: white;
        }
        .button-group button.save-button:hover {
            background-color: #218838;
        }
        .button-group button.delete-button {
            background-color: #dc3545; /* Kırmızı tonu */
            color: white;
        }
        .button-group button.delete-button:hover {
            background-color: #c82333;
        }
        .button-group button.add-button {
            background-color: #007bff; /* Mavi tonu */
            color: white;
        }
        .button-group button.add-button:hover {
            background-color: #0056b3;
        }
        .financial-summary {
            background-color: #ecf0f1; /* Açık gri */
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #dcdcdc;
        }
        .summary-item:last-child {
            border-bottom: none;
        }
        .summary-item strong {
            color: #34495e;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 0.95em;
        }
        .data-table th, .data-table td {
            border: 1px solid #e0e0e0;
            padding: 12px;
            text-align: left;
        }
        .data-table th {
            background-color: #3498db; /* Mavi başlık */
            color: white;
            font-weight: 600;
            white-space: nowrap; /* Başlıkların tek satırda kalması için */
        }
        .data-table tr:nth-child(even) {
            background-color: #f8f8f8; /* Her ikinci satır açık gri */
        }
        .data-table tr:hover {
            background-color: #f0f0f0; /* Üzerine gelince daha koyu gri */
        }
        .data-table .action-buttons button {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            transition: background-color 0.2s ease;
        }
        .data-table .action-buttons button:hover {
            background-color: #c0392b;
        }
        .message {
            padding: 12px;
            margin-bottom: 20px;
            border-radius: 5px;
            font-weight: 500;
            display: none; /* Varsayılan olarak gizli */
        }
        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
            display: none; /* Varsayılan olarak gizli */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .currency-input-group {
            display: flex;
            align-items: center;
            gap: 10px; /* Input ve select arası boşluk */
        }
        .currency-input-group input[type="text"],
        .currency-input-group select {
            flex-grow: 1; /* Input'un genişlemesini sağlar */
        }
        .currency-input-group select {
            width: auto; /* Select'in içeriğine göre genişlemesini sağlar */
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 1em;
            color: #333;
        }

    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1 id="pageTitle">Proje Detayları</h1>
            <div>
                <span class="user-info">Hoş geldin, <span id="userEmail"></span>!</span>
                <a href="index.html" class="back-button">Ana Sayfaya Dön</a>
                <button id="logoutButton" class="logout-button">Çıkış Yap</button>
            </div>
        </header>

        <div class="message" id="systemMessage"></div>
        <div class="loading-spinner" id="loadingSpinner"></div>

        <h2 class="section-title">Proje Bilgileri</h2>
        <div class="form-section">
            <div class="form-group">
                <label for="projectName">Proje Adı:</label>
                <input type="text" id="projectName" readonly>
            </div>
            <div class="form-group">
                <label for="projectCategory">Kategori:</label>
                <input type="text" id="projectCategory" readonly>
            </div>
            <div class="form-group">
                <label for="startDate">Başlangıç Tarihi:</label>
                <input type="date" id="startDate" readonly>
            </div>
            <div class="form-group">
                <label for="endDate">Bitiş Tarihi:</label>
                <input type="date" id="endDate" readonly>
            </div>
             <div class="form-group">
                <label for="contractAmount">Sözleşme Bedeli:</label>
                <div class="currency-input-group">
                    <input type="text" id="contractAmount" placeholder="Sözleşme Bedeli">
                    <select id="contractCurrency">
                        <option value="TRY">TL</option>
                        <option value="USD">USD</option>
                        <option value="EUR">EUR</option>
                    </select>
                </div>
            </div>
             <div class="form-group">
                <label for="projectStatus">Proje Durumu:</label>
                <select id="projectStatus">
                    <option value="Devam Ediyor">Devam Ediyor</option>
                    <option value="Tamamlandı">Tamamlandı</option>
                    <option value="İptal Edildi">İptal Edildi</option>
                    <option value="Beklemede">Beklemede</option>
                </select>
            </div>
            <div class="form-group">
                <label for="projectDescription">Açıklama:</label>
                <textarea id="projectDescription"></textarea>
            </div>
            <div class="button-group">
                <button id="saveProjectButton" class="save-button">Değişiklikleri Kaydet</button>
                <button id="deleteProjectButton" class="delete-button">Projeyi Sil</button>
            </div>
        </div>

        <h2 class="section-title">Finansal Özet (TL Karşılığı)</h2>
        <div class="financial-summary">
            <div class="summary-item">
                <strong>Toplam Harcama:</strong> <span id="totalExpenseSummary">0,00 TL</span>
            </div>
            <div class="summary-item">
                <strong>Toplam Tahsilat:</strong> <span id="totalCollectionSummary">0,00 TL</span>
            </div>
            <div class="summary-item">
                <strong>Proje Kâr/Zarar:</strong> <span id="profitLossSummary">0,00 TL</span>
            </div>
            <div class="summary-item">
                <strong>Kalan Sözleşme Bedeli:</strong> <span id="remainingContractAmountSummary">0,00 TL</span>
            </div>
        </div>

        <h2 class="section-title">Harcamalar</h2>
        <div class="form-section">
            <div class="form-group">
                <label for="expenseDate">Tarih:</label>
                <input type="date" id="expenseDate">
            </div>
            <div class="form-group">
                <label for="expenseDescription">Açıklama:</label>
                <input type="text" id="expenseDescription" placeholder="Harcama Açıklaması">
            </div>
            <div class="form-group">
                <label for="expenseAmount">Miktar:</label>
                <input type="text" id="expenseAmount" placeholder="0,00">
            </div>
             <div class="form-group">
                <label for="expenseCurrency">Para Birimi:</label>
                <select id="expenseCurrency">
                    <option value="TRY">TL</option>
                    <option value="USD">USD</option>
                    <option value="EUR">EUR</option>
                </select>
            </div>
             <div class="form-group" id="expenseExchangeRateGroup">
                <label for="expenseExchangeRate">Kur (TL/X):</label>
                <input type="text" id="expenseExchangeRate" placeholder="1,00">
            </div>
            <div class="button-group">
                <button id="addExpenseButton" class="add-button">Harcama Ekle</button>
            </div>
        </div>

        <div class="data-section">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Tarih</th>
                        <th>Açıklama</th>
                        <th>Miktar</th>
                        <th>Para Birimi</th>
                        <th>Kur (TL/X)</th>
                        <th>TL Karşılığı</th>
                        <th>İşlemler</th>
                    </tr>
                </thead>
                <tbody id="expensesTableBody">
                    </tbody>
            </table>
        </div>

        <h2 class="section-title">Tahsilatlar</h2>
        <div class="form-section">
            <div class="form-group">
                <label for="collectionDate">Tarih:</label>
                <input type="date" id="collectionDate">
            </div>
            <div class="form-group">
                <label for="collectionDescription">Açıklama:</label>
                <input type="text" id="collectionDescription" placeholder="Tahsilat Açıklaması">
            </div>
            <div class="form-group">
                <label for="collectionAmount">Miktar:</label>
                <input type="text" id="collectionAmount" placeholder="0,00">
            </div>
             <div class="form-group">
                <label for="collectionCurrency">Para Birimi:</label>
                <select id="collectionCurrency">
                    <option value="TRY">TL</option>
                    <option value="USD">USD</option>
                    <option value="EUR">EUR</option>
                </select>
            </div>
             <div class="form-group" id="collectionExchangeRateGroup">
                <label for="collectionExchangeRate">Kur (TL/X):</label>
                <input type="text" id="collectionExchangeRate" placeholder="1,00">
            </div>
            <div class="form-group">
                <label for="collectionType">Tahsilat Tipi:</label>
                <select id="collectionType">
                    <option value="">Seçiniz</option>
                    <option value="Çek">Çek</option>
                    <option value="Nakit">Nakit</option>
                    <option value="Havale/EFT">Havale/EFT</option>
                    <option value="Barter">Barter</option>
                </select>
            </div>
            <div class="form-group" id="checkDetailsDiv" style="display: none;">
                <label for="checkNo">Çek No:</label>
                <input type="text" id="checkNo" placeholder="Çek Numarası">
                <label for="checkDate">Çek Vadesi:</label>
                <input type="date" id="checkDate">
            </div>
            <div class="form-group" id="barterDetailsDiv" style="display: none;">
                <label for="barterDescription">Barter Açıklaması:</label>
                <textarea id="barterDescription" placeholder="Barter detaylarını giriniz"></textarea>
            </div>
            <div class="button-group">
                <button id="addCollectionButton" class="add-button">Tahsilat Ekle</button>
            </div>
        </div>

        <div class="data-section">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Tarih</th>
                        <th>Açıklama</th>
                        <th>Miktar</th>
                        <th>Para Birimi</th>
                        <th>Kur (TL/X)</th>
                        <th>TL Karşılığı</th>
                        <th>Tip</th>
                        <th>Çek No</th>
                        <th>Çek Vadesi</th>
                        <th>Barter Açıklaması</th>
                        <th>İşlemler</th>
                    </tr>
                </thead>
                <tbody id="collectionsTableBody">
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        // Firebase konfigürasyonunuz buraya gelecek (daha önce eklemiş olmanız gerekiyor)
        const firebaseConfig = {
            apiKey: "AIzaSyBNwSpbpNuQQ4nTjDAlB6izu5IgkEZxDL0",
            authDomain: "projetakip-e3a75.firebaseapp.com",
            projectId: "projetakip-e3a75",
            storageBucket: "projetakip-e3a75.firebasestorage.app",
            messagingSenderId: "924120275674",
            appId: "1:924120275674:web:c8ad3d4c998333d9fd23e3"
        };

        // Firebase'i başlat
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        } else {
            firebase.app(); // if already initialized, use that one
        }

        const auth = firebase.auth();
        const db = firebase.firestore();

        // HTML elementlerini al
        const userEmailSpan = document.getElementById('userEmail');
        const logoutButton = document.getElementById('logoutButton');
        const systemMessageDiv = document.getElementById('systemMessage');
        const loadingSpinner = document.getElementById('loadingSpinner');

        // Proje Bilgileri
        const projectNameInput = document.getElementById('projectName');
        const projectCategoryInput = document.getElementById('projectCategory');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const contractAmountInput = document.getElementById('contractAmount');
        const contractCurrencySelect = document.getElementById('contractCurrency'); // Yeni: Sözleşme para birimi
        const projectStatusSelect = document.getElementById('projectStatus');
        const projectDescriptionTextarea = document.getElementById('projectDescription');
        const saveProjectButton = document.getElementById('saveProjectButton');
        const deleteProjectButton = document.getElementById('deleteProjectButton');

        // Finansal Özet
        const totalExpenseSummary = document.getElementById('totalExpenseSummary');
        const totalCollectionSummary = document.getElementById('totalCollectionSummary');
        const profitLossSummary = document.getElementById('profitLossSummary');
        const remainingContractAmountSummary = document.getElementById('remainingContractAmountSummary');

        // Harcamalar
        const expenseDateInput = document.getElementById('expenseDate');
        const expenseDescriptionInput = document.getElementById('expenseDescription');
        const expenseAmountInput = document.getElementById('expenseAmount');
        const expenseCurrencySelect = document.getElementById('expenseCurrency');
        const expenseExchangeRateInput = document.getElementById('expenseExchangeRate');
        const expenseExchangeRateGroup = document.getElementById('expenseExchangeRateGroup');
        const addExpenseButton = document.getElementById('addExpenseButton');
        const expensesTableBody = document.getElementById('expensesTableBody');

        // Tahsilatlar
        const collectionDateInput = document.getElementById('collectionDate');
        const collectionDescriptionInput = document.getElementById('collectionDescription');
        const collectionAmountInput = document.getElementById('collectionAmount');
        const collectionCurrencySelect = document.getElementById('collectionCurrency');
        const collectionExchangeRateInput = document.getElementById('collectionExchangeRate');
        const collectionExchangeRateGroup = document.getElementById('collectionExchangeRateGroup');
        const collectionTypeSelect = document.getElementById('collectionType');
        const checkDetailsDiv = document.getElementById('checkDetailsDiv');
        const checkNoInput = document.getElementById('checkNo');
        const checkDateInput = document.getElementById('checkDate');
        const barterDetailsDiv = document.getElementById('barterDetailsDiv');
        const barterDescriptionTextarea = document.getElementById('barterDescription');
        const addCollectionButton = document.getElementById('addCollectionButton');
        const collectionsTableBody = document.getElementById('collectionsTableBody');

        let currentProjectId = null;
        let exchangeRates = {}; // Kur bilgilerini saklamak için

        // Helper functions for UI
        function showSystemMessage(message, isError = false) {
            systemMessageDiv.textContent = message;
            systemMessageDiv.className = `message ${isError ? 'error' : 'success'}`;
            systemMessageDiv.style.display = 'block';
            setTimeout(() => {
                systemMessageDiv.style.display = 'none';
            }, 5000);
        }

        function showLoadingSpinner() {
            loadingSpinner.style.display = 'block';
        }

        function hideLoadingSpinner() {
            loadingSpinner.style.display = 'none';
        }

        // --- Yeni Ekleme: Sayı Formatlama Fonksiyonu ---
        function formatNumberInput(inputElement) {
            inputElement.addEventListener('input', (e) => {
                let value = e.target.value.replace(/[^0-9,.]/g, ''); // Sadece rakam, virgül ve nokta kalsın
                value = value.replace(/,/g, '.'); // Virgülü noktaya çevir (işlem kolaylığı için)

                // Birden fazla nokta varsa ilkini tut, diğerlerini sil
                const parts = value.split('.');
                if (parts.length > 2) {
                    value = parts[0] + '.' + parts.slice(1).join('');
                }

                if (value === '' || value === '.') {
                    e.target.value = ''; // Boş veya sadece nokta ise boş bırak
                    return;
                }

                let num = parseFloat(value);
                if (isNaN(num)) {
                    e.target.value = '';
                    return;
                }

                // Sayıyı formatla (örneğin 1.234,56 veya 1,234.56)
                // Türk locale'i için: binlik ayıracı nokta, ondalık ayıracı virgül
                // İngiliz/Amerikan locale'i için: binlik ayıracı virgül, ondalık ayıracı nokta
                
                // Noktadan sonraki kısmı koru
                const decimalPart = value.includes('.') ? value.substring(value.indexOf('.') + 1) : '';
                const integerPart = value.includes('.') ? value.substring(0, value.indexOf('.')) : value;

                const formattedInteger = parseInt(integerPart).toLocaleString('tr-TR', { maximumFractionDigits: 0 });

                if (value.includes('.')) {
                    e.target.value = formattedInteger + ',' + decimalPart;
                } else {
                    e.target.value = formattedInteger;
                }
            });

            // Odak dışına çıkıldığında kuruş basamaklarını tamamla (örn: 123 -> 123,00)
            inputElement.addEventListener('blur', (e) => {
                let value = e.target.value.replace(/[^0-9,.]/g, '');
                value = value.replace(/,/g, '.'); // Virgülü noktaya çevir

                if (value === '' || isNaN(parseFloat(value))) {
                    e.target.value = '0,00'; // Boşsa veya sayı değilse 0,00 yap
                    return;
                }

                let num = parseFloat(value);
                e.target.value = num.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            });
        }

        // --- Inputlara formatlama fonksiyonunu uygula ---
        formatNumberInput(contractAmountInput);
        formatNumberInput(expenseAmountInput);
        formatNumberInput(expenseExchangeRateInput); // Manuel kur girişi için
        formatNumberInput(collectionAmountInput);
        formatNumberInput(collectionExchangeRateInput); // Manuel kur girişi için

        // --- Para birimi seçimi değiştiğinde kur alanı görünürlüğü ve varsayılan değerleri ---
        expenseCurrencySelect.addEventListener('change', () => {
            if (expenseCurrencySelect.value === 'TRY') {
                expenseExchangeRateGroup.style.display = 'none';
                expenseExchangeRateInput.value = '1,00';
            } else {
                expenseExchangeRateGroup.style.display = 'block';
                // Kur bilgisini çek
                fetchExchangeRateForInput(expenseExchangeRateInput, expenseCurrencySelect.value);
            }
        });

        collectionCurrencySelect.addEventListener('change', () => {
            if (collectionCurrencySelect.value === 'TRY') {
                collectionExchangeRateGroup.style.display = 'none';
                collectionExchangeRateInput.value = '1,00';
            } else {
                collectionExchangeRateGroup.style.display = 'block';
                // Kur bilgisini çek
                fetchExchangeRateForInput(collectionExchangeRateInput, collectionCurrencySelect.value);
            }
        });
        // --- Bitiş: Sayı Formatlama ve Kur Görünürlüğü ---


        // Authentication state observer
        auth.onAuthStateChanged(user => {
            if (user) {
                userEmailSpan.textContent = user.email;
                const urlParams = new URLSearchParams(window.location.search);
                currentProjectId = urlParams.get('id');

                if (currentProjectId) {
                    loadProjectDetails(currentProjectId);
                    loadFinancialData(currentProjectId);
                } else {
                    showSystemMessage('Proje ID bulunamadı.', true);
                    window.location.href = 'index.html';
                }
            } else {
                window.location.href = 'auth.html';
            }
        });

        // Logout
        logoutButton.addEventListener('click', () => {
            auth.signOut().then(() => {
                showSystemMessage('Başarıyla çıkış yapıldı.');
            }).catch(error => {
                showSystemMessage('Çıkış yapılırken hata oluştu: ' + error.message, true);
            });
        });

        // Fetch exchange rates from Cloud Function
        async function fetchTCMBRates(date) {
            showSystemMessage('Döviz kuru çekiliyor...', false);
            try {
                // Cloud Function'ınızın gerçek URL'si
                const cloudFunctionUrl = `https://us-central1-projetakip-e3a75.cloudfunctions.net/getExchangeRate?date=${date}`;
                console.log("Cloud Function URL:", cloudFunctionUrl); // Hata ayıklama için

                const response = await fetch(cloudFunctionUrl, {
                    method: 'GET', // GET metodu kullanılıyor
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Cloud Function'dan kur bilgisi alınamadı. Durum: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                console.log("Çekilen kur verisi:", data);
                showSystemMessage('Döviz kuru başarıyla çekildi.');
                return data.rates; // Fonksiyonun rates objesini döndürdüğünü varsayıyoruz
            } catch (error) {
                console.error('Döviz kur çekme hatası (Cloud Function):', error);
                showSystemMessage('Döviz kur çekme hatası (Cloud Function): ' + error.message, true);
                return null;
            } finally {
                 // showSystemMessage'in kendi zamanlayıcısı var, burada özel bir işlem gerekmez.
            }
        }

        // Input için kur bilgisini çeken ve atayan yardımcı fonksiyon
        async function fetchExchangeRateForInput(inputElement, currencyCode) {
            const date = new Date(expenseDateInput.value || collectionDateInput.value || new Date()); // Harcama veya tahsilat tarihini kullan
            const formattedDate = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;

            if (!exchangeRates[formattedDate]) {
                exchangeRates[formattedDate] = await fetchTCMBRates(formattedDate);
            }

            if (exchangeRates[formattedDate] && exchangeRates[formattedDate][currencyCode]) {
                const rate = exchangeRates[formattedDate][currencyCode];
                inputElement.value = rate.toLocaleString('tr-TR', { minimumFractionDigits: 4, maximumFractionDigits: 4 }); // Daha hassas kur gösterimi
            } else {
                showSystemMessage(`Kur (${currencyCode}): Kur bulunamadı`, true);
                inputElement.value = '1,00'; // Kur bulunamazsa varsayılan 1,00
            }
        }


        // Proje Detaylarını Yükle
        async function loadProjectDetails(projectId) {
            showLoadingSpinner();
            try {
                const doc = await db.collection('projects').doc(projectId).get();
                if (doc.exists) {
                    const data = doc.data();
                    projectNameInput.value = data.name;
                    projectCategoryInput.value = data.category;
                    startDateInput.value = data.startDate;
                    endDateInput.value = data.endDate;
                    
                    // Sözleşme Bedeli ve Para Birimi
                    contractAmountInput.value = parseFloat(data.contractAmount || 0).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                    contractCurrencySelect.value = data.contractCurrency || 'TRY'; // Varsayılan TRY

                    projectStatusSelect.value = data.status;
                    projectDescriptionTextarea.value = data.description || '';
                    document.getElementById('pageTitle').textContent = `Proje Detayları - ${data.name}`;
                } else {
                    showSystemMessage('Proje bulunamadı.', true);
                    window.location.href = 'index.html';
                }
            } catch (error) {
                console.error('Proje detayları yüklenirken hata:', error);
                showSystemMessage('Proje detayları yüklenirken bir hata oluştu: ' + error.message, true);
            } finally {
                hideLoadingSpinner();
            }
        }

        // Proje Değişikliklerini Kaydet
        saveProjectButton.addEventListener('click', async () => {
            showLoadingSpinner();
            try {
                // Sayı formatından temizleyip düz sayıya çevir
                const cleanContractAmount = parseFloat(contractAmountInput.value.replace(/\./g, '').replace(/,/g, '.'));
                
                await db.collection('projects').doc(currentProjectId).update({
                    name: projectNameInput.value,
                    category: projectCategoryInput.value,
                    startDate: startDateInput.value,
                    endDate: endDateInput.value,
                    contractAmount: cleanContractAmount, // Temizlenmiş sayısal değer
                    contractCurrency: contractCurrencySelect.value, // Yeni: Para birimi
                    status: projectStatusSelect.value,
                    description: projectDescriptionTextarea.value
                });
                showSystemMessage('Proje başarıyla güncellendi!');
            } catch (error) {
                console.error('Proje güncellenirken hata:', error);
                showSystemMessage('Proje güncellenirken bir hata oluştu: ' + error.message, true);
            } finally {
                hideLoadingSpinner();
            }
        });

        // Projeyi Sil
        deleteProjectButton.addEventListener('click', async () => {
            if (confirm('Bu projeyi ve tüm finansal kayıtlarını kalıcı olarak silmek istediğinizden emin misiniz?')) {
                showLoadingSpinner();
                try {
                    // Önce alt koleksiyonları (harcamalar, tahsilatlar) silmek gerekebilir
                    // Firebase Cloud Functions kullanarak bu işlemi daha güvenli ve otomatik yapabilirsiniz.
                    // Şimdilik sadece ana projeyi siliyoruz, alt koleksiyonlar orphaned kalabilir.
                    await db.collection('projects').doc(currentProjectId).delete();
                    showSystemMessage('Proje başarıyla silindi!');
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1500);
                } catch (error) {
                    console.error('Proje silinirken hata:', error);
                    showSystemMessage('Proje silinirken bir hata oluştu: ' + error.message, true);
                } finally {
                    hideLoadingSpinner();
                }
            }
        });


        // Harcamaları ve Tahsilatları Yükle
        async function loadFinancialData(projectId) {
            showLoadingSpinner();
            try {
                let totalExpenseTRY = 0;
                let totalCollectionTRY = 0;

                // Harcamaları yükle
                const expensesSnapshot = await db.collection('projects').doc(projectId).collection('expenses').orderBy('date', 'desc').get();
                expensesTableBody.innerHTML = ''; // Tabloyu temizle
                expensesSnapshot.forEach(doc => {
                    const data = doc.data();
                    const expenseTRY = (parseFloat(data.amount) * parseFloat(data.exchangeRate));
                    totalExpenseTRY += expenseTRY;

                    const row = expensesTableBody.insertRow();
                    row.innerHTML = `
                        <td>${data.date}</td>
                        <td>${data.description}</td>
                        <td>${parseFloat(data.amount).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        <td>${data.currency}</td>
                        <td>${parseFloat(data.exchangeRate).toLocaleString('tr-TR', { minimumFractionDigits: 4, maximumFractionDigits: 4 })}</td>
                        <td>${expenseTRY.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY', minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        <td class="action-buttons">
                            <button onclick="deleteFinancialItem('expenses', '${doc.id}', '${data.description}')">Sil</button>
                        </td>
                    `;
                });

                // Tahsilatları yükle
                const collectionsSnapshot = await db.collection('projects').doc(projectId).collection('collections').orderBy('date', 'desc').get();
                collectionsTableBody.innerHTML = ''; // Tabloyu temizle
                collectionsSnapshot.forEach(doc => {
                    const data = doc.data();
                    const collectionTRY = (parseFloat(data.amount) * parseFloat(data.exchangeRate));
                    totalCollectionTRY += collectionTRY;

                    const row = collectionsTableBody.insertRow();
                    row.innerHTML = `
                        <td>${data.date}</td>
                        <td>${data.description}</td>
                        <td>${parseFloat(data.amount).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        <td>${data.currency}</td>
                        <td>${parseFloat(data.exchangeRate).toLocaleString('tr-TR', { minimumFractionDigits: 4, maximumFractionDigits: 4 })}</td>
                        <td>${collectionTRY.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY', minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                        <td>${data.type || ''}</td>
                        <td>${data.checkNo || ''}</td>
                        <td>${data.checkDate || ''}</td>
                        <td>${data.barterDescription || ''}</td>
                        <td class="action-buttons">
                            <button onclick="deleteFinancialItem('collections', '${doc.id}', '${data.description}')">Sil</button>
                        </td>
                    `;
                });

                // Özetleri güncelle
                const projectDoc = await db.collection('projects').doc(projectId).get();
                const projectData = projectDoc.data();
                const contractAmount = parseFloat(projectData.contractAmount || 0);
                const contractCurrency = projectData.contractCurrency || 'TRY';
                let contractAmountInTRY = contractAmount;

                // Sözleşme bedelini TL'ye çevir (eğer farklı bir kurda ise)
                if (contractCurrency !== 'TRY') {
                    const today = new Date();
                    const formattedToday = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
                    if (!exchangeRates[formattedToday]) {
                         exchangeRates[formattedToday] = await fetchTCMBRates(formattedToday);
                    }

                    if (exchangeRates[formattedToday] && exchangeRates[formattedToday][contractCurrency]) {
                        contractAmountInTRY = contractAmount * exchangeRates[formattedToday][contractCurrency];
                    } else {
                        showSystemMessage(`Bugünün (${formattedToday}) ${contractCurrency} kuru bulunamadı, sözleşme bedeli TL'ye çevrilemedi.`, true);
                        // Kur bulunamazsa, olduğu gibi bırak veya bir uyarı ver
                    }
                }
                
                const profitLoss = totalCollectionTRY - totalExpenseTRY;
                const remainingContractAmount = contractAmountInTRY - totalCollectionTRY; // Kalan sözleşme bedeli

                totalExpenseSummary.textContent = totalExpenseTRY.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY', minimumFractionDigits: 2, maximumFractionDigits: 2 });
                totalCollectionSummary.textContent = totalCollectionTRY.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY', minimumFractionDigits: 2, maximumFractionDigits: 2 });
                profitLossSummary.textContent = profitLoss.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY', minimumFractionDigits: 2, maximumFractionDigits: 2 });
                remainingContractAmountSummary.textContent = remainingContractAmount.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY', minimumFractionDigits: 2, maximumFractionDigits: 2 });

            } catch (error) {
                console.error('Finansal veriler yüklenirken hata:', error);
                showSystemMessage('Finansal veriler yüklenirken bir hata oluştu: ' + error.message, true);
            } finally {
                hideLoadingSpinner();
            }
        }


        // Tahsilat tipi değiştikçe Çek/Barter alanlarını göster/gizle
        collectionTypeSelect.addEventListener('change', () => {
            checkDetailsDiv.style.display = 'none';
            barterDetailsDiv.style.display = 'none';
            if (collectionTypeSelect.value === 'Çek') {
                checkDetailsDiv.style.display = 'block';
            } else if (collectionTypeSelect.value === 'Barter') {
                barterDetailsDiv.style.display = 'block';
            }
        });

        // Harcama Ekle
        addExpenseButton.addEventListener('click', async () => {
            try {
                // Sayı formatından temizleyip düz sayıya çevir
                const cleanAmount = parseFloat(expenseAmountInput.value.replace(/\./g, '').replace(/,/g, '.'));
                const cleanExchangeRate = parseFloat(expenseExchangeRateInput.value.replace(/\./g, '').replace(/,/g, '.'));

                if (isNaN(cleanAmount) || cleanAmount <= 0) {
                    showSystemMessage('Geçerli bir harcama miktarı girin.', true);
                    return;
                }
                if (expenseCurrencySelect.value !== 'TRY' && (isNaN(cleanExchangeRate) || cleanExchangeRate <= 0)) {
                    showSystemMessage('Geçerli bir döviz kuru girin.', true);
                    return;
                }

                await db.collection('projects').doc(currentProjectId).collection('expenses').add({
                    date: expenseDateInput.value,
                    description: expenseDescriptionInput.value,
                    amount: cleanAmount,
                    currency: expenseCurrencySelect.value,
                    exchangeRate: expenseCurrencySelect.value === 'TRY' ? 1 : cleanExchangeRate, // TL ise kur 1
                    timestamp: firebase.firestore.FieldValue.serverTimestamp() // Sıralama için
                });
                showSystemMessage('Harcama başarıyla eklendi!');
                // Formu temizle
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                expenseDateInput.value = `${year}-${month}-${day}`;
                expenseDescriptionInput.value = '';
                expenseAmountInput.value = ''; // formatNumberInput tarafından 0,00 yapılacak
                expenseCurrencySelect.value = 'TRY';
                expenseExchangeRateInput.value = '1,00';
                expenseExchangeRateGroup.style.display = 'none';

                loadFinancialData(currentProjectId);

            } catch (error) {
                console.error('Harcama eklerken hata:', error);
                showSystemMessage('Harcama eklenirken bir hata oluştu: ' + error.message, true);
            }
        });

        // Tahsilat Ekle
        addCollectionButton.addEventListener('click', async () => {
            try {
                // Sayı formatından temizleyip düz sayıya çevir
                const cleanAmount = parseFloat(collectionAmountInput.value.replace(/\./g, '').replace(/,/g, '.'));
                const cleanExchangeRate = parseFloat(collectionExchangeRateInput.value.replace(/\./g, '').replace(/,/g, '.'));

                if (isNaN(cleanAmount) || cleanAmount <= 0) {
                    showSystemMessage('Geçerli bir tahsilat miktarı girin.', true);
                    return;
                }
                 if (collectionCurrencySelect.value !== 'TRY' && (isNaN(cleanExchangeRate) || cleanExchangeRate <= 0)) {
                    showSystemMessage('Geçerli bir döviz kuru girin.', true);
                    return;
                }

                const collectionData = {
                    date: collectionDateInput.value,
                    description: collectionDescriptionInput.value,
                    amount: cleanAmount,
                    currency: collectionCurrencySelect.value,
                    exchangeRate: collectionCurrencySelect.value === 'TRY' ? 1 : cleanExchangeRate, // TL ise kur 1
                    type: collectionTypeSelect.value,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };

                if (collectionTypeSelect.value === 'Çek') {
                    collectionData.checkNo = checkNoInput.value;
                    collectionData.checkDate = checkDateInput.value;
                } else if (collectionTypeSelect.value === 'Barter') {
                    collectionData.barterDescription = barterDescriptionTextarea.value;
                }

                await db.collection('projects').doc(currentProjectId).collection('collections').add(collectionData);
                showSystemMessage('Tahsilat başarıyla eklendi!');
                // Formu temizle
                const today = new Date();
                const year = today.getFullYear();
                const month = String(today.getMonth() + 1).padStart(2, '0');
                const day = String(today.getDate()).padStart(2, '0');
                collectionDateInput.value = `${year}-${month}-${day}`;
                collectionDescriptionInput.value = '';
                collectionAmountInput.value = ''; // formatNumberInput tarafından 0,00 yapılacak
                collectionCurrencySelect.value = 'TRY';
                collectionExchangeRateInput.value = '1,00';
                collectionExchangeRateGroup.style.display = 'none';
                collectionTypeSelect.value = '';
                checkDetailsDiv.style.display = 'none';
                barterDetailsDiv.style.display = 'none';

                loadFinancialData(currentProjectId);

            } catch (error) {
                console.error('Tahsilat eklerken hata:', error);
                showSystemMessage('Tahsilat eklenirken bir hata oluştu: ' + error.message, true);
            }
        });

        // Harcama veya Tahsilat silme fonksiyonu
        async function deleteFinancialItem(collectionName, docId, description) {
            if (confirm(`"${description}" kaydını silmek istediğinizden emin misiniz?`)) {
                try {
                    await db.collection('projects').doc(currentProjectId).collection(collectionName).doc(docId).delete();
                    showSystemMessage('Kayıt başarıyla silindi!');
                    loadFinancialData(currentProjectId); // Listeyi ve özetleri güncelle
                } catch (error) {
                    console.error('Kayıt silinirken hata:', error);
                    showSystemMessage('Kayıt silinirken bir hata oluştu: ' + error.message, true);
                }
            }
        }
        
        // Form yüklendiğinde bugünün tarihini ve varsayılanları ayarla
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const formattedDate = `${year}-${month}-${day}`;

            expenseDateInput.value = formattedDate;
            collectionDateInput.value = formattedDate;

            // Kur alanlarını varsayılan olarak gizle ve 1,00 yap
            expenseExchangeRateGroup.style.display = 'none';
            expenseExchangeRateInput.value = '1,00';
            
            collectionExchangeRateGroup.style.display = 'none';
            collectionExchangeRateInput.value = '1,00';
            
            // Başlangıçta tahsilat tipi seçili olmadığı için ilgili div'leri gizle
            checkDetailsDiv.style.display = 'none';
            barterDetailsDiv.style.display = 'none';
        });

    </script>
</body>
</html>
