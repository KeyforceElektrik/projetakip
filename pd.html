<!DOCTYPE html>
<html lang="tr">
<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Proje Detayları</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f2f5; /* Açık gri arka plan */
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 20px auto;
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }
        h1, h2, h3 {
            color: #2c3e50;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 18px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="date"],
        .form-group select,
        .form-group textarea {
            width: calc(100% - 22px);
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        .form-group input[type="text"]:focus,
        .form-group input[type="number"]:focus,
        .form-group input[type="date"]:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: #007bff;
            outline: none;
        }
        .button {
            display: inline-block;
            padding: 12px 25px;
            font-size: 16px;
            font-weight: 500;
            color: #fff;
            background-color: #007bff;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease;
            text-decoration: none;
            text-align: center;
        }
        .button:hover {
            background-color: #0056b3;
            transform: translateY(-1px);
        }
        .button.secondary {
            background-color: #6c757d;
            margin-left: 10px;
        }
        .button.secondary:hover {
            background-color: #5a6268;
        }
        .button.danger {
            background-color: #dc3545;
            margin-left: 10px;
        }
        .button.danger:hover {
            background-color: #c82333;
        }
        .button-group {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .summary-box {
            background-color: #e9f5ff; /* Açık mavi */
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .summary-box p {
            margin: 8px 0;
            font-size: 17px;
            color: #333;
        }
        .summary-box p strong {
            color: #0056b3;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: #fff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        tr:hover {
            background-color: #e2e6ea;
        }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 30px;
            margin-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }
        .section-header h2 {
            margin: 0;
            border-bottom: none;
            padding-bottom: 0;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 30px;
            border: 1px solid #888;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 30px;
            font-weight: bold;
            position: absolute;
            top: 15px;
            right: 25px;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .delete-button {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .delete-button:hover {
            background-color: #c82333;
        }
        .detail-group {
            margin-top: 15px;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background-color: #fdfdfd;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 id="projectNameHeader">Proje Adı Yükleniyor...</h1>

        <div class="button-group">
            <button class="button" onclick="openUpdateProjectModal()">Proje Bilgilerini Güncelle</button>
            <button class="button" onclick="openAddExpenseModal()">Harcama Ekle</button>
            <button class="button" onclick="openAddCollectionModal()">Tahsilat Ekle</button>
            <button class="button danger" id="deleteProjectButton">Projeyi Sil</button>
            <a href="index.html" class="button secondary">Proje Listesine Dön</a>
        </div>

        <div class="summary-box">
            <h2>Proje Özeti</h2>
            <p>Proje Adı: <strong id="projectSummaryName"></strong></p>
            <p>Proje Kodu: <strong id="projectSummaryCode"></strong></p>
            <p>Başlangıç Tarihi: <strong id="projectSummaryStartDate"></strong></p>
            <p>Bitiş Tarihi: <strong id="projectSummaryEndDate"></strong></p>
            <p>Sözleşme Bedeli: <strong id="projectSummaryContractAmount"></strong></p>
            <p>Açıklama: <strong id="projectSummaryDescription"></strong></p>
            <p>Toplam Harcama: <strong id="projectTotalExpenses">0,00 TL</strong></p>
            <p>Toplam Tahsilat: <strong id="projectTotalCollections">0,00 TL</strong></p>
            <p>Kalan Bakiye: <strong id="projectRemainingBalance">0,00 TL</strong></p>
        </div>

        <div class="section-header">
            <h2>Harcamalar</h2>
        </div>
        <table id="expenseTable">
            <thead>
                <tr>
                    <th>Tarih</th>
                    <th>Açıklama</th>
                    <th>Miktar</th>
                    <th>Para Birimi</th>
                    <th>Kur</th>
                    <th>TL Karşılığı</th>
                    <th>Tip</th> <th>İşlemler</th>
                </tr>
            </thead>
            <tbody id="expenseListBody">
                </tbody>
        </table>

        <div class="section-header">
            <h2>Tahsilatlar</h2>
        </div>
        <table id="collectionTable">
            <thead>
                <tr>
                    <th>Tarih</th>
                    <th>Açıklama</th>
                    <th>Miktar</th>
                    <th>Para Birimi</th>
                    <th>Kur</th>
                    <th>TL Karşılığı</th>
                    <th>Tahsilat Tipi</th>
                    <th>İşlemler</th>
                </tr>
            </thead>
            <tbody id="collectionListBody">
                </tbody>
        </table>

        <div id="updateProjectModal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeUpdateProjectModal()">&times;</span>
                <h2>Proje Bilgilerini Güncelle</h2>
                <form id="updateProjectForm">
                    <div class="form-group">
                        <label for="updateProjectName">Proje Adı:</label>
                        <input type="text" id="updateProjectName" required>
                    </div>
                    <div class="form-group">
                        <label for="updateProjectCode">Proje Kodu:</label>
                        <input type="text" id="updateProjectCode" required>
                    </div>
                    <div class="form-group">
                        <label for="updateStartDate">Başlangıç Tarihi:</label>
                        <input type="date" id="updateStartDate" required>
                    </div>
                    <div class="form-group">
                        <label for="updateEndDate">Bitiş Tarihi:</label>
                        <input type="date" id="updateEndDate" required>
                    </div>
                    <div class="form-group">
                        <label for="updateContractAmount">Sözleşme Bedeli:</label>
                        <input type="number" id="updateContractAmount" step="0.01" value="0" required>
                    </div>
                    <div class="form-group">
                        <label for="updateContractCurrency">Para Birimi:</label>
                        <select id="updateContractCurrency" required>
                            <option value="TRY">TL</option>
                            <option value="USD">USD</option>
                            <option value="EUR">EUR</option>
                        </select>
                    </div>
                    <div class="form-group" id="updateContractExchangeRateGroup">
                        <label for="updateContractExchangeRate">Kur (1 USD/EUR = ... TL):</label>
                        <input type="number" id="updateContractExchangeRate" step="0.0001" value="1" required>
                        <button type="button" id="fetchContractRateButton" class="button secondary" style="margin-top: 10px;">Güncel Kuru Çek</button>
                    </div>
                    <div class="form-group">
                        <label for="displayContractAmountTL">Sözleşme Bedeli (TL Karşılığı):</label>
                        <input type="text" id="displayContractAmountTL" readonly style="font-weight: bold; background-color: #e9ecef;">
                    </div>
                    <div class="form-group">
                        <label for="updateDescription">Açıklama:</label>
                        <textarea id="updateDescription" rows="4"></textarea>
                    </div>
                    <button type="submit" class="button">Güncelle</button>
                </form>
            </div>
        </div>

        <div id="addExpenseModal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeAddExpenseModal()">&times;</span>
                <h2>Harcama Ekle</h2>
                <form id="addExpenseForm">
                    <div class="form-group">
                        <label for="expenseDate">Tarih:</label>
                        <input type="date" id="expenseDate" required>
                    </div>
                    <div class="form-group">
                        <label for="expenseDescription">Açıklama:</label>
                        <input type="text" id="expenseDescription" required>
                    </div>
                    <div class="form-group">
                        <label for="expenseAmount">Miktar:</label>
                        <input type="number" id="expenseAmount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="expenseCurrency">Para Birimi:</label>
                        <select id="expenseCurrency" required>
                            <option value="TRY">TL</option>
                            <option value="USD">USD</option>
                            <option value="EUR">EUR</option>
                        </select>
                    </div>
                    <div class="form-group" id="expenseExchangeRateGroup">
                        <label for="expenseExchangeRate">Kur (1 USD/EUR = ... TL):</label>
                        <input type="number" id="expenseExchangeRate" step="0.0001" value="1" required>
                        <button type="button" id="fetchExpenseRateButton" class="button secondary" style="margin-top: 10px;">Güncel Kuru Çek</button>
                    </div>
                    <div class="form-group">
                        <label for="expenseType">Harcama Tipi:</label>
                        <select id="expenseType" required>
                            <option value="Nakit">Nakit</option>
                            <option value="Kredi Kartı">Kredi Kartı</option>
                            <option value="Havale/EFT">Havale/EFT</option>
                        </select>
                    </div>
                    <button type="submit" class="button">Harcamayı Kaydet</button>
                </form>
            </div>
        </div>

        <div id="addCollectionModal" class="modal">
            <div class="modal-content">
                <span class="close-button" onclick="closeAddCollectionModal()">&times;</span>
                <h2>Tahsilat Ekle</h2>
                <form id="addCollectionForm">
                    <div class="form-group">
                        <label for="collectionDate">Tarih:</label>
                        <input type="date" id="collectionDate" required>
                    </div>
                    <div class="form-group">
                        <label for="collectionDescription">Açıklama:</label>
                        <input type="text" id="collectionDescription" required>
                    </div>
                    <div class="form-group">
                        <label for="collectionAmount">Miktar:</label>
                        <input type="number" id="collectionAmount" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="collectionCurrency">Para Birimi:</label>
                        <select id="collectionCurrency" required>
                            <option value="TRY">TL</option>
                            <option value="USD">USD</option>
                            <option value="EUR">EUR</option>
                        </select>
                    </div>
                    <div class="form-group" id="collectionExchangeRateGroup">
                        <label for="collectionExchangeRate">Kur (1 USD/EUR = ... TL):</label>
                        <input type="number" id="collectionExchangeRate" step="0.0001" value="1" required>
                        <button type="button" id="fetchCollectionRateButton" class="button secondary" style="margin-top: 10px;">Güncel Kuru Çek</button>
                    </div>
                    <div class="form-group">
                        <label for="collectionType">Tahsilat Tipi:</label>
                        <select id="collectionType" required>
                            <option value="Nakit">Nakit</option>
                            <option value="Banka Havalesi">Banka Havalesi</option>
                            <option value="Çek">Çek</option>
                            <option value="Senet">Senet</option>
                            <option value="Barter">Barter</option>
                        </select>
                    </div>
                    <div id="checkDetailsDiv" class="detail-group">
                        <h3>Çek Bilgileri</h3>
                        <div class="form-group">
                            <label for="checkDate">Çek Tarihi:</label>
                            <input type="date" id="checkDate">
                        </div>
                        <div class="form-group">
                            <label for="checkNo">Çek No:</label>
                            <input type="text" id="checkNo">
                        </div>
                        <div class="form-group">
                            <label for="bankName">Banka Adı:</label>
                            <input type="text" id="bankName">
                        </div>
                    </div>
                    <div id="barterDetailsDiv" class="detail-group">
                        <h3>Barter Bilgileri</h3>
                        <div class="form-group">
                            <label for="barterDescription">Barter Açıklaması:</label>
                            <textarea id="barterDescription" rows="3"></textarea>
                        </div>
                    </div>
                    <button type="submit" class="button">Tahsilatı Kaydet</button>
                </form>
            </div>
        </div>
    </div>

    <script>
        // Firebase konfigürasyonunuzu buraya yapıştırın
        const firebaseConfig = {
            apiKey: "AIzaSyBNwSpbpNuQQ4nTjDAlB6izu5IgkEZxDL0",
            authDomain: "projetakip-e3a75.firebaseapp.com",
            projectId: "projetakip-e3a75",
            storageBucket: "projetakip-e3a75.firebasestorage.app",
            messagingSenderId: "924120275674",
            appId: "1:924120275674:web:c8ad3d4c998333d9fd23e3"
        };

        // Firebase'i başlat
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // URL'den proje ID'sini al
        const urlParams = new URLSearchParams(window.location.search);
        const projectId = urlParams.get('id');

        // DOM elementleri
        const projectNameHeader = document.getElementById('projectNameHeader');
        const projectSummaryName = document.getElementById('projectSummaryName');
        const projectSummaryCode = document.getElementById('projectSummaryCode');
        const projectSummaryStartDate = document.getElementById('projectSummaryStartDate');
        const projectSummaryEndDate = document.getElementById('projectSummaryEndDate');
        const projectSummaryContractAmount = document.getElementById('projectSummaryContractAmount');
        const projectSummaryDescription = document.getElementById('projectSummaryDescription');
        const projectTotalExpenses = document.getElementById('projectTotalExpenses');
        const projectTotalCollections = document.getElementById('projectTotalCollections');
        const projectRemainingBalance = document.getElementById('projectRemainingBalance');

        const expenseListBody = document.getElementById('expenseListBody');
        const collectionListBody = document.getElementById('collectionListBody');
        const deleteProjectButton = document.getElementById('deleteProjectButton');

        // Modallar ve formlar
        const updateProjectModal = document.getElementById('updateProjectModal');
        const updateProjectForm = document.getElementById('updateProjectForm');
        const updateProjectNameInput = document.getElementById('updateProjectName');
        const updateProjectCodeInput = document.getElementById('updateProjectCode');
        const updateStartDateInput = document.getElementById('updateStartDate');
        const updateEndDateInput = document.getElementById('updateEndDate');
        // Sözleşme bedeli ile ilgili yeni ve güncellenmiş DOM elementleri
        const updateContractAmountInput = document.getElementById('updateContractAmount');
        const updateContractCurrencySelect = document.getElementById('updateContractCurrency');
        const updateContractExchangeRateInput = document.getElementById('updateContractExchangeRate');
        const updateContractExchangeRateGroup = document.getElementById('updateContractExchangeRateGroup');
        const displayContractAmountTLInput = document.getElementById('displayContractAmountTL');
        const fetchContractRateButton = document.getElementById('fetchContractRateButton');
        const updateDescriptionInput = document.getElementById('updateDescription');

        const addExpenseModal = document.getElementById('addExpenseModal');
        const addExpenseForm = document.getElementById('addExpenseForm');
        const expenseDateInput = document.getElementById('expenseDate');
        const expenseDescriptionInput = document.getElementById('expenseDescription');
        const expenseAmountInput = document.getElementById('expenseAmount');
        const expenseCurrencySelect = document.getElementById('expenseCurrency');
        const expenseExchangeRateInput = document.getElementById('expenseExchangeRate'); // Manuel değiştirilebilir
        const expenseExchangeRateGroup = document.getElementById('expenseExchangeRateGroup');
        const fetchExpenseRateButton = document.getElementById('fetchExpenseRateButton');
        const expenseTypeSelect = document.getElementById('expenseType'); // Yeni harcama tipi

        const addCollectionModal = document.getElementById('addCollectionModal');
        const addCollectionForm = document.getElementById('addCollectionForm');
        const collectionDateInput = document.getElementById('collectionDate');
        const collectionDescriptionInput = document.getElementById('collectionDescription');
        const collectionAmountInput = document.getElementById('collectionAmount');
        const collectionCurrencySelect = document.getElementById('collectionCurrency');
        const collectionExchangeRateInput = document.getElementById('collectionExchangeRate'); // Manuel değiştirilebilir
        const collectionExchangeRateGroup = document.getElementById('collectionExchangeRateGroup');
        const fetchCollectionRateButton = document.getElementById('fetchCollectionRateButton');
        const collectionTypeSelect = document.getElementById('collectionType');
        const checkDetailsDiv = document.getElementById('checkDetailsDiv');
        const checkDateInput = document.getElementById('checkDate');
        const checkNoInput = document.getElementById('checkNo');
        const bankNameInput = document.getElementById('bankName');
        const barterDetailsDiv = document.getElementById('barterDetailsDiv');
        const barterDescriptionInput = document.getElementById('barterDescription');

        let currentProjectData = null; // Mevcut proje verilerini saklamak için

        // Modalları açma/kapama fonksiyonları
        function openUpdateProjectModal() {
            if (currentProjectData) {
                updateProjectNameInput.value = currentProjectData.name || '';
                updateProjectCodeInput.value = currentProjectData.code || '';
                updateStartDateInput.value = currentProjectData.startDate || '';
                updateEndDateInput.value = currentProjectData.endDate || '';
                updateContractAmountInput.value = currentProjectData.contractAmount || 0;
                updateContractCurrencySelect.value = currentProjectData.contractCurrency || 'TRY';
                updateContractExchangeRateInput.value = currentProjectData.contractExchangeRate || 1;
                updateDescriptionInput.value = currentProjectData.description || '';

                // Contract amount TL display calculation
                calculateAndDisplayContractAmountTL();
                toggleContractExchangeRateVisibility(); // Initial visibility based on loaded data
            }
            updateProjectModal.style.display = 'block';
        }

        function closeUpdateProjectModal() {
            updateProjectModal.style.display = 'none';
        }

        function openAddExpenseModal() {
            // Formu sıfırla ve varsayılanları ayarla
            addExpenseForm.reset();
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            expenseDateInput.value = `${year}-${month}-${day}`;
            expenseCurrencySelect.value = 'TRY';
            expenseExchangeRateInput.value = 1;
            expenseExchangeRateGroup.style.display = 'none'; // Varsayılan olarak TL seçili olduğu için gizle
            expenseTypeSelect.value = 'Nakit'; // Harcama tipi varsayılanı
            addExpenseModal.style.display = 'block';
        }

        function closeAddExpenseModal() {
            addExpenseModal.style.display = 'none';
        }

        function openAddCollectionModal() {
            // Formu sıfırla ve varsayılanları ayarla
            addCollectionForm.reset();
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            collectionDateInput.value = `${year}-${month}-${day}`;
            collectionCurrencySelect.value = 'TRY';
            collectionExchangeRateInput.value = 1;
            collectionExchangeRateGroup.style.display = 'none'; // Varsayılan olarak TL seçili olduğu için gizle
            collectionTypeSelect.value = 'Nakit'; // Varsayılan tipi ayarla
            checkDetailsDiv.style.display = 'none'; // Gizle
            barterDetailsDiv.style.display = 'none'; // Gizle
            addCollectionModal.style.display = 'block';
        }

        function closeAddCollectionModal() {
            addCollectionModal.style.display = 'none';
        }

        // Proje detaylarını yükle
        async function loadProjectDetails() {
            if (!projectId) {
                console.error("Proje ID bulunamadı.");
                window.location.href = 'index.html';
                return;
            }

            try {
                const projectDoc = await db.collection('projects').doc(projectId).get();
                if (projectDoc.exists) {
                    currentProjectData = projectDoc.data();
                    document.title = currentProjectData.name || 'Proje Detayları';
                    projectNameHeader.textContent = currentProjectData.name || 'Proje Detayları';
                    projectSummaryName.textContent = currentProjectData.name || 'N/A';
                    projectSummaryCode.textContent = currentProjectData.code || 'N/A';
                    projectSummaryStartDate.textContent = currentProjectData.startDate || 'N/A';
                    projectSummaryEndDate.textContent = currentProjectData.endDate || 'N/A';
                    projectSummaryDescription.textContent = currentProjectData.description || 'N/A';

                    // Sözleşme Bedeli gösterimi
                    const contractAmount = currentProjectData.contractAmount || 0;
                    const contractCurrency = currentProjectData.contractCurrency || 'TRY';
                    const contractExchangeRate = currentProjectData.contractExchangeRate || 1;
                    const contractAmountTL = currentProjectData.contractAmountTL || contractAmount; // Firestore'dan TL karşılığını al

                    if (contractCurrency === 'TRY') {
                        projectSummaryContractAmount.textContent = `${contractAmount.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY', minimumFractionDigits: 2 })}`;
                    } else {
                        projectSummaryContractAmount.textContent = `${contractAmount.toLocaleString('tr-TR', { style: 'currency', currency: contractCurrency, minimumFractionDigits: 2 })} (${contractAmountTL.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY', minimumFractionDigits: 2 })})`;
                    }

                    loadFinancialData(); // Harcama ve tahsilatları yükle
                } else {
                    alert("Proje bulunamadı!");
                    window.location.href = 'index.html';
                }
            } catch (error) {
                console.error("Proje detayları yüklenirken hata oluştu: ", error);
                alert("Proje detayları yüklenirken bir hata oluştu.");
            }
        }

        // Harcama ve tahsilat verilerini yükle
        async function loadFinancialData() {
            if (!projectId) return;

            try {
                const expensesSnapshot = await db.collection('projects').doc(projectId).collection('expenses').orderBy('date', 'desc').get();
                const collectionsSnapshot = await db.collection('projects').doc(projectId).collection('collections').orderBy('date', 'desc').get();

                let totalExpenses = 0;
                let totalCollections = 0;

                expenseListBody.innerHTML = ''; // Eski harcamaları temizle
                expensesSnapshot.forEach(doc => {
                    const expense = doc.data();
                    const expenseId = doc.id;
                    const expenseAmountTL = (expense.amount * expense.exchangeRate) || 0;
                    totalExpenses += expenseAmountTL;

                    const row = expenseListBody.insertRow();
                    row.insertCell(0).textContent = expense.date;
                    row.insertCell(1).textContent = expense.description;
                    row.insertCell(2).textContent = expense.amount.toLocaleString('tr-TR', { minimumFractionDigits: 2 });
                    row.insertCell(3).textContent = expense.currency;
                    row.insertCell(4).textContent = expense.exchangeRate.toLocaleString('tr-TR', { minimumFractionDigits: 4 });
                    row.insertCell(5).textContent = expenseAmountTL.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY', minimumFractionDigits: 2 });
                    row.insertCell(6).textContent = expense.expenseType || 'N/A'; // Harcama tipi
                    
                    const actionsCell = row.insertCell(7);
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Sil';
                    deleteButton.className = 'delete-button';
                    deleteButton.onclick = () => deleteExpense(expenseId);
                    actionsCell.appendChild(deleteButton);
                });

                collectionListBody.innerHTML = ''; // Eski tahsilatları temizle
                collectionsSnapshot.forEach(doc => {
                    const collection = doc.data();
                    const collectionId = doc.id;
                    const collectionAmountTL = (collection.amount * collection.exchangeRate) || 0;
                    totalCollections += collectionAmountTL;

                    const row = collectionListBody.insertRow();
                    row.insertCell(0).textContent = collection.date;
                    row.insertCell(1).textContent = collection.description;
                    row.insertCell(2).textContent = collection.amount.toLocaleString('tr-TR', { minimumFractionDigits: 2 });
                    row.insertCell(3).textContent = collection.currency;
                    row.insertCell(4).textContent = collection.exchangeRate.toLocaleString('tr-TR', { minimumFractionDigits: 4 });
                    row.insertCell(5).textContent = collectionAmountTL.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY', minimumFractionDigits: 2 });
                    row.insertCell(6).textContent = collection.collectionType || 'N/A'; // Tahsilat tipi
                    
                    const actionsCell = row.insertCell(7);
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Sil';
                    deleteButton.className = 'delete-button';
                    deleteButton.onclick = () => deleteCollection(collectionId);
                    actionsCell.appendChild(deleteButton);
                });

                // Özet bilgilerini güncelle
                projectTotalExpenses.textContent = totalExpenses.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY', minimumFractionDigits: 2 });
                projectTotalCollections.textContent = totalCollections.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY', minimumFractionDigits: 2 });

                const contractAmountTLValue = currentProjectData ? (currentProjectData.contractAmountTL || 0) : 0;
                const remainingBalance = contractAmountTLValue - totalExpenses + totalCollections;
                projectRemainingBalance.textContent = remainingBalance.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY', minimumFractionDigits: 2 });

            } catch (error) {
                console.error("Finansal veriler yüklenirken hata oluştu: ", error);
                alert("Finansal veriler yüklenirken bir hata oluştu.");
            }
        }

        // Proje güncelleme formu submit
        updateProjectForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!projectId) return;

            const newName = updateProjectNameInput.value;
            const newCode = updateProjectCodeInput.value;
            const newStartDate = updateStartDateInput.value;
            const newEndDate = updateEndDateInput.value;
            const newContractAmount = parseFloat(updateContractAmountInput.value);
            const newContractCurrency = updateContractCurrencySelect.value;
            const newContractExchangeRate = parseFloat(updateContractExchangeRateInput.value);
            const newDescription = updateDescriptionInput.value;

            let newContractAmountTL = newContractAmount;
            if (newContractCurrency !== 'TRY') {
                newContractAmountTL = newContractAmount * newContractExchangeRate;
            }

            try {
                await db.collection('projects').doc(projectId).update({
                    name: newName,
                    code: newCode,
                    startDate: newStartDate,
                    endDate: newEndDate,
                    contractAmount: newContractAmount,
                    contractCurrency: newContractCurrency,
                    contractExchangeRate: newContractExchangeRate,
                    contractAmountTL: newContractAmountTL, // TL karşılığını kaydet
                    description: newDescription
                });
                alert("Proje bilgileri başarıyla güncellendi!");
                closeUpdateProjectModal();
                loadProjectDetails(); // Güncel verileri tekrar yükle
            } catch (error) {
                console.error("Proje güncellenirken hata oluştu: ", error);
                alert("Proje güncellenirken bir hata oluştu.");
            }
        });

        // Harcama ekleme formu submit
        addExpenseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!projectId) return;

            const expenseDate = expenseDateInput.value;
            const expenseDescription = expenseDescriptionInput.value;
            const expenseAmount = parseFloat(expenseAmountInput.value);
            const expenseCurrency = expenseCurrencySelect.value;
            const expenseExchangeRate = parseFloat(expenseExchangeRateInput.value);
            const expenseType = expenseTypeSelect.value; // Yeni harcama tipi

            try {
                await db.collection('projects').doc(projectId).collection('expenses').add({
                    date: expenseDate,
                    description: expenseDescription,
                    amount: expenseAmount,
                    currency: expenseCurrency,
                    exchangeRate: expenseExchangeRate,
                    expenseType: expenseType, // Harcama tipi
                    timestamp: firebase.firestore.FieldValue.serverTimestamp() // Sıralama için
                });
                alert("Harcama başarıyla eklendi!");
                closeAddExpenseModal();
                loadFinancialData(); // Finansal verileri tekrar yükle
            } catch (error) {
                console.error("Harcama eklenirken hata oluştu: ", error);
                alert("Harcama eklenirken bir hata oluştu.");
            }
        });

        // Tahsilat ekleme formu submit
        addCollectionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!projectId) return;

            const collectionDate = collectionDateInput.value;
            const collectionDescription = collectionDescriptionInput.value;
            const collectionAmount = parseFloat(collectionAmountInput.value);
            const collectionCurrency = collectionCurrencySelect.value;
            const collectionExchangeRate = parseFloat(collectionExchangeRateInput.value);
            const collectionType = collectionTypeSelect.value;

            let collectionData = {
                date: collectionDate,
                description: collectionDescription,
                amount: collectionAmount,
                currency: collectionCurrency,
                exchangeRate: collectionExchangeRate,
                collectionType: collectionType,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            // Tahsilat tipine göre ek bilgiler
            if (collectionType === 'Çek') {
                collectionData.checkDetails = {
                    checkDate: checkDateInput.value,
                    checkNo: checkNoInput.value,
                    bankName: bankNameInput.value
                };
            } else if (collectionType === 'Barter') {
                collectionData.barterDetails = {
                    barterDescription: barterDescriptionInput.value
                };
            }

            try {
                await db.collection('projects').doc(projectId).collection('collections').add(collectionData);
                alert("Tahsilat başarıyla eklendi!");
                closeAddCollectionModal();
                loadFinancialData();
            } catch (error) {
                console.error("Tahsilat eklenirken hata oluştu: ", error);
                alert("Tahsilat eklenirken bir hata oluştu.");
            }
        });

        // Harcama silme
        async function deleteExpense(expenseId) {
            if (!confirm("Bu harcamayı silmek istediğinizden emin misiniz?")) {
                return;
            }
            try {
                await db.collection('projects').doc(projectId).collection('expenses').doc(expenseId).delete();
                alert("Harcama başarıyla silindi!");
                loadFinancialData();
            } catch (error) {
                console.error("Harcama silinirken hata oluştu: ", error);
                alert("Harcama silinirken bir hata oluştu.");
            }
        }

        // Tahsilat silme
        async function deleteCollection(collectionId) {
            if (!confirm("Bu tahsilatı silmek istediğinizden emin misiniz?")) {
                return;
            }
            try {
                await db.collection('projects').doc(projectId).collection('collections').doc(collectionId).delete();
                alert("Tahsilat başarıyla silindi!");
                loadFinancialData();
            } catch (error) {
                console.error("Tahsilat silinirken hata oluştu: ", error);
                alert("Tahsilat silinirken bir hata oluştu.");
            }
        }

        // Proje silme
        deleteProjectButton.addEventListener('click', async () => {
            if (!confirm("Bu projeyi ve tüm finansal verilerini kalıcı olarak silmek istediğinizden emin misiniz? Bu işlem geri alınamaz!")) {
                return;
            }

            if (!projectId) {
                alert("Proje ID bulunamadı.");
                return;
            }

            try {
                // Önce alt koleksiyonları sil (Firestore'da otomatik silme yok)
                const deleteSubcollections = async (collectionRef) => {
                    const snapshot = await collectionRef.get();
                    const batch = db.batch();
                    snapshot.docs.forEach(doc => {
                        batch.delete(doc.ref);
                    });
                    await batch.commit();
                };

                await deleteSubcollections(db.collection('projects').doc(projectId).collection('expenses'));
                await deleteSubcollections(db.collection('projects').doc(projectId).collection('collections'));

                // Ana projeyi sil
                await db.collection('projects').doc(projectId).delete();

                alert("Proje başarıyla silindi!");
                window.location.href = 'index.html'; // Proje listesine geri dön
            } catch (error) {
                console.error("Proje silinirken hata oluştu: ", error);
                alert("Proje silinirken bir hata oluştu.");
            }
        });

        // TCMB'den kur bilgilerini çekme fonksiyonu
        async function fetchTCMBRates(dateString) {
            // TCMB API'sinden kur çekmek için genellikle bir backend proxy'si veya
            // CORS destekli bir harici servis kullanılır. Doğrudan tarayıcıdan
            // TCMB'nin XML servislerini çekmek CORS kısıtlamaları nedeniyle sorunlu olabilir.
            // Bu örnekte, halka açık ve CORS dostu bir döviz kuru API'si kullanacağız.
            // Örneğin: ExchangeRate-API (ücretsiz plan için aylık 1500 istek limiti vardır)
            // Lütfen kendi API anahtarınızı (Eğer ExchangeRate-API kullanacaksanız) buraya ekleyin:
            const EXCHANGE_RATE_API_KEY = 'YOUR_EXCHANGERATE_API_KEY_HERE'; // Eğer kullanacaksanız burayı doldurun

            try {
                const response = await fetch(`https://api.exchangerate-api.com/v4/latest/TRY?apikey=${EXCHANGE_RATE_API_KEY}`);
                const data = await response.json();
                if (data && data.rates) {
                    return {
                        USD: data.rates.USD,
                        EUR: data.rates.EUR
                    };
                }
            } catch (error) {
                console.error("Kur bilgileri çekilirken hata oluştu: ", error);
                alert("Güncel kur bilgileri çekilemedi. Lütfen kuru manuel girin.");
            }
            return null;
        }

        // Sözleşme bedeli için kur hesaplama ve gösterme
        function calculateAndDisplayContractAmountTL() {
            const amount = parseFloat(updateContractAmountInput.value) || 0;
            const currency = updateContractCurrencySelect.value;
            const exchangeRate = parseFloat(updateContractExchangeRateInput.value) || 1;
            
            let amountTL = amount;
            if (currency !== 'TRY') {
                amountTL = amount * exchangeRate;
            }
            displayContractAmountTLInput.value = amountTL.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY', minimumFractionDigits: 2 });
        }

        // Kur alanının görünürlüğünü kontrol eden fonksiyon (Sözleşme Bedeli için)
        function toggleContractExchangeRateVisibility() {
            if (updateContractCurrencySelect.value === 'TRY') {
                updateContractExchangeRateGroup.style.display = 'none';
                updateContractExchangeRateInput.value = 1; // TL ise kur 1'dir
            } else {
                updateContractExchangeRateGroup.style.display = 'block';
                // Eğer farklı bir para birimi seçildiyse, otomatik kur çekme denemesi yapılabilir
                // Ancak burada, kullanıcı manuel olarak değiştirebilme isteği olduğu için
                // varolan değeri koruyup "Güncel Kuru Çek" butonunu bırakıyoruz.
            }
            calculateAndDisplayContractAmountTL(); // Görünürlük değiştiğinde TL karşılığını da güncelle
        }

        // Kur alanının görünürlüğünü kontrol eden fonksiyon (Harcama için)
        function toggleExpenseExchangeRateVisibility() {
            if (expenseCurrencySelect.value === 'TRY') {
                expenseExchangeRateGroup.style.display = 'none';
                expenseExchangeRateInput.value = 1; // TL ise kur 1'dir
            } else {
                expenseExchangeRateGroup.style.display = 'block';
            }
        }

        // Kur alanının görünürlüğünü kontrol eden fonksiyon (Tahsilat için)
        function toggleCollectionExchangeRateVisibility() {
            if (collectionCurrencySelect.value === 'TRY') {
                collectionExchangeRateGroup.style.display = 'none';
                collectionExchangeRateInput.value = 1; // TL ise kur 1'dir
            } else {
                collectionExchangeRateGroup.style.display = 'block';
            }
        }

        // Sözleşme bedeli döviz kuru olay dinleyicileri
        updateContractCurrencySelect.addEventListener('change', toggleContractExchangeRateVisibility);
        updateContractAmountInput.addEventListener('input', calculateAndDisplayContractAmountTL);
        updateContractExchangeRateInput.addEventListener('input', calculateAndDisplayContractAmountTL);

        fetchContractRateButton.addEventListener('click', async () => {
            const currency = updateContractCurrencySelect.value;
            if (currency === 'TRY') {
                alert("TL için kur çekmenize gerek yoktur. Kur değeri 1'dir.");
                return;
            }
            const rates = await fetchTCMBRates(new Date().toISOString().slice(0, 10)); // Bugünün tarihi
            if (rates && rates[currency]) {
                updateContractExchangeRateInput.value = rates[currency].toFixed(4);
                calculateAndDisplayContractAmountTL();
            }
        });

        // Harcama döviz kuru olay dinleyicileri
        expenseCurrencySelect.addEventListener('change', toggleExpenseExchangeRateVisibility);
        fetchExpenseRateButton.addEventListener('click', async () => {
            const currency = expenseCurrencySelect.value;
            if (currency === 'TRY') {
                alert("TL için kur çekmenize gerek yoktur. Kur değeri 1'dir.");
                return;
            }
            const date = expenseDateInput.value;
            if (!date) {
                alert("Kur çekmek için önce bir tarih seçmelisiniz.");
                return;
            }
            const rates = await fetchTCMBRates(date);
            if (rates && rates[currency]) {
                expenseExchangeRateInput.value = rates[currency].toFixed(4);
            }
        });

        // Tahsilat döviz kuru olay dinleyicileri
        collectionCurrencySelect.addEventListener('change', toggleCollectionExchangeRateVisibility);
        fetchCollectionRateButton.addEventListener('click', async () => {
            const currency = collectionCurrencySelect.value;
            if (currency === 'TRY') {
                alert("TL için kur çekmenize gerek yoktur. Kur değeri 1'dir.");
                return;
            }
            const date = collectionDateInput.value;
            if (!date) {
                alert("Kur çekmek için önce bir tarih seçmelisiniz.");
                return;
            }
            const rates = await fetchTCMBRates(date);
            if (rates && rates[currency]) {
                collectionExchangeRateInput.value = rates[currency].toFixed(4);
            }
        });

        // Tahsilat Tipi değişikliklerini izle
        collectionTypeSelect.addEventListener('change', () => {
            checkDetailsDiv.style.display = 'none';
            barterDetailsDiv.style.display = 'none';
            if (collectionTypeSelect.value === 'Çek') {
                checkDetailsDiv.style.display = 'block';
            } else if (collectionTypeSelect.value === 'Barter') {
                barterDetailsDiv.style.display = 'block';
            }
        });

        // Sayfa yüklendiğinde
        document.addEventListener('DOMContentLoaded', () => {
            loadProjectDetails();

            // Form yüklendiğinde bugünün tarihini ve varsayılan para birimi ayarlarını yap
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            const formattedDate = `${year}-${month}-${day}`;

            expenseDateInput.value = formattedDate;
            collectionDateInput.value = formattedDate;
            
            // Harcama ve Tahsilat kur alanlarının başlangıç görünürlüğünü ayarla
            toggleExpenseExchangeRateVisibility();
            toggleCollectionExchangeRateVisibility();

            // Tahsilat tipi varsayılanına göre ilgili div'leri göster/gizle
            collectionTypeSelect.dispatchEvent(new Event('change')); // Başlangıçta tipi kontrol et
        });

    </script>
</body>
</html>
